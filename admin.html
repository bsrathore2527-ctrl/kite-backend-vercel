<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Admin Panel</title>
</head>

<body class="bg-gray-100 min-h-screen p-6" onload="initAdmin()">

<header class="flex justify-between items-center mb-6">
  <h1 class="text-3xl font-bold text-gray-900">Admin Panel</h1>
  <button onclick="clearAdminToken()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
    Logout
  </button>
</header>

<div class="bg-white p-6 rounded-xl shadow-md border mb-6">
  <h2 class="text-xl font-semibold mb-2">Master Zerodha Status</h2>
  <p id="masterStatus" class="text-gray-700">Checking...</p>
  <button onclick="masterLogin()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
    Login Master Zerodha
  </button>
</div>

<div class="bg-white p-6 rounded-xl shadow-md border mb-6">
  <h2 class="text-xl font-semibold mb-4">Add New User</h2>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <input id="newUserId" placeholder="Zerodha User ID" class="p-3 border rounded-lg" />
    <input id="newUserValidity" type="number" placeholder="Validity Days" class="p-3 border rounded-lg" />
    <button onclick="addUser()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
      Add User
    </button>
  </div>
</div>

<div class="bg-white p-6 rounded-xl shadow-md border">
  <h2 class="text-xl font-semibold mb-4">Users</h2>
  <table class="w-full border-collapse">
    <thead>
      <tr class="bg-gray-200 text-left">
        <th class="p-2">User ID</th>
        <th class="p-2">Active</th>
        <th class="p-2">Valid Until</th>
        <th class="p-2">Actions</th>
      </tr>
    </thead>
    <tbody id="usersTable"></tbody>
  </table>
</div>

<script>
/* ==========================================================
   Admin Token Handler
========================================================== */
async function getAdminToken() {
  let token = localStorage.getItem("admin-token");

  if (!token) {
    token = prompt("Enter Admin Token:");
    if (!token) {
      alert("Admin token required.");
      return null;
    }
    token = token.trim();
    localStorage.setItem("admin-token", token);
  }

  return token;
}

function clearAdminToken() {
  localStorage.removeItem("admin-token");
  alert("Logged out!");
  location.reload();
}

/* ==========================================================
   Init
========================================================== */
async function initAdmin() {
  await loadMasterStatus();
  await loadUsers();
}

/* ==========================================================
   Master Login
========================================================== */
async function masterLogin() {
  const token = await getAdminToken();
  if (!token) return;

  window.location.href = `/api/admin/master-login?token=${token}`;
}

/* ==========================================================
   Load Master Status
========================================================== */
async function loadMasterStatus() {
  const token = await getAdminToken();
  if (!token) return;

  const res = await fetch("/api/admin/master-status", {
    headers: { "x-admin-token": token }
  });

  const data = await res.json();
  document.getElementById("masterStatus").innerText = data.status || "Unknown";
}

/* ==========================================================
   Add User
========================================================== */
async function addUser() {
  const token = await getAdminToken();
  if (!token) return;

  const user_id = document.getElementById('newUserId').value.trim();
  const days = Number(document.getElementById('newUserValidity').value.trim());

  if (!user_id || !days) {
    alert("Enter both User ID & Validity Days.");
    return;
  }

  const res = await fetch("/api/admin/addUser", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-token": token
    },
    body: JSON.stringify({
      user_id,
      valid_until: Date.now() + (days * 86400000)
    })
  });

  const data = await res.json();
  if (!data.ok) {
    alert("Error: " + data.error);
    return;
  }

  loadUsers();
}

/* ==========================================================
   Load Users
========================================================== */
async function loadUsers() {
  const token = await getAdminToken();
  if (!token) return;

  const res = await fetch("/api/admin/listUsers", {
    headers: { "x-admin-token": token }
  });

  const data = await res.json();
  const tbody = document.getElementById("usersTable");
  tbody.innerHTML = "";

  if (!data.users || data.users.length === 0) {
    tbody.innerHTML = `<tr><td colspan='4' class='p-3 text-center text-gray-500'>No Users Found</td></tr>`;
    return;
  }

  data.users.forEach(u => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class='p-2'>${u.id}</td>
      <td class='p-2'>${u.profile?.active ? "Yes" : "No"}</td>
      <td class='p-2'>${u.profile?.valid_until ? new Date(u.profile.valid_until).toLocaleDateString() : "-"}</td>
      <td class='p-2 space-x-2'>
        <button onclick="extendValidity('${u.id}')" class='px-3 py-1 bg-blue-600 text-white rounded'>Extend</button>
        <button onclick="resetTrip('${u.id}')" class='px-3 py-1 bg-orange-600 text-white rounded'>Reset</button>
        <button onclick="deleteUser('${u.id}')" class='px-3 py-1 bg-red-600 text-white rounded'>Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ==========================================================
   Extend Validity
========================================================== */
async function extendValidity(user_id) {
  const token = await getAdminToken();
  if (!token) return;

  const days = prompt("Add days:");
  if (!days) return;

  await fetch("/api/admin/extendValidity", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-admin-token": token },
    body: JSON.stringify({ user_id, days: Number(days) })
  });

  loadUsers();
}

/* ==========================================================
   Reset Trip
========================================================== */
async function resetTrip(user_id) {
  const token = await getAdminToken();
  if (!token) return;

  await fetch("/api/admin/resetTrip", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-admin-token": token },
    body: JSON.stringify({ user_id })
  });

  alert("Trip reset!");
}

/* ==========================================================
   Delete User
========================================================== */
async function deleteUser(user_id) {
  const token = await getAdminToken();
  if (!token) return;

  if (!confirm("Delete this user?")) return;

  await fetch("/api/admin/deleteUser", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-admin-token": token },
    body: JSON.stringify({ user_id })
  });

  loadUsers();
}
</script>

</body>
</html>
