<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guardian — Admin</title>
<style>
  :root{
    --bg:#071025; --card:#0e1724; --muted:#9aa6b2; --accent:#2b7ef6;
    --accent-2:#20c997; --danger:#e05151; --glass: rgba(255,255,255,0.03);
    font-family: Inter, system-ui, Arial, sans-serif;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#041021, #071025 60%);color:#e6f0ff}
  .wrap{max-width:980px;margin:22px auto;padding:18px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
  header h1{margin:0;font-size:20px}
  .badges{margin-left:auto;display:flex;gap:10px;align-items:center}
  .badge{padding:8px 12px;border-radius:999px;background:var(--glass);color:var(--muted);font-size:13px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
  .row{display:flex;gap:12px;align-items:center}
  .row .col{flex:1}
  input[type=text]{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
  button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:white;font-weight:600;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .btn-danger{background:var(--danger)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .status{font-size:13px;color:var(--muted);margin-top:8px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
  .metric{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
  .muted{color:var(--muted);font-size:13px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;padding:12px 18px;border-radius:8px;background:#111;color:#fff;box-shadow:0 8px 20px rgba(0,0,0,0.6)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Guardian — Admin</h1>
    <div class="badges">
      <div id="kiteStatus" class="badge">Kite: —</div>
      <div id="guardianStatus" class="badge">Guardian: —</div>
      <div id="clock" class="badge">--:--:--</div>
    </div>
  </header>

  <section class="card">
    <div style="display:flex;gap:12px;align-items:center">
      <input id="adminToken" type="text" placeholder="Paste ADMIN_TOKEN here (stored locally)"/>
      <button id="saveBtn" class="">Save</button>
      <button id="loginBtn" class="btn-ghost">Login Zerodha</button>
      <button id="clearBtn" class="btn-ghost">Clear</button>
    </div>

    <div class="controls">
      <button id="acquireBtn">Acquire Lock</button>
      <button id="releaseBtn" class="btn-ghost">Release Lock</button>
      <button id="snapshotBtn" class="btn-ghost">Take 08:30 Snapshot</button>
      <button id="enforceBtn" style="background:linear-gradient(90deg,#20c997,#2b7ef6)">Enforce Now</button>
      <button id="resetConsecBtn" class="btn-ghost">Reset Consecutive</button>
      <button id="killBtn" class="btn-danger">Kill (Close)</button>
      <button id="cancelAllBtn" class="btn-ghost">Cancel All</button>
      <label style="display:flex;align-items:center;gap:8px;margin-left:8px">
        <input id="allowNew" type="checkbox"/> Allow New Orders
      </label>
    </div>

    <div id="actionStatus" class="status muted">Ready.</div>
  </section>

  <section class="card">
    <div class="grid">
      <div class="metric">
        <div class="muted">Capital @ 09:15</div>
        <div id="capital" style="font-size:22px;font-weight:700">—</div>
      </div>
      <div class="metric">
        <div class="muted">Live Balance (broker)</div>
        <div id="liveBalance" style="font-size:22px;font-weight:700">—</div>
        <div class="muted" id="balanceNote">—</div>
      </div>
      <div class="metric">
        <div class="muted">Live MTM</div>
        <div id="liveMtm" style="font-size:22px;font-weight:700">—</div>
      </div>
      <div class="metric">
        <div class="muted">Day Trip</div>
        <div id="dayTrip" style="font-size:22px;font-weight:700">—</div>
      </div>
    </div>
  </section>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
/* ---------- Utilities ---------- */
const apiRoot = location.origin;
const LS_KEY = "guardian_admin_token";

function toast(msg, ms=3500) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=> t.style.display="none", ms);
}

function setStatus(text, isError=false) {
  const el = document.getElementById("actionStatus");
  el.textContent = text;
  el.style.color = isError ? "#f88" : "";
}

/* fetch that retries GET/POST fallback on 405 */
async function fetchWithFallback(url, opts={}) {
  // default method
  opts.method = (opts.method || "GET").toUpperCase();
  try {
    const res = await fetch(url, opts);
    if (res.status === 405) {
      // try fallback method (swap GET <-> POST)
      const fallback = (opts.method === "GET") ? "POST" : "GET";
      const newOpts = {...opts, method: fallback};
      // if GET, delete body
      if (fallback === "GET") delete newOpts.body;
      const r2 = await fetch(url, newOpts);
      return r2;
    }
    return res;
  } catch(e){
    throw e;
  }
}

/* add Authorization header if token stored */
function authHeaders() {
  const token = localStorage.getItem(LS_KEY) || "";
  return token ? { "Authorization": "Bearer " + token } : {};
}

/* convenience: call API and parse JSON */
async function callApi(path, {method="GET", body=null}={}) {
  const url = apiRoot + path;
  const headers = {...authHeaders()};
  if (body !== null) {
    headers["Content-Type"] = "application/json";
  }
  const opts = {method, headers};
  if (body !== null) opts.body = JSON.stringify(body);
  const res = await fetchWithFallback(url, opts);
  const text = await res.text();
  try {
    return { ok: res.ok, status: res.status, json: JSON.parse(text), text };
  } catch(e) {
    return { ok: res.ok, status: res.status, json: null, text };
  }
}

/* ---------- UI actions ---------- */
async function saveToken() {
  const v = document.getElementById("adminToken").value.trim();
  if (!v) { toast("Empty token not saved"); return; }
  localStorage.setItem(LS_KEY, v);
  toast("Admin token saved (local)");
  loadState(); // reload with auth
}

function clearToken() {
  localStorage.removeItem(LS_KEY);
  document.getElementById("adminToken").value = "";
  toast("Admin token cleared");
  loadState();
}

async function loginZerodha() {
  setStatus("Logging into Zerodha...");
  try {
    const r = await callApi("/api/kite/login", { method: "GET" });
    if (r.json) {
      setStatus("Login response: " + (r.json.ok ? "ok" : JSON.stringify(r.json)));
      toast("Zerodha login returned: " + (r.json.ok ? "ok" : r.text));
      // if the login endpoint returns a redirect url, open it:
      if (r.json && r.json.redirect) window.open(r.json.redirect, "_blank");
    } else {
      setStatus("Login failed: " + r.text, true);
      toast("Zerodha login failed");
    }
  } catch (e) {
    setStatus("Login error", true);
    toast("Error: " + (e.message || e));
  }
}

async function acquireLock() {
  setStatus("Acquiring lock...");
  const r = await callApi("/api/admin/lock", { method: "POST", body: {} });
  if (r.ok) {
    setStatus("Lock acquired");
    toast("Lock acquired");
    loadState();
  } else {
    setStatus("Acquire failed: " + (r.text || r.status), true);
    toast("Acquire failed: " + (r.text || r.status));
  }
}
async function releaseLock() {
  setStatus("Releasing lock...");
  const r = await callApi("/api/admin/release", { method: "POST", body: {} });
  if (r.ok) {
    setStatus("Lock released");
    toast("Lock released");
    loadState();
  } else {
    setStatus("Release failed: " + (r.text || r.status), true);
    toast("Release failed: " + (r.text || r.status));
  }
}
async function enforceNow() {
  setStatus("Enforce now...");
  const r = await callApi("/api/admin/enforce", { method: "POST", body: {} });
  if (r.ok) { setStatus("Enforce started"); toast("Enforce started"); loadState(); }
  else { setStatus("Enforce failed: " + (r.text||r.status), true); toast("Enforce failed"); }
}
async function resetConsecutive() {
  setStatus("Reset consecutive losses...");
  const r = await callApi("/api/admin/reset-consecutive", { method: "POST", body: {} });
  if (r.ok) { setStatus("Reset done"); toast("Reset done"); loadState(); }
  else { setStatus("Reset failed", true); toast("Reset failed"); }
}
async function killSwitch() {
  if (!confirm("Kill switch: will attempt to close positions. Proceed?")) return;
  setStatus("Kill: closing positions...");
  const r = await callApi("/api/admin/kill", { method: "POST", body: {} });
  if (r.ok) { setStatus("Kill executed"); toast("Kill executed"); loadState(); }
  else { setStatus("Kill failed", true); toast("Kill failed: " + (r.text||r.status)); }
}
async function cancelAll() {
  if (!confirm("Cancel all orders?")) return;
  setStatus("Cancelling all...");
  const r = await callApi("/api/admin/cancel-all", { method: "POST", body: {} });
  if (r.ok) { setStatus("All cancelled"); toast("All cancelled"); loadState(); }
  else { setStatus("Cancel failed", true); toast("Cancel failed"); }
}
async function toggleAllowNew(allow) {
  setStatus((allow? "Allowing":"Blocking")+" new orders...");
  const r = await callApi("/api/admin/allow-new", { method: "POST", body: { allow }});
  if (r.ok) { setStatus("Updated allow-new"); toast("Updated"); loadState(); }
  else { setStatus("Update failed", true); toast("Update failed"); }
}

/* ---------- state & UI refresh ---------- */
function fmtINR(x){ return (typeof x !== "number" ? x : "₹" + Math.round(x)); }

async function loadState() {
  try {
    document.getElementById("kiteStatus").textContent = "Kite: ...";
    const r = await callApi("/api/state", { method: "GET" });
    if (!r.ok || !r.json) {
      setStatus("Failed to load state", true);
      document.getElementById("kiteStatus").textContent = "Kite: -";
      return;
    }
    const j = r.json;
    document.getElementById("guardianStatus").textContent = "Guardian: " + (j.admin ? "admin" : "online");
    document.getElementById("clock").textContent = j.time || "";
    // metrics (safe defaults)
    const s = j.state || {};
    document.getElementById("capital").textContent = fmtINR(s.capital_day_915 ?? 0);
    document.getElementById("dayTrip").textContent = (s.tripped_day ? "YES" : "NO");
    document.getElementById("liveMtm").textContent = fmtINR(s.unrealised ?? 0);
    // Live funds request
    const funds = await callApi("/api/kite/funds", { method: "GET" });
    if (funds.ok && funds.json) {
      const payload = funds.json;
      // choose best live balance fields
      let bal = payload.balance ?? (payload.funds && payload.funds.available && (payload.funds.available.live_balance ?? payload.funds.available.cash)) ?? (payload.funds && payload.funds.cash) ?? 0;
      document.getElementById("liveBalance").textContent = fmtINR(bal);
      document.getElementById("balanceNote").textContent = "live from broker";
      document.getElementById("kiteStatus").textContent = "Kite: connected";
    } else {
      // fallback to cached current_balance
      document.getElementById("liveBalance").textContent = fmtINR(s.current_balance ?? "—");
      document.getElementById("balanceNote").textContent = "uses cached if offline";
      if (funds.json && funds.json.error) document.getElementById("kiteStatus").textContent = "Kite: auth error";
      else document.getElementById("kiteStatus").textContent = "Kite: offline";
    }
    setStatus("State loaded");
  } catch (e) {
    setStatus("Failed to load state: " + (e.message || e), true);
  }
}

/* ---------- wiring ---------- */
document.getElementById("saveBtn").addEventListener("click", saveToken);
document.getElementById("clearBtn").addEventListener("click", clearToken);
document.getElementById("loginBtn").addEventListener("click", loginZerodha);
document.getElementById("acquireBtn").addEventListener("click", acquireLock);
document.getElementById("releaseBtn").addEventListener("click", releaseLock);
document.getElementById("enforceBtn").addEventListener("click", enforceNow);
document.getElementById("resetConsecBtn").addEventListener("click", resetConsecutive);
document.getElementById("killBtn").addEventListener("click", killSwitch);
document.getElementById("cancelAllBtn").addEventListener("click", cancelAll);
document.getElementById("allowNew").addEventListener("change", (e)=> toggleAllowNew(e.target.checked));

/* load saved token */
(function init() {
  const t = localStorage.getItem(LS_KEY);
  if (t) document.getElementById("adminToken").value = t;
  loadState();
  setInterval(loadState, 30*1000); // refresh every 30s
})();
</script>
</body>
</html>
