<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Guardian â€¢ Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      /* Palette */
      --bg: #0b0c10;
      --card: #12131a;
      --ink: #0d0f14;
      --line: #222432;
      --muted: #9aa3ad;
      --fg: #eef1f5;
      --accent: #3b82f6;      /* blue */
      --accent-2: #60a5fa;
      --accent-3: #93c5fd;
      --ok: #54d28a;
      --warn: #ffd166;
      --bad: #ff6b6b;

      /* Radius & Shadow */
      --r-lg: 14px;
      --r-md: 12px;
      --r-sm: 10px;
      --shadow: 0 8px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
      --shadow-soft: 0 6px 18px rgba(0,0,0,.25);

      /* Spacing */
      --pad: 16px;
      --gap: 14px;
    }

    /* Base */
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg, #0b0c10 0%, #0a0b10 100%);
      color:var(--fg);
      font-family: ui-rounded, system-ui, "SF Pro Rounded", "Segoe UI", Roboto, Ubuntu, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      letter-spacing:.1px;
    }
    .wrap{max-width:1000px;margin:0 auto;padding:28px}
    h1,h2,h3{margin:0 0 10px}
    .muted{color:var(--muted)}
    .tiny{font-size:12px}

    /* Header */
    .header{
      display:flex; align-items:center; gap:12px; margin-bottom:18px;
    }
    .title{
      display:flex; align-items:center; gap:10px;
      font-weight:700; font-size:20px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border:1px solid var(--line); border-radius:999px;
      background: linear-gradient(180deg, #12131a, #0f1117);
      box-shadow: var(--shadow-soft);
      font-size:12px; color:var(--muted);
    }
    .dot{width:8px; height:8px; border-radius:50%;}
    .b-ok   { color:var(--ok);   border-color: #1e3a2a; }
    .b-warn { color:var(--warn); border-color: #4a3a1a; }
    .b-bad  { color:var(--bad);  border-color: #4a1a1a; }
    .b-accent{ color:var(--accent-3); border-color:#1b2a4a; }

    /* Cards */
    .grid{
      display:grid; gap:var(--gap);
      grid-template-columns: repeat(12, minmax(0,1fr));
    }
    .card{
      grid-column: span 12 / span 12;
      background:linear-gradient(180deg, #0f1117, #0d0f15);
      border:1px solid var(--line);
      border-radius:var(--r-lg);
      box-shadow: var(--shadow);
      padding:var(--pad);
    }
    .card h3{font-size:14px; font-weight:700; letter-spacing:.2px; color:#dfe6ee; margin-bottom:8px}

    /* Layout sizing */
    @media (min-width:860px){
      .span-6{grid-column: span 6 / span 6;}
      .span-4{grid-column: span 4 / span 4;}
      .span-8{grid-column: span 8 / span 8;}
    }

    /* Inputs */
    label{display:block; font-size:12px; color:var(--muted); margin:8px 0 6px}
    input,select,button{
      width:100%; padding:12px 12px;
      border-radius:var(--r-md);
      border:1px solid var(--line);
      background:linear-gradient(180deg, #0f1117, #0c0e13);
      color:var(--fg);
      outline:none;
      transition: border-color .15s, box-shadow .15s, transform .03s;
    }
    input:focus, select:focus{
      border-color: #2856b8;
      box-shadow: 0 0 0 3px rgba(59,130,246,.2);
    }

    /* Buttons */
    .row{display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    button{
      background: linear-gradient(180deg, #1e40af, #1b3a9a);
      border-color:#1f3b99;
      color:white; font-weight:600;
    }
    button:hover{ filter: brightness(1.05) }
    button:active{ transform: translateY(1px) }
    .btn-ghost{
      background: linear-gradient(180deg, #0f1117, #0d0f15);
      color: var(--fg);
    }
    .btn-warn{
      background: linear-gradient(180deg, #7c2d12, #6b2109);
      border-color:#5c1a07;
    }
    .btn-ok{
      background: linear-gradient(180deg, #166534, #115c2e);
      border-color:#0b4d25;
    }

    /* Pills */
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      min-height:34px; padding:8px 12px;
      border:1px solid var(--line); border-radius:999px;
      background:linear-gradient(180deg, #101219, #0e1016);
      box-shadow: var(--shadow-soft);
      font-size:13px; color:#dbe5f2;
    }

    /* Sections */
    .section-title{
      display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;
    }
    .right{margin-left:auto}

    /* Divider */
    .hr{height:1px;background:linear-gradient(90deg, transparent, #1b1d28, transparent); margin:12px 0}

    /* Footer */
    .footer{margin-top:10px; color:var(--muted); font-size:12px; text-align:right}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="header">
      <div class="title">ðŸ›¡ Guardian Admin</div>
      <span id="kite-badge" class="badge"><span class="dot" style="background:#555"></span> Zerodha: â€”</span>
      <span id="engine-badge" class="badge b-accent"><span class="dot" style="background:#3b82f6"></span> Guardian: â€”</span>
      <div class="right muted tiny" id="now">â€”</div>
    </div>

    <div class="grid">
      <!-- Admin Auth -->
      <section class="card span-6">
        <div class="section-title"><h3>Admin Auth</h3></div>
        <div class="row">
          <div>
            <label>Admin Token (stored locally)</label>
            <input id="token" type="password" placeholder="Paste ADMIN_TOKEN once" />
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="actions">
              <button onclick="saveToken()">Save Token</button>
              <button class="btn-ghost" onclick="clearToken()">Clear</button>
            </div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="actions">
          <a href="/api/login"><button>Login to Zerodha</button></a>
          <span class="muted tiny">Keep this window open while you trade.</span>
        </div>
      </section>

      <!-- Live State -->
      <section class="card span-6">
        <div class="section-title"><h3>Live State</h3><button class="btn-ghost" onclick="refresh()">Refresh</button></div>
        <div class="row">
          <div>
            <label>Capital @ 09:15</label>
            <div id="cap" class="pill">â€”</div>
          </div>
          <div>
            <label>Realised / Unrealised / Total</label>
            <div id="pnl" class="pill">â€”</div>
          </div>
        </div>
        <div class="row" style="margin-top:var(--gap)">
          <div>
            <label>Day Status</label>
            <div id="day" class="pill">â€”</div>
          </div>
          <div>
            <label>New Orders</label>
            <div id="block" class="pill">â€”</div>
          </div>
        </div>
        <div class="row" style="margin-top:var(--gap)">
          <div>
            <label>Consecutive Losses</label>
            <div id="losses" class="pill">â€”</div>
          </div>
          <div>
            <label>Cooldown Until</label>
            <div id="cool" class="pill">â€”</div>
          </div>
        </div>
      </section>

      <!-- Daily Rules -->
      <section class="card span-6">
        <div class="section-title"><h3>Daily Rules</h3></div>
        <div class="row">
          <div>
            <label>Max Loss % (daily)</label>
            <input id="max_loss_pct" type="number" step="0.1" placeholder="10" />
          </div>
          <div>
            <label>Trailing Step (â‚¹)</label>
            <input id="trail_step_profit" type="number" step="100" placeholder="5000" />
          </div>
        </div>
        <div class="row" style="margin-top:var(--gap)">
          <div>
            <label>Cooldown (minutes)</label>
            <input id="cooldown_min" type="number" step="1" placeholder="15" />
          </div>
          <div>
            <label>Max Consecutive Losses</label>
            <input id="max_consecutive_losses" type="number" step="1" placeholder="3" />
          </div>
        </div>
        <div class="row" style="margin-top:var(--gap)">
          <div>
            <label>Allow New Positions After 10% Profit?</label>
            <select id="allow_new_after_lock10">
              <option value="false">No (block new)</option>
              <option value="true">Yes (allow)</option>
            </select>
          </div>
          <div>
            <label>Expiry Day?</label>
            <select id="expiry_flag">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Weekly / Monthly -->
      <section class="card span-6">
        <div class="section-title"><h3>Weekly / Monthly Caps</h3></div>
        <div class="row">
          <div>
            <label>Weekly Max Loss % (optional)</label>
            <input id="week_max_loss_pct" type="number" step="0.1" placeholder="15" />
          </div>
          <div>
            <label>Monthly Max Loss % (optional)</label>
            <input id="month_max_loss_pct" type="number" step="0.1" placeholder="25" />
          </div>
        </div>
        <div class="muted tiny" style="margin-top:8px;">Leave blank to keep existing values. (Phase 2 logic can be toggled later.)</div>
      </section>

      <!-- Actions -->
      <section class="card span-12">
        <div class="section-title"><h3>Actions</h3></div>
        <div class="actions">
          <button class="btn-ok" onclick="saveRules()">Save Rules</button>
          <button class="btn-warn" onclick="post('/api/kill')">Engage Kill (Block + Trip Day)</button>
          <button class="btn-ghost" onclick="post('/api/unlock')">Unlock (Allow New)</button>
          <span class="right muted tiny">Tip: append <span class="kbd">?t=123</span> to bypass cache while testing.</span>
        </div>
      </section>
    </div>

    <div class="footer">Admin UI â€¢ v2.0 â€¢ Blue / Rounded</div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const readToken = ()=>localStorage.getItem('ADMIN_TOKEN')||'';
    function saveToken(){ localStorage.setItem('ADMIN_TOKEN', $('token').value.trim()); alert('Token saved.'); }
    function clearToken(){ localStorage.removeItem('ADMIN_TOKEN'); $('token').value=''; alert('Token cleared.'); }

    function setIfEmpty(id, val){
      const el = $(id); if(!el) return;
      const v = (el.tagName==='INPUT' ? el.value : el.value);
      if(v===''){ el.value = String(val); }
    }

    async function refresh(){
      try{
        const r = await fetch('/api/state?t=' + Date.now());
        const j = await r.json();
        $('now').textContent = 'Time: ' + (j.time || 'â€”');

        // Badges
        const kb = $('kite-badge'); const eb = $('engine-badge');
        kb.classList.remove('b-ok','b-warn','b-bad');
        if(j.kite_status === 'ok'){ kb.innerHTML = '<span class="dot" style="background:#22c55e"></span> Zerodha: Connected'; kb.classList.add('b-ok'); }
        else if(j.kite_status === 'invalid'){ kb.innerHTML = '<span class="dot" style="background:#e11d48"></span> Zerodha: Token invalid'; kb.classList.add('b-bad'); }
        else { kb.innerHTML = '<span class="dot" style="background:#f59e0b"></span> Zerodha: Not logged in'; kb.classList.add('b-warn'); }

        eb.innerHTML = j.ok ? '<span class="dot" style="background:#3b82f6"></span> Guardian: Online'
                            : '<span class="dot" style="background:#e11d48"></span> Guardian: Error';

        if(!j.ok){ alert('State error: ' + (j.error||'unknown')); return; }
        const s = j.state || {};

        // Pills
        const total = Number((Number(s.realised||0) + Number(s.unrealised||0)).toFixed(2));
        $('cap').textContent = Number(s.capital_day_915||0).toFixed(2);
        $('pnl').textContent = `${Number(s.realised||0).toFixed(2)} / ${Number(s.unrealised||0).toFixed(2)} / ${total.toFixed(2)}`;
        $('day').textContent = s.tripped_day ? 'TRIPPED' : 'ACTIVE';
        $('block').textContent = s.block_new_orders ? 'BLOCKED' : 'ALLOWED';
        $('losses').textContent = Number(s.consecutive_losses||0);
        $('cool').textContent = s.cooldown_until ? new Date(s.cooldown_until).toLocaleTimeString() : 'â€”';

        // Fill form (only if empty so we don't overwrite user typing)
        setIfEmpty('max_loss_pct', s.max_loss_pct ?? 10);
        setIfEmpty('trail_step_profit', s.trail_step_profit ?? 5000);
        setIfEmpty('cooldown_min', s.cooldown_min ?? 15);
        setIfEmpty('max_consecutive_losses', s.max_consecutive_losses ?? 3);
        setIfEmpty('allow_new_after_lock10', String(!!s.allow_new_after_lock10));
        setIfEmpty('expiry_flag', String(!!s.expiry_flag));

        if(s.week_max_loss_pct !== undefined) setIfEmpty('week_max_loss_pct', s.week_max_loss_pct);
        if(s.month_max_loss_pct !== undefined) setIfEmpty('month_max_loss_pct', s.month_max_loss_pct);
      }catch(e){
        alert('Failed to load state: ' + e.message);
      }
    }

    async function saveRules(){
      const token = readToken();
      if(!token){ alert('Save token first.'); return; }

      const body = {};
      copyNumber('max_loss_pct', body);
      copyNumber('trail_step_profit', body);
      copyNumber('cooldown_min', body);
      copyNumber('max_consecutive_losses', body);
      copyBool('allow_new_after_lock10', body);
      copyBool('expiry_flag', body);
      // Optional weekly/monthly
      copyNumber('week_max_loss_pct', body, true);
      copyNumber('month_max_loss_pct', body, true);

      const r = await fetch('/api/rules-set', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
        body: JSON.stringify(body)
      });
      const j = await r.json();
      if(!j.ok){ alert('Save failed: ' + (j.error||'unknown')); return; }
      alert('Rules saved.'); refresh();
    }

    function copyNumber(id, out, optional=false){
      const el = $(id); if(!el) return;
      const v = el.value.trim();
      if(v===''){ if(!optional) out[id] = undefined; return; }
      const n = Number(v);
      if(!Number.isNaN(n)) out[id] = n;
    }
    function copyBool(id, out){
      const el = $(id); if(!el) return;
      const v = el.value.trim();
      if(v==='true') out[id]=true; else if(v==='false') out[id]=false;
    }

    async function post(url){
      const token = readToken();
      if(!token){ alert('Save token first.'); return; }
      const r = await fetch(url, { method:'POST', headers:{ 'Authorization':'Bearer '+token } });
      const j = await r.json();
      if(!j.ok){ alert('Action failed: ' + (j.error||'unknown')); return; }
      alert(j.message || 'OK'); refresh();
    }

    // init
    $('token').value = readToken();
    refresh();
    setInterval(refresh, 10000);
  </script>
</body>
</html>
