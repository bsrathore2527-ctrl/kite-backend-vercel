<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Admin Panel</title>

  <style>
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 9999px;
      display: inline-block;
    }

    .green { background: #16a34a; }
    .yellow { background: #facc15; }
    .red { background: #dc2626; }
    .gray { background: #9ca3af; }
  </style>
</head>

<body class="bg-gray-100 min-h-screen p-6">

  <h1 class="text-3xl font-bold mb-6">Admin Panel</h1>

  <!-- MASTER STATUS -->
  <div class="bg-white p-6 rounded-xl shadow-md border mb-6">
    <h2 class="text-xl font-semibold mb-2">Master Zerodha Status</h2>
    <p id="masterStatus" class="text-gray-700">Loading...</p>

    <div class="flex gap-3 mt-3">
      <button onclick="loginMaster()"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg">Login Master Zerodha</button>

      <button onclick="refreshMasterStatus()"
        class="px-4 py-2 bg-gray-700 text-white rounded-lg">Refresh</button>
    </div>
  </div>

  <!-- ADD USER -->
  <div class="bg-white p-6 rounded-xl shadow-md border mb-6">
    <h2 class="text-xl font-semibold mb-4">Add New User</h2>

    <div class="flex flex-col md:flex-row gap-3">
      <input id="newUserId" placeholder="User ID"
             class="p-3 border rounded-lg flex-1"/>

      <input id="newUserDays" placeholder="Days" type="number"
             class="p-3 border rounded-lg w-32"/>

      <button onclick="addUser()"
        class="px-4 py-2 bg-green-600 text-white rounded-lg">Add User</button>
    </div>
  </div>

  <!-- SEARCH BAR -->
  <div class="bg-white p-4 rounded-xl shadow-md border mb-4">
    <input id="searchBox" onkeyup="filterUsers()"
           placeholder="Search user..."
           class="w-full p-3 border rounded-lg"/>
  </div>

  <!-- USER LIST -->
  <div class="bg-white p-6 rounded-xl shadow-md border">
    <div class="flex justify-between mb-3">
      <h2 class="text-xl font-semibold">Users</h2>

      <button onclick="loadUsers()" class="px-4 py-2 bg-gray-700 text-white rounded-lg">
        Refresh Users
      </button>
    </div>

    <table class="w-full border-collapse">
      <thead>
      <tr class="bg-gray-200 text-left">
        <th class="p-2">User</th>
        <th class="p-2">Last Login</th>
        <th class="p-2">Valid Until</th>
        <th class="p-2">Actions</th>
      </tr>
      </thead>

      <tbody id="usersTable">
      <tr><td class="p-3 text-gray-500" colspan="4">Click Refresh</td></tr>
      </tbody>
    </table>
  </div>


<script>

/* ---------------------------------------------
   TOKEN HANDLING
--------------------------------------------- */
function getToken() {
  let t = localStorage.getItem("adminToken");
  if (!t) {
    t = prompt("Enter Admin Token:");
    if (!t) return null;
    localStorage.setItem("adminToken", t.trim());
  }
  return t;
}

function invalidateToken() {
  localStorage.removeItem("adminToken");
  alert("Invalid token — re-enter.");
}

/* ---------------------------------------------
   MASTER STATUS
--------------------------------------------- */
async function refreshMasterStatus() {
  const token = getToken();
  if (!token) return;

  const res = await fetch("/api/admin/master-status", {
    headers: { "x-admin-token": token }
  });

  const data = await res.json();
  const el = document.getElementById("masterStatus");

  if (!data.ok) {
    el.innerHTML = `<span class="text-red-600">Error: ${data.error}</span>`;
    return;
  }

  if (!data.connected) {
    el.innerHTML = `<span class="text-red-500 font-semibold">Not logged in</span>`;
    return;
  }

  el.innerHTML = `<span class="text-green-600 font-semibold">Logged in as: ${data.user_id}</span>`;
}

setTimeout(refreshMasterStatus, 200);

/* ---------------------------------------------
   MASTER LOGIN
--------------------------------------------- */
function loginMaster() {
  const token = getToken();
  if (!token) return;

  window.location.href = `/api/admin/master-login?token=${encodeURIComponent(token)}`;
}

/* ---------------------------------------------
   ADD USER
--------------------------------------------- */
async function addUser() {
  const token = getToken();
  if (!token) return;

  const user_id = document.getElementById("newUserId").value.trim();
  const days = Number(document.getElementById("newUserDays").value.trim());

  if (!user_id || !days) return alert("Provide user id & days");

  const res = await fetch("/api/admin/addUser", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-admin-token": token },
    body: JSON.stringify({ user_id, days })
  });

  const data = await res.json();

  if (!data.ok) {
    if (data.error.includes("token")) return invalidateToken();
    return alert(data.error);
  }

  alert("User added");
  loadUsers();
}

/* ---------------------------------------------
   LOAD USERS WITH SORT
--------------------------------------------- */
async function loadUsers() {
  const token = getToken();
  if (!token) return;

  const res = await fetch("/api/admin/listUsers", {
    headers: { "x-admin-token": token }
  });

  const data = await res.json();
  const tbody = document.getElementById("usersTable");
  tbody.innerHTML = "";

  if (!data.ok) return;

  if (!data.users.length) {
    tbody.innerHTML = `<tr><td colspan="4" class="p-3 text-center">No users</td></tr>`;
    return;
  }

  window.__userStatusList = {};

  data.users.forEach(u => {
    const tr = document.createElement("tr");
    tr.id = `row-${u.id}`;

    tr.innerHTML = `
      <td class="p-2 flex items-center gap-2">
        <span id="status-${u.id}" class="status-dot gray"></span>
        ${u.id}
      </td>
      <td class="p-2" id="login-${u.id}">—</td>
      <td class="p-2">${u.valid_until ? new Date(u.valid_until).toLocaleString() : "-"}</td>
      <td class="p-2 space-x-2">
        <button onclick="extendUser('${u.id}')" class="px-3 py-1 bg-blue-600 text-white rounded">Extend</button>
        <button onclick="resetTrip('${u.id}')" class="px-3 py-1 bg-orange-600 text-white rounded">Reset</button>
        <button onclick="deleteUser('${u.id}')" class="px-3 py-1 bg-red-600 text-white rounded">Delete</button>
      </td>
    `;

    tbody.appendChild(tr);

    loadLastLogin(u.id);
    checkUserStatus(u.id);
  });
}

/* ---------------------------------------------
   LOAD LAST LOGIN
--------------------------------------------- */
async function loadLastLogin(user_id) {
  const token = getToken();
  if (!token) return;

  const el = document.getElementById(`login-${user_id}`);

  const res = await fetch(`/api/admin/user-lastlogin?user_id=${user_id}`, {
    headers: { "x-admin-token": token }
  });

  const data = await res.json();

  if (data.last_login) {
    el.innerText = new Date(data.last_login).toLocaleString();
  } else {
    el.innerText = "—";
  }
}

/* ---------------------------------------------
   LIVE CONNECTIVITY CHECK + SORT
--------------------------------------------- */
async function checkUserStatus(user_id) {
  const token = getToken();
  if (!token) return;

  const dot = document.getElementById(`status-${user_id}`);

  const res = await fetch(`/api/admin/user-status?user_id=${user_id}`, {
    headers: { "x-admin-token": token }
  });

  const data = await res.json();

  let statusValue = 2;

  if (data.connected) {
    dot.className = "status-dot green";
    statusValue = 1;
  } else if (data.reason === "no_token") {
    dot.className = "status-dot yellow";
    statusValue = 2;
  } else {
    dot.className = "status-dot red";
    statusValue = 3;
  }

  window.__userStatusList[user_id] = statusValue;
  sortUserRows();
}

/* ---------------------------------------------
   SORT USERS BY CONNECTIVITY
--------------------------------------------- */
function sortUserRows() {
  const tbody = document.getElementById("usersTable");
  const rows = Array.from(tbody.children);

  rows.sort((a, b) => {
    const A = window.__userStatusList[a.id.replace("row-", "")] || 2;
    const B = window.__userStatusList[b.id.replace("row-", "")] || 2;
    return A - B; // green → yellow → red
  });

  rows.forEach(r => tbody.appendChild(r));
}

/* ---------------------------------------------
   SEARCH FILTER
--------------------------------------------- */
function filterUsers() {
  const term = document.getElementById("searchBox").value.toLowerCase();
  const rows = document.querySelectorAll("#usersTable tr");

  rows.forEach(r => {
    if (r.innerText.toLowerCase().includes(term)) {
      r.style.display = "";
    } else {
      r.style.display = "none";
    }
  });
}

/* ---------------------------------------------
   ACTIONS
--------------------------------------------- */
async function extendUser(user_id) {
  const token = getToken();
  if (!token) return;

  const days = prompt("Extend by how many days?");
  if (!days) return;

  const res = await fetch("/api/admin/extendValidity", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-admin-token": token },
    body: JSON.stringify({ user_id, days })
  });

  const data = await res.json();
  if (data.ok) {
    alert("Extended");
    loadUsers();
  }
}

async function resetTrip(user_id) {
  const token = getToken();
  if (!token) return;

  const res = await fetch("/api/admin/resetTrip", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-admin-token": token },
    body: JSON.stringify({ user_id })
  });

  const data = await res.json();
  if (data.ok) alert("Trip Reset");
}

async function deleteUser(user_id) {
  const token = getToken();
  if (!token) return;

  if (!confirm("Delete " + user_id + "?")) return;

  const res = await fetch("/api/admin/deleteUser", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-admin-token": token },
    body: JSON.stringify({ user_id })
  });

  const data = await res.json();
  if (data.ok) {
    alert("Deleted");
    loadUsers();
  }
}

</script>

</body>
</html>
