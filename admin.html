<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Guardian — Admin</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --bg1:#0b1220;
    --bg2:#071026;
    --card:#0f1720;
    --muted:#9aa7b3;
    --accent:#3b82f6;
    --accent2:#10b981;
    --danger:#ef4444;
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02);
    --radius:14px;
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background: linear-gradient(180deg,var(--bg1) 0%, #051025 45%, #03121b 100%); color:#e6eef6;}
  .wrap{max-width:980px;margin:18px auto;padding:18px;}
  header {display:flex;align-items:center;gap:18px;margin-bottom:14px}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#0b1b2e,#071225);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;box-shadow:0 6px 20px rgba(3,8,15,0.6)}
  h1{margin:0;font-size:24px}
  .status-row{margin-left:auto;display:flex;gap:12px;align-items:center}
  .badge{padding:6px 12px;border-radius:999px;background:var(--glass);font-size:13px;color:var(--muted);display:flex;gap:8px;align-items:center}
  .badge.green{background:linear-gradient(90deg,#08321a,#07301b);color:#8ff0b2}
  .badge.red{background:linear-gradient(90deg,#3a0610,#2b0510);color:#ffb3b3}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px;border-radius:var(--radius); box-shadow: 0 6px 24px rgba(2,6,12,0.6); margin-bottom:14px; border:1px solid rgba(255,255,255,0.02)}
  .controls {display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .token-row{display:flex;gap:12px;flex:1;min-width:260px}
  input[type=password], input[type=text]{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;outline:none}
  .btn{padding:10px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:600}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#2b6df6);color:white;box-shadow:0 6px 18px rgba(43,109,246,0.12)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .btn.warn{background:linear-gradient(90deg,#2f6f18,var(--accent2));color:white}
  .btn.danger{background:linear-gradient(90deg,#b42323,var(--danger));color:white}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .info {padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.02)}
  .info h3{margin:0;font-size:18px}
  .info p{margin:6px 0 0;color:var(--muted);font-size:13px}
  .value{font-size:20px;font-weight:700;margin-top:8px}
  .muted{color:var(--muted);font-size:13px}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  .small{font-size:12px;color:var(--muted);margin-top:8px}
  @media (max-width:720px){
    .grid{grid-template-columns:repeat(1,1fr)}
    header{flex-wrap:wrap}
    .status-row{margin-left:0}
  }
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,0.7);padding:12px 18px;border-radius:10px;color:white;z-index:999;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
  .hint{font-size:12px;color:var(--muted);margin-top:8px}
  .two-col{display:flex;gap:12px;flex-wrap:wrap}
  pre#raw_responses{white-space:pre-wrap;color:#ffdede;background:rgba(0,0,0,0.12);padding:12px;border-radius:8px;margin-top:8px;max-height:220px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">G</div>
    <div>
      <h1>Guardian — Admin</h1>
      <div class="muted">Risk automation & enforcement</div>
    </div>

    <div class="status-row">
      <div id="kite_status" class="badge">Kite: —</div>
      <div id="guardian_status" class="badge">Guardian: —</div>
      <div id="now_time" class="badge">--:--:--</div>
    </div>
  </header>

  <!-- ADMIN CONTROLS -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <div style="flex:1">
        <div class="muted">Read-only mode. Enter admin token to enable changes.</div>
        <div class="controls" style="margin-top:10px;">
          <div class="token-row">
            <input id="admin_token" type="password" placeholder="ADMIN_TOKEN (password)" />
            <button id="save_token" class="btn primary">Save</button>
            <button id="clear_token" class="btn ghost">Clear</button>
            <button id="toggle_token" class="btn ghost" title="Show/Hide token">Show</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="login_kite" class="btn ghost">Login Zerodha</button>
            <button id="refresh_btn" class="btn ghost">Refresh</button>
          </div>
        </div>
        <div class="hint">Admin-only controls unlock the action buttons below. Token is stored only in localStorage.</div>
      </div>
    </div>

    <!-- admin actions (hidden until unlocked) -->
    <div id="admin_actions" style="margin-top:14px;display:none;">
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
        <button id="enforce_btn" class="btn warn">Enforce Now</button>
        <button id="kill_btn" class="btn danger">Kill (Close)</button>
        <button id="cancel_btn" class="btn ghost">Cancel All</button>
        <label style="display:flex;align-items:center;gap:8px;color:var(--muted);margin-left:6px;">
          <input id="allow_new" type="checkbox"/> <span class="muted">Allow New Orders</span>
        </label>
        <button id="reset_day_btn" class="btn ghost" title="Reset today's tripped state">Reset Day</button>
      </div>
      <div id="admin_resp" class="small"></div>
    </div>
  </div>

  <!-- LIVE overview -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Live overview</h3>
      <div><button id="refresh_top" class="btn ghost">Refresh</button></div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="info">
        <div class="muted">Capital @ 09:15</div>
        <div id="capital915" class="value">—</div>
        <div class="small">Base for daily limits</div>
      </div>

      <div class="info">
        <div class="muted">Current Balance (live/fallback)</div>
        <div id="live_balance" class="value">—</div>
        <div class="small">Uses cached if offline</div>
      </div>

      <div class="info">
        <div class="muted">Live MTM</div>
        <div id="live_mtm" class="value">—</div>
        <div class="small">Sum of position PnL</div>
      </div>

      <div class="info">
        <div class="muted">PnL (R/UR/Total)</div>
        <div id="pnl_box" class="value">—</div>
        <div class="small" id="pnl_hint">—</div>
      </div>

      <div class="info">
        <div class="muted">Max Loss (₹)</div>
        <div id="max_loss" class="value">—</div>
        <div class="small" id="max_loss_pct">—</div>
      </div>

      <div class="info">
        <div class="muted">Active Loss Floor (₹)</div>
        <div id="active_floor" class="value">—</div>
        <div class="small" id="floor_hint">—</div>
      </div>

      <div class="info">
        <div class="muted">Remaining to Max Loss (₹)</div>
        <div id="remaining_loss" class="value">—</div>
        <div class="small">Room left before floor</div>
      </div>

      <div class="info">
        <div class="muted">10% Profit Lock (₹)</div>
        <div id="p10" class="value">—</div>
        <div class="small" id="p10_hint">—</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0">More</h3>
    <div class="grid" style="margin-top:12px">
      <div class="info">
        <div class="muted">Consecutive Losses</div>
        <div id="consec_losses" class="value">0</div>
      </div>
      <div class="info">
        <div class="muted">Cooldown Until</div>
        <div id="cooldown_until" class="value">—</div>
      </div>
      <div class="info">
        <div class="muted">Expiry Flag</div>
        <div id="expiry_flag" class="value">—</div>
      </div>
      <div class="info">
        <div class="muted">Broker Balance (live)</div>
        <div id="broker_balance" class="value">—</div>
        <div class="small" id="broker_hint">From Zerodha funds</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0">Logs & actions</h3>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
      <button id="enforce_trades_btn" class="btn ghost">Enforce Trades (Run)</button>
      <button id="cancel_all_btn" class="btn ghost">Cancel All</button>
    </div>
    <div style="margin-top:12px">
      <div class="muted">Last responses</div>
      <pre id="raw_responses">—</pre>
    </div>
  </div>

  <footer>Guardian • admin console</footer>
</div>

<div id="toast" style="display:none" class="toast"></div>

<script>
/* -------------------
   Helper functions
   ------------------- */
function $(id){ return document.getElementById(id); }
function toast(msg, t=3500){
  const el = $('toast');
  if(!el) { alert(msg); return; }
  el.textContent = msg;
  el.style.display = 'block';
  clearTimeout(el._t);
  el._t = setTimeout(()=> el.style.display = 'none', t);
}
function nowIST(){ return new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata',hour12:false}); }
function fmtINR(v){
  if(v==null || isNaN(Number(v))) return '—';
  return new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR',maximumFractionDigits:0}).format(Math.round(Number(v)));
}

/* Auth header from localStorage token (admin UI stores token locally) */
function authHeader(){
  const tk = localStorage.getItem('ADMIN_TOKEN') || localStorage.getItem('admin_token') || '';
  if(!tk) return {};
  return { 'Authorization': tk.startsWith('Bearer ') ? tk : ('Bearer ' + tk) };
}

/* append to raw responses log */
function appendLog(txt){
  const pre = $('raw_responses');
  if(!pre) return;
  const now = new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata',hour12:false});
  pre.textContent = `[${now}] ${txt}\n\n` + pre.textContent;
}

/* -------------------
   API endpoints
   ------------------- */
const ENDPOINTS = {
  state: '/api/state',
  kite_login: '/api/kite/login',
  kite_funds: '/api/kite/funds',
  enforce_trades: '/api/enforce-trades',
  enforce: '/api/enforce',
  kill: '/api/admin/kill',
  cancel: '/api/admin/cancel',
  set_config: '/api/admin/set-config',
  enforce_run: '/api/admin/enforce' // if you have admin-enforce
};

/* -------------------
   UI state functions
   ------------------- */

async function loadState(){
  try {
    const r = await fetch(ENDPOINTS.state + '?t=' + Date.now());
    const j = await r.json();
    if(!j || !j.ok) { toast('Failed to load state'); return; }
    $('now_time').textContent = j.time || nowIST();
    $('kite_status').textContent = (j.kite_status === 'ok') ? 'Kite: Connected' : (j.kite_status || 'Kite: —');
    $('guardian_status').textContent = j.admin ? 'admin' : 'online';
    const s = j.state || {};
    // capital precedence: capital_day_915
    $('capital915').textContent = fmtINR(s.capital_day_915 || 0);
    $('consec_losses').textContent = String(s.consecutive_losses || 0);
    $('cooldown_until').textContent = s.cooldown_until ? new Date(Number(s.cooldown_until)).toLocaleString() : '—';
    $('expiry_flag').textContent = s.expiry_flag ? 'YES' : 'NO';
    const realised = Number(s.realised || 0);
    const unreal = Number(s.unrealised || 0);
    const total = realised + unreal;
    $('pnl_box').textContent = `${fmtINR(realised)} / ${fmtINR(unreal)} / ${fmtINR(total)}`;
    $('pnl_hint').textContent = total < 0 ? 'In loss' : (total>0?'In profit':'—');
    $('max_loss').textContent = fmtINR(Math.round((s.capital_day_915 || 0) * ((s.max_loss_pct ?? 10)/100)));
    $('max_loss_pct').textContent = `Max Loss %: ${(s.max_loss_pct ?? 10)}%`;
    $('active_floor').textContent = fmtINR(s.active_loss_floor || 0);
    $('remaining_loss').textContent = fmtINR((s.capital_day_915 || 0) - Math.abs(total));
    // p10 display
    if (s.p10_is_pct || (typeof s.p10 === 'number')) {
      $('p10').textContent = (s.p10_is_pct ? (String(s.p10) + '%') : fmtINR(s.p10_amount || 0));
      $('p10_hint').textContent = s.p10_is_pct ? 'Max profit %' : 'Max profit (amount)';
    } else {
      $('p10').textContent = '—';
      $('p10_hint').textContent = '';
    }

    // live balance if provided
    if (typeof s.live_balance !== 'undefined' && s.live_balance !== null) {
      $('live_balance').textContent = fmtINR(s.live_balance);
      $('broker_balance').textContent = fmtINR(s.live_balance);
    } else {
      $('live_balance').textContent = fmtINR(s.current_balance || s.capital_day_915 || 0);
    }

    // show/hide admin actions
    if (j.admin) {
      $('admin_actions').style.display = 'block';
    } else {
      $('admin_actions').style.display = 'none';
    }

    // If auto_untripped flag exists, show a small log entry
    if (s.auto_untripped_due_to_zero_capital) {
      appendLog('AUTO-UNTRIPPED (zero capital) — UI shows active, KV unchanged');
    }
  } catch (e) {
    console.error('loadState err', e);
    toast('State load error');
  }
}

async function loadFunds(){
  try {
    const r = await fetch(ENDPOINTS.kite_funds, { method: 'GET', headers: authHeader() });
    const j = await r.json();
    if (j && j.ok && j.funds) {
      let av = j.funds?.available?.live_balance ?? j.balance ?? j.funds?.available?.cash ?? j.funds?.net;
      $('live_balance').textContent = fmtINR(av ?? 0);
      $('broker_balance').textContent = fmtINR(av ?? 0);
    } else {
      // fallback to state
      const sRes = await fetch(ENDPOINTS.state);
      const sJson = await sRes.json();
      const fallback = sJson?.state?.current_balance ?? sJson?.state?.capital_day_915 ?? 0;
      $('live_balance').textContent = fmtINR(fallback);
    }
  } catch (e) {
    console.warn('loadFunds err', e);
    const sRes = await fetch(ENDPOINTS.state);
    const sJson = await sRes.json();
    const fallback = sJson?.state?.current_balance ?? sJson?.state?.capital_day_915 ?? 0;
    $('live_balance').textContent = fmtINR(fallback);
  }
}

/* Combined refresh */
async function loadAll(){
  await Promise.allSettled([loadState(), loadFunds()]);
}

/* -------------------
   Token handling
   ------------------- */
function getStoredToken(){ return localStorage.getItem('ADMIN_TOKEN') || ''; }
function setStoredToken(v){ if(v) localStorage.setItem('ADMIN_TOKEN', v); else localStorage.removeItem('ADMIN_TOKEN'); }
function applyTokenUI(){
  const t = getStoredToken();
  const inp = $('admin_token');
  if (t) {
    inp.value = '********';
    inp.dataset.real = '1';
    $('save_token').textContent = 'Saved';
    setTimeout(()=> $('save_token').textContent = 'Save', 1200);
    $('admin_actions').style.display = 'block';
  } else {
    inp.value = '';
    inp.dataset.real = '0';
    $('admin_actions').style.display = 'none';
  }
}
applyTokenUI();

function saveToken(){
  const inp = $('admin_token');
  const val = inp.value.trim();
  if (inp.dataset.real === '1' && val === '********') {
    toast('Token already saved (masked). Use Clear to replace.');
    return;
  }
  if (!val) { toast('Enter admin token'); return; }
  setStoredToken(val);
  applyTokenUI();
  toast('Admin token saved locally');
  loadAll();
}
function clearToken(){
  setStoredToken('');
  applyTokenUI();
  toast('Admin token cleared');
  loadAll();
}
$('save_token')?.addEventListener('click', saveToken);
$('clear_token')?.addEventListener('click', clearToken);
$('toggle_token')?.addEventListener('click', ()=>{
  const inp = $('admin_token');
  if (inp.dataset.real === '1') {
    // reveal briefly
    const real = getStoredToken();
    inp.type = 'text'; inp.value = real;
    setTimeout(()=>{ inp.type='password'; inp.value='********'; }, 3000);
  } else {
    inp.type = (inp.type === 'password') ? 'text' : 'password';
    $('toggle_token').textContent = (inp.type === 'password') ? 'Show' : 'Hide';
  }
});

/* -------------------
   Button actions (admin) - enforce, kill, cancel, reset day
   ------------------- */
async function enforceNow(){
  $('enforce_btn').disabled = true;
  try {
    // try GET enforce endpoint
    const r = await fetch(ENDPOINTS.enforce + '?t=' + Date.now(), { method:'GET', headers: authHeader() });
    const j = await r.json().catch(()=>({ ok:false, error:'invalid json' }));
    appendLog('/api/enforce => ' + JSON.stringify(j));
    if (j.ok) toast('Enforce executed');
    else toast('Enforce: ' + (j.error || 'failed'));
    await loadAll();
  } catch (e) {
    toast('Enforce failed: ' + (e.message || e));
  } finally { $('enforce_btn').disabled = false; }
}

async function killNow(){
  if (!confirm('Kill will attempt to close running positions. Proceed?')) return;
  $('kill_btn').disabled = true;
  try {
    // try admin kill endpoint, fallback to /api/admin/kill
    const r = await fetch(ENDPOINTS.kill, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', ...authHeader() },
      body: JSON.stringify({ force: true })
    });
    const j = await r.json().catch(()=>({ ok:false, error:'invalid json' }));
    appendLog('/api/admin/kill => ' + JSON.stringify(j));
    if (j.ok) toast('Kill executed');
    else toast('Kill: ' + (j.error || 'failed'));
    await loadAll();
  } catch (e) {
    toast('Kill failed: ' + (e.message || e));
  } finally { $('kill_btn').disabled = false; }
}

async function cancelAll(){
  if (!confirm('Cancel all pending orders?')) return;
  $('cancel_btn').disabled = true;
  try {
    const r = await fetch(ENDPOINTS.cancel, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', ...authHeader() },
      body: JSON.stringify({})
    });
    const j = await r.json().catch(()=>({ ok:false, error:'invalid json' }));
    appendLog('/api/admin/cancel => ' + JSON.stringify(j));
    if (j.ok) toast('Cancel executed');
    else toast('Cancel: ' + (j.error || 'failed'));
    await loadAll();
  } catch (e) {
    toast('Cancel failed: ' + (e.message || e));
  } finally { $('cancel_btn').disabled = false; }
}

/* Reset Day button handler */
$('reset_day_btn')?.addEventListener('click', async () => {
  if (!confirm("Reset day will clear 'tripped' state and unblock new orders. Proceed?")) return;
  const btn = $('reset_day_btn'); btn.disabled = true;
  try {
    const res = await fetch(ENDPOINTS.set_config, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeader() },
      body: JSON.stringify({ reset_day: true })
    });
    const j = await res.json().catch(()=>({ ok:false, error:'invalid json' }));
    appendLog('/api/admin/set-config reset_day => ' + JSON.stringify(j));
    if (j.ok) {
      toast('Day reset successful. Guardian active again.');
      await loadAll();
    } else {
      toast('Reset failed: ' + (j.error || 'unknown'));
    }
  } catch (err) {
    toast('Network error: ' + (err.message || err));
  } finally { btn.disabled = false; }
});

/* Additional UI buttons that map to endpoints */
$('enforce_trades_btn')?.addEventListener('click', async () => {
  $('enforce_trades_btn').disabled = true;
  try {
    const r = await fetch(ENDPOINTS.enforce_trades + '?t=' + Date.now(), { method: 'GET', headers: authHeader() });
    const j = await r.json().catch(()=>({ ok:false, error:'invalid json' }));
    appendLog('/api/enforce-trades => ' + JSON.stringify(j));
    if (j.ok) toast('Enforce-trades run');
    else toast('Enforce-trades: ' + (j.error||'failed'));
    await loadAll();
  } catch (e) { toast('Error: ' + (e.message||e)); }
  finally { $('enforce_trades_btn').disabled = false; }
});
$('cancel_all_btn')?.addEventListener('click', cancelAll);

/* -------------------
   Zerodha login helper
   ------------------- */
async function loginKite(){
  const btn = $('login_kite'); btn.disabled = true;
  try {
    // try GET then POST
    let r = await fetch(ENDPOINTS.kite_login, { method: 'GET', headers: authHeader() });
    if (r.status === 405 || r.status === 400) {
      r = await fetch(ENDPOINTS.kite_login, { method: 'POST', headers: { 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify({}) });
    }
    const j = await r.json().catch(()=>({ ok:false, error:'invalid json' }));
    appendLog('/api/kite/login => ' + JSON.stringify(j));
    if (j.ok) toast('Zerodha login started/OK');
    else toast('Zerodha login: ' + (j.error||'failed'));
    // some flows redirect user; if you return a URL handle it here (not needed usually)
    await loadAll();
  } catch (e) {
    toast('Login failed: ' + (e.message || e));
  } finally { btn.disabled = false; }
}
$('login_kite')?.addEventListener('click', loginKite);

/* -------------------
   Set capital (admin)
   ------------------- */
async function setCapital(){
  const v = Number(prompt('Enter new capital at 09:15 (number)'));
  if (!Number.isFinite(v)) { toast('Invalid value'); return; }
  try {
    const r = await fetch(ENDPOINTS.set_config, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', ...authHeader() },
      body: JSON.stringify({ capital_day_915: v, admin_override_capital: true })
    });
    const j = await r.json().catch(()=>({ ok:false, error:'invalid json' }));
    appendLog('/api/admin/set-config capital => ' + JSON.stringify(j));
    if (j.ok) {
      toast('Capital set: ' + fmtINR(v));
      await loadAll();
    } else {
      toast('Set capital failed: ' + (j.error || 'unknown'));
    }
  } catch (e) {
    toast('Failed to set capital: ' + (e.message||e));
  }
}

/* -------------------
   Init wiring and periodic refresh
   ------------------- */
function init(){
  // wire basic buttons
  $('save_token')?.addEventListener('click', saveToken);
  $('clear_token')?.addEventListener('click', clearToken);
  $('refresh_btn')?.addEventListener('click', loadAll);
  $('refresh_top')?.addEventListener('click', loadAll);

  $('enforce_btn')?.addEventListener('click', enforceNow);
  $('kill_btn')?.addEventListener('click', killNow);
  $('cancel_btn')?.addEventListener('click', cancelAll);

  // admin helper
  $('reset_day_btn')?.style.display = 'inline-block';

  // if token exists, set admin mode
  if (getStoredToken()) applyTokenUI();

  // initial load
  loadAll();
  setInterval(()=> { $('now_time').textContent = nowIST(); }, 1000);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
  </html>
