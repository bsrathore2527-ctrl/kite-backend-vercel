<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guardian — Admin</title>
<style>
  :root{
    --bg:#0f1720; --card:#0b1220; --muted:#9aa6b2; --ok:#2ecc71; --bad:#ff6b6b;
    --accent:#38bdf8; --glass: rgba(255,255,255,0.03);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:
    linear-gradient(180deg,#071029 0%, #08111a 60%); color:#e6eef6;}
  .wrap{max-width:1150px;margin:18px auto;padding:18px;display:grid;gap:14px;
    grid-template-columns: 1fr; }
  header{display:flex;align-items:center;gap:12px;}
  h1{margin:0;font-size:20px;font-weight:600}
  .topbar{display:flex;gap:8px;align-items:center;margin-left:auto}
  .btn{background:var(--card);border:1px solid rgba(255,255,255,0.03);
    padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer;
    box-shadow: 0 4px 18px rgba(2,6,23,0.6); transition: transform .08s, box-shadow .12s;}
  .btn:active,.btn.pressed{transform:translateY(1px) scale(.997);opacity:.95}
  .btn.primary{background:linear-gradient(180deg,#0369a1,#044e75);color:#fff;}
  .btn.warn{background:linear-gradient(180deg,#7b2,#5a8);color:#051109}
  .btn.toggled{background:linear-gradient(180deg,#10b981,#059669); color:#022; border:0}

  .grid{display:grid;gap:12px;grid-template-columns: 1fr 380px;}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }

  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03); box-shadow:0 6px 30px rgba(0,0,0,0.6);}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .kpi{display:flex;flex-direction:column;padding:8px;border-radius:8px;background:var(--glass);
    min-width:120px}
  .kpi .label{font-size:12px;color:var(--muted)}
  .kpi .value{font-weight:700;font-size:16px;margin-top:6px}
  .muted{color:var(--muted);font-size:13px}
  #admin-lock-badge{padding:6px 10px;border-radius:8px;background:#071427;color:#cde6f5;font-size:13px;margin-left:6px}

  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:6px 8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03)}
  th{color:var(--muted);font-size:12px}
  tbody tr td:first-child{width:120px}
  .muted-sm{color:var(--muted);font-size:12px}

  input,select{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#eaf6ff;padding:8px;border-radius:6px}
  input[disabled]{opacity:.6}
  .field{display:flex;flex-direction:column;gap:6px}
  .admin-editable{opacity:.95}

  footer{font-size:12px;color:var(--muted);text-align:center;padding:8px}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <img src="" alt="" style="width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#0369a1,#0ea5a3)"/>
    <div>
      <h1>Guardian — Admin</h1>
      <div class="muted" id="subline">Risk automation & enforcement</div>
    </div>

    <div class="topbar">
      <div id="kite-status" class="muted-sm">Kite: <strong id="kite-status-val">—</strong></div>
      <div id="admin-lock-badge">Lock: unknown</div>
      <button class="btn" id="login-admin-btn" data-feedback="true">Set Admin Token</button>
      <button class="btn primary" id="acquire-lock-btn" data-feedback="true">Acquire Lock</button>
      <button class="btn" id="release-lock-btn" data-feedback="true">Release Lock</button>
    </div>
  </header>

  <div class="grid">
    <!-- left column -->
    <div>

      <div class="card row" style="justify-content:space-between;align-items:flex-start">
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div class="kpi">
            <div class="label">Capital (08:30 IST)</div>
            <div class="value" id="capital-val">-</div>
            <div class="muted-sm" id="cap-time">snapshot: -</div>
          </div>
          <div class="kpi">
            <div class="label">Live Balance</div>
            <div class="value" id="live-balance">-</div>
            <div class="muted-sm" id="live-misc">unrealised: -</div>
          </div>
          <div class="kpi">
            <div class="label">Day Trip</div>
            <div class="value" id="tripped-day">-</div>
            <div class="muted-sm" id="block-new">block new: -</div>
          </div>
          <div class="kpi">
            <div class="label">Consecutive Losses</div>
            <div class="value" id="consec-loss">0</div>
            <div class="muted-sm" id="cooldown-until">cooldown: -</div>
          </div>
        </div>
        <div style="min-width:220px;">
          <div class="muted" style="margin-bottom:6px">Quick actions</div>
          <div style="display:flex;gap:8px;flex-direction:column">
            <button class="btn admin-editable" id="btn-snapshot" data-feedback="true">Take 08:30 Snapshot</button>
            <button class="btn admin-editable warn" id="btn-enforce-now" data-feedback="true">Enforce Now</button>
            <button class="btn admin-editable" id="btn-reset-consec" data-feedback="true">Reset Consecutive</button>
          </div>
        </div>
      </div>

      <!-- Rules & editable controls -->
      <div class="card" id="rules-card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:600">Risk Rules (editable by admin)</div>
          <div class="muted-sm">Only when you hold the lock</div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
          <div class="field">
            <label class="muted-sm">Max loss (%)</label>
            <input id="rule-max-loss-pct" class="admin-editable" type="number" />
          </div>
          <div class="field">
            <label class="muted-sm">Trailing step (₹)</label>
            <input id="rule-trail-step" class="admin-editable" type="number" />
          </div>
          <div class="field">
            <label class="muted-sm">Cooldown (min)</label>
            <input id="rule-cooldown" class="admin-editable" type="number" />
          </div>
          <div class="field">
            <label class="muted-sm">Max consecutive losses</label>
            <input id="rule-max-consec" class="admin-editable" type="number" />
          </div>
          <div class="field">
            <label class="muted-sm">Max trades / day</label>
            <input id="rule-max-trades" class="admin-editable" type="number" />
          </div>
          <div class="field">
            <label class="muted-sm">Allow new after 10% lock</label>
            <select id="rule-allow-after-10" class="admin-editable">
              <option value="false">No (default)</option>
              <option value="true">Yes (admin enable)</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn admin-editable primary" id="save-rules-btn" data-feedback="true">Save Rules</button>
          <button class="btn" id="refresh-state-btn" data-feedback="true">Refresh</button>
        </div>
      </div>

      <!-- Trade history -->
      <div class="card" id="trade-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:600">Trade history (realized recent)</div>
          <div class="muted-sm">auto-refresh every 15s</div>
        </div>
        <div style="margin-top:8px; overflow:auto; max-height:320px;">
          <table>
            <thead><tr><th>Time</th><th>Symbol</th><th>Qty</th><th>IN</th><th>OUT</th><th>Realized</th></tr></thead>
            <tbody id="trade-table-body"></tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- right column -->
    <aside>
      <div class="card">
        <div style="font-weight:600">Connection & status</div>
        <div style="margin-top:8px" class="muted-sm">Shows kite connection & enforcement info</div>
        <div style="margin-top:12px">
          <div class="muted-sm">Kite status: <strong id="kite-conn">—</strong></div>
          <div class="muted-sm">Last enforce: <span id="last-enforce">-</span></div>
          <div style="margin-top:10px">Trade count today: <strong id="trade-count">0</strong></div>
          <div style="margin-top:8px">Profit lock 10%: <strong id="profit-lock-10">false</strong></div>
          <div>Profit lock 20%: <strong id="profit-lock-20">false</strong></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:600">Manual commands</div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-direction:column">
          <button class="btn" id="btn-show-state" data-feedback="true">Show Raw State</button>
          <button class="btn" id="btn-show-trades" data-feedback="true">Show Raw Trades</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="muted-sm">UI Settings</div>
        <div style="margin-top:8px">
          <label class="muted-sm">Vibration on click</label>
          <select id="ui-vibrate"><option value="true">On</option><option value="false">Off</option></select>
        </div>
      </div>
    </aside>
  </div>

  <footer>Guardian • Keep your admin token private • Last updated: <span id="footer-time">—</span></footer>
</div>

<script>
/* ============================
   Configuration / helpers
   ============================ */

const API_BASE = window.location.origin + '/api';
let ADMIN_TOKEN = localStorage.getItem('ADMIN_TOKEN') || '';
const CLIENT_ID = (() => {
  let v = localStorage.getItem('guardian_client_id');
  if (!v) { v = 'cli_' + Date.now() + '_' + Math.floor(Math.random()*99999); localStorage.setItem('guardian_client_id', v); }
  return v;
})();
const CLIENT_LABEL = (navigator.platform || navigator.userAgent).slice(0,40);
let lockRefreshTimer = null;
let pollTimer = null;
const POLL_INTERVAL = 15000; // 15s
const LOCK_POLL_INTERVAL = 10000; // 10s

function headers() {
  const h = { 'Content-Type':'application/json' };
  if (ADMIN_TOKEN) h['Authorization'] = 'Bearer ' + ADMIN_TOKEN;
  return h;
}

async function api(path, opts = {}) {
  opts.headers = Object.assign({}, opts.headers || {}, headers());
  const r = await fetch(API_BASE + path, opts);
  try { return await r.json(); } catch { return { ok:false, status:r.status }; }
}

/* ============================
   UI Feedback (press + vibrate)
   ============================ */
function pressFeedback(el) {
  if (!el) return;
  el.classList.add('pressed');
  if (document.getElementById('ui-vibrate').value !== 'false' && navigator.vibrate) navigator.vibrate(35);
  setTimeout(()=>el.classList.remove('pressed'), 120);
}
document.addEventListener('click', (ev)=>{
  const b = ev.target.closest('[data-feedback="true"]');
  if (b) pressFeedback(b);
});

/* ============================
   Admin token management
   ============================ */
document.getElementById('login-admin-btn').addEventListener('click', ()=> {
  const cur = ADMIN_TOKEN || '';
  const token = prompt('Paste ADMIN_TOKEN (keeps in localStorage for this browser):', cur);
  if (token === null) return;
  ADMIN_TOKEN = token.trim();
  localStorage.setItem('ADMIN_TOKEN', ADMIN_TOKEN);
  alert('Admin token saved locally. Use Acquire Lock to edit.');
});

/* ============================
   Lock: acquire / release / refresh / poll
   ============================ */
async function acquireLock() {
  const res = await api('/admin?action=lock', { method:'POST', body: JSON.stringify({ client_id: CLIENT_ID, label: CLIENT_LABEL }) });
  handleLockRes(res);
}
async function refreshLock() {
  const res = await api('/admin?action=lock', { method:'POST', body: JSON.stringify({ client_id: CLIENT_ID, label: CLIENT_LABEL }) });
  handleLockRes(res);
}
async function releaseLock() {
  const res = await api('/admin?action=unlock', { method:'POST', body: JSON.stringify({ client_id: CLIENT_ID }) });
  handleLockRes(res);
}

function handleLockRes(res) {
  const badge = document.getElementById('admin-lock-badge');
  if (!res || !res.ok) {
    badge.textContent = 'Lock: Error';
    badge.dataset.locked = 'false';
    setAdminEditable(false);
    stopLockRefresh();
    return;
  }
  const lock = res.admin_lock || res.admin_lock_present && res.admin_lock ? res.admin_lock : (res.admin_lock || null);
  if (res.locked && lock && lock.owner === CLIENT_ID) {
    badge.textContent = `Locked by you (${lock.label||'me'})`;
    badge.dataset.locked = 'true';
    setAdminEditable(true);
    startLockRefresh();
  } else if (lock) {
    badge.textContent = `Locked by ${lock.label || lock.owner}`;
    badge.dataset.locked = 'false';
    setAdminEditable(false);
    stopLockRefresh();
  } else {
    badge.textContent = 'Unlocked';
    badge.dataset.locked = 'false';
    setAdminEditable(false);
    stopLockRefresh();
  }
}

function setAdminEditable(enabled) {
  document.querySelectorAll('.admin-editable').forEach(el=>{
    if (enabled) { el.removeAttribute('disabled'); el.style.opacity='1' }
    else { el.setAttribute('disabled','true'); el.style.opacity='.6' }
  });
}

function startLockRefresh(){
  stopLockRefresh();
  lockRefreshTimer = setInterval(()=>{ refreshLock(); }, 2*60*1000); // every 2 minutes
  // also ensure we poll state so UI shows ownership
}
function stopLockRefresh(){ if (lockRefreshTimer){ clearInterval(lockRefreshTimer); lockRefreshTimer = null } }

/* ============================
   State refresh & UI render
   ============================ */
async function loadState() {
  const r = await api('/state');
  if (!r || !r.ok) { console.warn('state err', r); return; }
  // kite status
  document.getElementById('kite-status-val').textContent = r.kite_status || 'not_logged_in';
  document.getElementById('kite-conn').textContent = r.kite_status || 'not_logged_in';
  // state
  const s = r.state || {};
  document.getElementById('capital-val').textContent = (s.capital_day_830 ?? s.capital_day_915 ?? 0).toString();
  document.getElementById('cap-time').textContent = 'snapshot: ' + (s.capital_snapshot_time || '-');
  document.getElementById('live-balance').textContent = (s.current_balance ?? 0).toString();
  document.getElementById('live-misc').textContent = `unrealised: ${s.unrealised ?? 0}`;
  document.getElementById('tripped-day').textContent = s.tripped_day ? 'YES' : 'NO';
  document.getElementById('block-new').textContent = s.block_new_orders ? 'YES' : 'NO';
  document.getElementById('consec-loss').textContent = s.consecutive_losses ?? 0;
  document.getElementById('cooldown-until').textContent = s.cooldown_until ? (new Date(s.cooldown_until).toLocaleTimeString()) : '-';
  document.getElementById('trade-count').textContent = s.trade_count ?? 0;
  document.getElementById('profit-lock-10').textContent = s.profit_lock_10 ? 'true' : 'false';
  document.getElementById('profit-lock-20').textContent = s.profit_lock_20 ? 'true' : 'false';
  document.getElementById('last-enforce').textContent = r.time || '-';
  document.getElementById('footer-time').textContent = new Date().toLocaleString();

  // populate rule controls
  document.getElementById('rule-max-loss-pct').value = s.max_loss_pct ?? 10;
  document.getElementById('rule-trail-step').value = s.trail_step_profit ?? 5000;
  document.getElementById('rule-cooldown').value = s.cooldown_min ?? 15;
  document.getElementById('rule-max-consec').value = s.max_consecutive_losses ?? 3;
  document.getElementById('rule-max-trades').value = s.max_trades_per_day ?? 20;
  document.getElementById('rule-allow-after-10').value = (s.allow_new_after_lock10 ? 'true' : 'false');

  // admin lock present in state?
  if (s.admin_lock) {
    handleLockRes({ ok:true, locked:false, admin_lock: s.admin_lock, admin_lock_present:true });
  }
}

/* ============================
   Save rules
   ============================ */
document.getElementById('save-rules-btn').addEventListener('click', async ()=>{
  // Prepare patch
  const patch = {
    max_loss_pct: Number(document.getElementById('rule-max-loss-pct').value || 10),
    trail_step_profit: Number(document.getElementById('rule-trail-step').value || 5000),
    cooldown_min: Number(document.getElementById('rule-cooldown').value || 15),
    max_consecutive_losses: Number(document.getElementById('rule-max-consec').value || 3),
    max_trades_per_day: Number(document.getElementById('rule-max-trades').value || 20),
    allow_new_after_lock10: document.getElementById('rule-allow-after-10').value === 'true'
  };
  // call admin snapshot endpoint to save (we'll use admin?action=snapshot?no - reuse admin route for updates)
  // Since we merged endpoints, use admin?action=snapshot as privileged write - server will save state
  const res = await api('/admin?action=snapshot', { method:'POST', body: JSON.stringify({ patch }) });
  if (res && res.ok) { alert('Rules saved'); loadState(); } else { alert('Save failed'); }
});

/* ============================
   Quick actions
   ============================ */
document.getElementById('btn-snapshot').addEventListener('click', async ()=>{
  const ok = confirm('Run morning snapshot now? (requires admin token)');
  if (!ok) return;
  const res = await api('/admin?action=snapshot', { method:'POST', body: JSON.stringify({}) });
  if (res && res.ok) { alert('Snapshot done'); loadState(); } else { alert('Snapshot failed'); }
});

document.getElementById('btn-enforce-now').addEventListener('click', async ()=>{
  // call enforce endpoint (public) — may require secret; this will run enforcement
  const res = await api('/enforce', { method:'GET' });
  if (res && res.ok) { alert('Enforce executed'); loadState(); } else { alert('Enforce failed: ' + (res && res.error)); }
});

document.getElementById('btn-reset-consec').addEventListener('click', async ()=>{
  if (!confirm('Reset consecutive losses to 0?')) return;
  const res = await api('/admin?action=snapshot', { method:'POST', body: JSON.stringify({ patch:{ consecutive_losses:0 } }) });
  if (res && res.ok) { alert('Reset'); loadState(); } else alert('Reset failed');
});

/* ============================
   Trades panel
   ============================ */
async function refreshTrades() {
  try {
    const r = await api('/admin?action=trades');
    if (!r || !r.ok) return;
    const realized = (r.history || []).slice(-80).reverse();
    const tbody = document.getElementById('trade-table-body'); tbody.innerHTML = '';
    for (const ev of realized) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(ev.time).toLocaleTimeString()}</td>
        <td>${ev.symbol || ev.symbolKey || ''}</td>
        <td>${ev.qty || ''}</td>
        <td>${(ev.price_in||'')}</td>
        <td>${(ev.price_out||'')}</td>
        <td style="color:${Number(ev.pnl||0) < 0 ? 'var(--bad)' : 'var(--ok)'}">${Number(ev.pnl||0).toFixed(2)}</td>`;
      tbody.appendChild(tr);
    }
  } catch(e){ console.error(e) }
}

/* ============================
   Polling start/stop
   ============================ */
function startPoll() {
  stopPoll();
  loadState(); refreshTrades();
  pollTimer = setInterval(()=>{ loadState(); refreshTrades(); }, POLL_INTERVAL);
}
function stopPoll(){ if (pollTimer){ clearInterval(pollTimer); pollTimer = null } }

/* ============================
   Helper: poll lock-only status (to show who holds lock)
   ============================ */
async function pollLockOnly() {
  const r = await api('/state');
  if (r && r.state && r.state.admin_lock) {
    handleLockRes({ ok:true, locked:false, admin_lock: r.state.admin_lock });
  } else {
    handleLockRes({ ok:true, locked:false, admin_lock: null });
  }
}
setInterval(pollLockOnly, LOCK_POLL_INTERVAL);

/* ============================
   Raw debug buttons
   ============================ */
document.getElementById('btn-show-state').addEventListener('click', async ()=>{
  const r = await api('/state'); alert(JSON.stringify(r, null, 2));
});
document.getElementById('btn-show-trades').addEventListener('click', async ()=>{
  const r = await api('/admin?action=trades'); alert(JSON.stringify(r, null, 2));
});

/* ============================
   Wire up main buttons
   ============================ */
document.getElementById('acquire-lock-btn').addEventListener('click', async ()=>{ await acquireLock(); });
document.getElementById('release-lock-btn').addEventListener('click', async ()=>{ await releaseLock(); });

document.getElementById('refresh-state-btn').addEventListener('click', ()=>{ loadState(); refreshTrades(); });

/* ============================
   On load
   ============================ */
(async function init(){
  // set vibrate default
  if (!localStorage.getItem('ui-vibrate')) localStorage.setItem('ui-vibrate','true');
  document.getElementById('ui-vibrate').value = localStorage.getItem('ui-vibrate') || 'true';
  document.getElementById('ui-vibrate').addEventListener('change', (e)=>{ localStorage.setItem('ui-vibrate', e.target.value); });

  // load once and start polling
  await loadState();
  await refreshTrades();
  startPoll();
})();
</script>
</body>
</html>
