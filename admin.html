<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guardian Admin</title>
<style>
  :root{
    --bg:#071026;
    --card:#0e1a2b;
    --muted:#9aa6b2;
    --accent:#3d66ff;
    --accent-2:#2ecc71;
    --glass: rgba(255,255,255,0.03);
    --danger:#ff5c7c;
    --radius:14px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#051026 0%, #071026 60%);color:#e6eef8}
  .wrap{max-width:980px;margin:14px auto;padding:16px;}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;}
  h1{margin:0;font-size:20px}
  .status-row{display:flex;gap:10px;align-items:center}
  .pill{padding:6px 10px;border-radius:999px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);font-size:13px}
  .pill.ok{background:linear-gradient(90deg,#062b0f,#08350f);border:1px solid rgba(46,204,113,0.12);color:var(--accent-2)}
  .pill.warn{background:linear-gradient(90deg,#2b1f05,#3a2b07);color:#ffd27a}
  .pill.err{background:linear-gradient(90deg,#2b0505,#3a0707);color:var(--danger)}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border-radius:var(--radius);padding:14px;margin-top:14px;box-shadow:0 6px 20px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .big{font-size:20px;font-weight:700}
  .muted{color:var(--muted);font-size:13px;margin-top:6px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type=text]{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px;border-radius:10px;color:inherit;min-width:170px}
  button{background:var(--accent);color:white;border:none;padding:9px 12px;border-radius:10px;font-weight:600;cursor:pointer;box-shadow:0 6px 14px rgba(61,102,255,0.12)}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted)}
  button.danger{background:var(--danger)}
  small.note{display:block;color:var(--muted);font-size:12px;margin-top:8px}
  .row{display:flex;gap:10px;align-items:center}
  .stat{padding:10px;border-radius:12px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
  .stat .label{color:var(--muted);font-size:12px}
  .stat .val{font-size:18px;font-weight:700;margin-top:6px}
  .actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .small{font-size:13px;padding:8px 10px;border-radius:10px}
  footer{margin-top:18px;color:var(--muted);font-size:13px}
  @media (max-width:640px){
    .grid{grid-template-columns:1fr}
    header{flex-direction:column;align-items:flex-start;gap:8px}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Guardian — Admin</h1>
      <div class="muted">Risk automation & enforcement</div>
    </div>

    <div class="status-row">
      <div id="kiteStatus" class="pill">Kite: —</div>
      <div id="guardStatus" class="pill">Guardian: —</div>
      <div id="timeNow" class="pill">Time: --:--</div>
    </div>
  </header>

  <!-- admin controls -->
  <div class="card">
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <input id="adminToken" type="text" placeholder="ADMIN_TOKEN (paste here)" />
      <button id="btnSave" class="small">Save</button>
      <button id="btnLogin" class="small ghost">Login Zerodha</button>
      <button id="btnClear" class="small">Clear</button>
      <div style="flex:1"></div>
      <button id="btnAcquire" class="small" style="min-width:110px">Acquire Lock</button>
      <button id="btnRenew" class="small ghost" style="min-width:110px">Renew</button>
      <button id="btnRelease" class="small danger" style="min-width:110px">Release</button>
    </div>
    <small class="note">Token saved locally (only in this browser). Login Zerodha opens the auth flow — keep the window open while you trade.</small>
  </div>

  <!-- live stats grid -->
  <div class="card grid" style="margin-top:12px">
    <div class="stat">
      <div class="label">Capital @ 08:30 (snapshot)</div>
      <div id="capital915" class="val">—</div>
      <div class="muted">Base for daily limits</div>
    </div>

    <div class="stat">
      <div class="label">Current Balance (live / fallback)</div>
      <div id="live_funds" class="val">—</div>
      <div class="muted">Uses cached if offline</div>
    </div>

    <div class="stat">
      <div class="label">Live MTM (positions)</div>
      <div id="live_mtm" class="val">—</div>
      <div class="muted">Sum of open position PnL</div>
    </div>

    <div class="stat">
      <div class="label">PnL (R / UR / Total)</div>
      <div id="pnl_total" class="val">—</div>
      <div class="muted">Realised / Unrealised / Total</div>
    </div>
  </div>

  <!-- rules & enforcement -->
  <div class="card" style="margin-top:12px">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <div class="stat" style="flex:1">
        <div class="label">Max Loss (₹)</div>
        <div id="max_loss" class="val">—</div>
        <div class="muted">Max Loss % and rules</div>
      </div>
      <div class="stat" style="flex:1">
        <div class="label">Day Trip</div>
        <div id="day_trip" class="val">—</div>
        <div class="muted">Day tripped / Block new orders</div>
      </div>
    </div>

    <div class="actions">
      <button id="btnSnapshot" class="small ghost">Take 08:30 Snapshot</button>
      <button id="btnEnforce" class="small" style="background:linear-gradient(90deg,#31d08b,#2ecc71)">Enforce Now</button>
      <button id="btnResetCons" class="small ghost">Reset Consecutive</button>
    </div>
  </div>

  <footer>
    <div>Version: v2.2 &middot; Admin UI</div>
  </footer>
</div>

<script>
/* ---------- helper ---------- */
const $ = id => document.getElementById(id);
const inr = v => {
  if (v === null || v === undefined) return '—';
  try { return '₹' + Number(v).toLocaleString('en-IN', {maximumFractionDigits: 2}); } catch(e){ return v; }
};
let autoInterval = null;
let renewInterval = null;
let holdingLock = false;

/* ---------- state fetch & paint ---------- */
async function loadStateOnce() {
  try {
    const r = await fetch('/api/state');
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || 'Invalid state');
    paint(j);
    return j;
  } catch(err) {
    console.error('Failed to load state', err);
    alert('Failed to load state: ' + (err.message||err));
    $('kiteStatus').textContent = 'Kite: —';
    $('guardStatus').textContent = 'Guardian: Error';
  }
}

function paint(j) {
  const now = j.time || new Date().toLocaleTimeString();
  $('timeNow').textContent = 'Time: ' + now;
  $('kiteStatus').textContent = 'Kite: ' + (j.kite_status === 'ok' ? 'ok' : 'not logged in');
  $('kiteStatus').className = 'pill ' + (j.kite_status === 'ok' ? 'ok' : 'warn');
  $('guardStatus').textContent = 'Guardian: ' + (j.admin ? 'admin' : 'online');
  $('guardStatus').className = 'pill ' + (j.admin ? 'ok' : 'pill');

  const s = j.state || {};
  $('capital915').textContent = inr(s.capital_day_915 || 0);
  $('max_loss').textContent = inr(Math.round((s.capital_day_915 || 0) * ((s.max_loss_pct ?? 10)/100)) || 0) + ' (' + (s.max_loss_pct ?? 10) + '%)';
  $('day_trip').textContent = (s.tripped_day ? 'YES' : 'NO');

  // PnL display: realised / unrealised / total
  const r = s.realised || 0, u = s.unrealised || 0;
  $('pnl_total').textContent = inr(r) + ' / ' + inr(u) + ' / ' + inr((r + u));

  // cooldown, consecutive etc (if you want extend)
}

/* ---------- live funds & mtm ---------- */
async function loadLiveFundsAndMtm() {
  try {
    const r = await fetch('/api/kite/funds');
    const funds = await r.json();
    if (funds.ok) {
      // choose best live value (live_balance preferred)
      const av = (funds.funds?.available?.live_balance ?? funds.funds?.available?.cash ?? funds.balance ?? funds.funds?.net ?? funds.funds?.available?.cash) || 0;
      $('live_funds').textContent = inr(av);
    } else {
      $('live_funds').textContent = 'ERR: ' + (funds.error || 'no data');
    }
  } catch(e){
    console.warn('funds fail', e);
    $('live_funds').textContent = '—';
  }

  try {
    const r2 = await fetch('/api/kite/positions');
    const p = await r2.json();
    if (p.ok) {
      const mtm = p.positions?.reduce((a,b)=>a+(b.pnl || 0),0) || 0;
      $('live_mtm').textContent = inr(mtm);
    } else {
      // fallback to state
      $('live_mtm').textContent = '—';
    }
  } catch(e){
    $('live_mtm').textContent = '—';
  }
}

/* ---------- admin token handling ---------- */
function saveTokenToLocal() {
  const t = $('adminToken').value.trim();
  if (!t) { localStorage.removeItem('ADMIN_TOKEN'); alert('Token cleared'); return; }
  localStorage.setItem('ADMIN_TOKEN', t);
  alert('Token saved locally');
}
function loadTokenFromLocal() {
  $('adminToken').value = localStorage.getItem('ADMIN_TOKEN') || '';
}

/* ---------- admin actions (acquire/renew/release/status) ---------- */
async function adminAction(action, extra={}) {
  const token = localStorage.getItem('ADMIN_TOKEN') || '';
  try {
    const res = await fetch('/api/admin', {
      method: 'POST',
      headers: {
        'Content-Type':'application/json',
        'Authorization': token ? `Bearer ${token}` : ''
      },
      body: JSON.stringify({ action, ...extra })
    });
    const j = await res.json();
    if (!j.ok) throw new Error(j.error || 'failed');
    return j;
  } catch(e) {
    console.error('admin action error', action, e);
    throw e;
  }
}

async function doAcquire() {
  try {
    const j = await adminAction('acquire');
    alert('Lock acquired');
    holdingLock = true;
    $('btnAcquire').disabled = true;
    startAutoRenew();
    // refresh state to reflect admin privileges
    await loadStateOnce();
  } catch(e) {
    alert('Acquire failed: ' + (e.message||e));
  }
}

async function doRenew() {
  try {
    await adminAction('renew');
    //console.log('renew ok');
  } catch(e) {
    console.warn('renew error', e);
    // stop auto renew if fails
    stopAutoRenew();
    holdingLock = false;
    $('btnAcquire').disabled = false;
  }
}

async function doRelease() {
  try {
    await adminAction('release');
    alert('Lock released');
    holdingLock = false;
    stopAutoRenew();
    $('btnAcquire').disabled = false;
    await loadStateOnce();
  } catch(e) {
    alert('Release failed: ' + (e.message||e));
  }
}

function startAutoRenew() {
  stopAutoRenew();
  // renew every 20s (server expects periodic renew)
  renewInterval = setInterval(()=>doRenew().catch(()=>{}), 20_000);
}
function stopAutoRenew() {
  if (renewInterval) { clearInterval(renewInterval); renewInterval = null; }
}

/* ---------- helper UI actions ---------- */
async function loginZerodha() {
  // open login flow - backend should expose /api/kite/login or similar
  window.open('/api/kite/login', '_blank');
}
async function takeSnapshot() {
  try {
    const token = localStorage.getItem('ADMIN_TOKEN') || '';
    const res = await fetch('/api/admin', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization': token ? `Bearer ${token}` : '' },
      body: JSON.stringify({ action: 'snapshot' })
    });
    const j = await res.json();
    if (j.ok) alert('Snapshot taken');
    else alert('Snapshot failed: ' + (j.error||'unknown'));
    loadStateOnce();
  } catch(err){ alert('Snapshot error: ' + err.message); }
}
async function enforceNow(){
  try {
    const token = localStorage.getItem('ADMIN_TOKEN') || '';
    const res = await fetch('/api/admin', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization': token ? `Bearer ${token}` : '' },
      body: JSON.stringify({ action: 'enforce' })
    });
    const j = await res.json();
    if (j.ok) alert('Enforcement triggered');
    else alert('Enforce failed: ' + (j.error||'unknown'));
    loadStateOnce();
  } catch(e){ alert('Enforce error: ' + e.message); }
}
async function resetConsecutive(){
  try {
    const token = localStorage.getItem('ADMIN_TOKEN') || '';
    const res = await fetch('/api/admin', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization': token ? `Bearer ${token}` : '' },
      body: JSON.stringify({ action: 'reset_consecutive' })
    });
    const j = await res.json();
    if (j.ok) alert('Consecutive losses reset');
    else alert('Reset failed: ' + (j.error||'unknown'));
    loadStateOnce();
  } catch(e){ alert('Reset error: ' + e.message); }
}

/* ---------- wiring ---------- */
$('btnSave').addEventListener('click', () => { saveTokenToLocal(); loadTokenFromLocal(); });
$('btnClear').addEventListener('click', () => { localStorage.removeItem('ADMIN_TOKEN'); $('adminToken').value=''; alert('Token removed'); });
$('btnLogin').addEventListener('click', loginZerodha);
$('btnAcquire').addEventListener('click', doAcquire);
$('btnRenew').addEventListener('click', doRenew);
$('btnRelease').addEventListener('click', doRelease);
$('btnSnapshot').addEventListener('click', takeSnapshot);
$('btnEnforce').addEventListener('click', enforceNow);
$('btnResetCons').addEventListener('click', resetConsecutive);

/* ---------- auto-refresh ---------- */
async function fullRefresh() {
  await loadStateOnce();
  await loadLiveFundsAndMtm();
}
function startAutoRefresh(){
  if (autoInterval) clearInterval(autoInterval);
  autoInterval = setInterval(fullRefresh, 10_000);
  fullRefresh();
}
function stopAutoRefresh(){ if (autoInterval) clearInterval(autoInterval); }

/* ---------- init ---------- */
(function init(){
  loadTokenFromLocal();
  startAutoRefresh();
})();
</script>
</body>
</html>
