<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guardian — Admin</title>
<style>
  :root{
    --bg:#071022; --card:#0f1724; --muted:#93a0b3; --accent:#2f6df6;
    --success:#1f7a2f; --danger:#b93131; --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02); --radius:14px;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#061123 0%, #071022 40%, #05060a 100%);font-family:Inter,Arial;color:#e6eef8}
  .wrap{max-width:1100px;margin:14px auto;padding:18px;}
  header{display:flex;align-items:center;gap:18px;margin-bottom:14px}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#061428,#0f1b2b);display:grid;place-items:center;font-weight:700}
  h1{margin:0;font-size:28px}
  .meta{margin-left:auto;display:flex;gap:12px;align-items:center;color:var(--muted)}
  .card{background:linear-gradient(180deg,var(--glass),var(--glass-2));border-radius:var(--radius);padding:16px;margin:14px 0;box-shadow:0 6px 28px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
  .label{color:var(--muted);font-size:13px;margin-bottom:6px}
  .token-wrap{display:flex;align-items:center;gap:8px}
  input[type="password"], input[type="text"]{width:100%;padding:12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}
  .btn{padding:10px 18px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .btn.warn{background:var(--danger)}
  .btn.ok{background:var(--success)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:13px}
  .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .stat{padding:14px;border-radius:12px;background:rgba(0,0,0,0.18);border:1px solid rgba(255,255,255,0.02)}
  .stat h3{margin:0;font-size:12px;color:var(--muted)}
  .stat .val{font-weight:800;font-size:20px;margin-top:8px}
  .pages{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;gap:18px;padding-bottom:12px}
  .page{min-width:100%;scroll-snap-align:center}
  .pager-nav{display:flex;gap:8px;justify-content:center;margin-top:8px}
  .small{font-size:13px;padding:8px 12px;border-radius:8px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:rgba(0,0,0,0.78);color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.6);display:none}
  .toast.show{display:block}
  .input-eye{cursor:pointer;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">G</div>
    <div>
      <h1>Guardian — Admin</h1>
      <div class="muted">Risk automation & enforcement</div>
    </div>
    <div class="meta">
      <div id="kite_status" class="muted">Kite: —</div>
      <div id="guard_status" class="muted">Guardian: —</div>
      <div id="now" class="muted">--:--:--</div>
    </div>
  </header>

  <section class="card">
    <div class="label">Admin token (read-only unless saved)</div>
    <div class="token-wrap">
      <input id="admin_token" type="password" placeholder="Enter admin token" aria-label="Admin token" />
      <button id="toggle_token" class="input-eye" title="Show / Hide token">Show</button>
      <button id="save_token" class="btn">Save</button>
      <button id="clear_token" class="btn ghost">Clear</button>
    </div>
    <div class="muted" style="margin-top:8px">Token is stored locally only and will not be displayed anywhere (we show ****** only).</div>

    <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
      <button id="login_zerodha" class="btn ghost small">Login Zerodha</button>
      <button id="refresh_state" class="btn ghost small">Refresh</button>
      <div style="margin-left:auto" class="muted">Admin controls unlock after saving token</div>
    </div>

    <hr style="border:none;height:12px;background:transparent">

    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <button id="enforce_btn" class="btn ok">Enforce Now</button>
      <button id="kill_btn" class="btn warn">Kill (Close)</button>
      <label style="margin-left:8px" class="muted">Cancel All</label>
      <input id="cancel_checkbox" type="checkbox" style="transform:scale(1.2);margin-left:6px" />
      <label style="margin-left:auto" class="muted"><input id="allow_new_checkbox" type="checkbox" /> Allow New Orders</label>
    </div>

    <div style="margin-top:10px;color:#f7c6c6" id="last_action_msg"></div>
  </section>

  <div class="pages" id="pages">
    <div class="page card">
      <h2 style="margin-top:0">Live overview <button id="refresh_stats" class="btn ghost small" style="float:right">Refresh</button></h2>
      <div class="stats" id="stats_grid">
        <div class="stat">
          <h3>Capital @ 09:15</h3>
          <div class="val" id="capital915">—</div>
          <div class="muted">Base for daily limits</div>
        </div>
        <div class="stat">
          <h3>Current Balance (live/fallback)</h3>
          <div class="val" id="live_funds">—</div>
          <div class="muted">Uses cached if offline</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
function $(id){ return document.getElementById(id); }
function showToast(msg,t=3000){ const tEl=$('toast'); tEl.textContent=msg; tEl.classList.add('show'); setTimeout(()=>tEl.classList.remove('show'),t); }
function nowTime(){ return new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata',hour12:false}); }

const tokenInput = $('admin_token');
const toggleBtn = $('toggle_token');
const saveBtn = $('save_token');
const clearBtn = $('clear_token');

function getStoredToken(){ return localStorage.getItem('admin_token') || ''; }
function setStoredToken(v){ if(v) localStorage.setItem('admin_token', v); else localStorage.removeItem('admin_token'); }

function applyTokenUI(){
  const t = getStoredToken();
  if(t){
    tokenInput.value = '********';
    tokenInput.dataset.real = '1';
  } else {
    tokenInput.value = '';
    tokenInput.dataset.real = '0';
  }
}
applyTokenUI();

toggleBtn.addEventListener('click', ()=>{
  if(tokenInput.type==='password'){ tokenInput.type='text'; toggleBtn.textContent='Hide'; }
  else { tokenInput.type='password'; toggleBtn.textContent='Show'; }
});
saveBtn.addEventListener('click', ()=>{
  const v=tokenInput.value.trim();
  if(!v){ showToast('Enter token first'); return; }
  setStoredToken(v); applyTokenUI(); showToast('Token saved');
});
clearBtn.addEventListener('click', ()=>{
  setStoredToken(''); applyTokenUI(); showToast('Token cleared');
});

function authHeader(){
  const t=getStoredToken();
  if(!t) return {};
  const headerVal = t.startsWith('Bearer ') ? t : 'Bearer ' + t;
  return { 'Authorization': headerVal };
}

async function fetchState(){
  try{
    const r = await fetch('/api/state');
    const j = await r.json();
    if(!j.ok) return;
    $('kite_status').textContent = 'Kite: ' + (j.kite_status || '—');
    $('guard_status').textContent = j.admin ? 'admin' : 'readonly';
    $('capital915').textContent = '₹' + (j.state?.capital_day_915 || 0).toLocaleString('en-IN');
    $('live_funds').textContent = '₹' + (j.state?.live_funds || 0).toLocaleString('en-IN');
  }catch(e){ console.error(e); }
}

async function postAction(path, body = {}){
  const headers = { 'Content-Type': 'application/json', ...authHeader() };
  const r = await fetch(path, { method:'POST', headers, body: JSON.stringify(body) });
  const j = await r.json().catch(()=>({ ok:false }));
  $('last_action_msg').textContent = (j.ok?'OK: ':'Error: ') + (j.error||'');
  return j;
}

$('enforce_btn').addEventListener('click', ()=> postAction('/api/admin/enforce',{allow_new:$('allow_new_checkbox').checked}));
$('kill_btn').addEventListener('click', ()=> postAction('/api/admin/kill'));
$('refresh_state').addEventListener('click', fetchState);

/* --- Updated Zerodha login handler --- */
$('login_zerodha').addEventListener('click', async ()=>{
  $('last_action_msg').textContent = 'Zerodha login...';
  const headers = { 'Content-Type':'application/json', ...authHeader() };
  async function handleResponse(r){
    if (r.redirected) { window.location.href = r.url; return; }
    const text = await r.text().catch(()=>''), j = text ? JSON.parse(text) : {};
    if (j.login_url || j.url){ window.open(j.login_url || j.url, '_blank'); return; }
    if (j.ok){ showToast('Zerodha: ok'); return; }
    const err = j.error || text || 'Unknown error';
    $('last_action_msg').textContent = 'Login: ' + err;
    showToast('Zerodha login failed');
  }
  try{
    let resp = await fetch('/api/kite/login', { method:'GET', headers });
    if (resp.status === 405 || resp.status === 404)
      resp = await fetch('/api/kite/login', { method:'POST', headers, body: '{}' });
    await handleResponse(resp);
  }catch(e){ showToast('Login error: '+e.message); }
});

window.addEventListener('load', ()=>{ fetchState(); setInterval(()=> $('now').textContent = nowTime(),1000); });
</script>
</body>
</html>
