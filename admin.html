<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guardian — Admin</title>
<style>
  :root{
    --bg:#0b0d14; --card:#121a2d; --line:#20283a; --fg:#eef3ff; --muted:#98a3b3;
    --accent:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --r:12px; --pad:12px; --gap:12px;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071022,#05060a);font-family:Inter,Arial;color:var(--fg)}
  .wrap{max-width:1100px;margin:12px auto;padding:16px}
  header{display:flex;align-items:center;gap:16px;margin-bottom:14px}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#061428,#0f1b2b);display:grid;place-items:center;font-weight:700}
  h1{margin:0;font-size:26px}
  .meta{margin-left:auto;display:flex;gap:12px;align-items:center;color:var(--muted)}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 8px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
  .label{color:var(--muted);font-size:13px;margin-bottom:8px}
  input[type="password"], input[type="text"], input[type="number"]{width:100%;padding:12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}
  .btn{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .btn.ok{background:linear-gradient(180deg,#166534,#115c2e)}
  .btn.warn{background:linear-gradient(180deg,#7c2d12,#6b2109)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:13px}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media (max-width:860px){.stats{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:520px){.stats{grid-template-columns:1fr}}
  .stat{padding:12px;border-radius:12px;background:rgba(0,0,0,0.14);border:1px solid rgba(255,255,255,0.02)}
  .stat h3{margin:0;font-size:12px;color:var(--muted)}
  .stat .val{font-weight:800;font-size:20px;margin-top:8px}
  pre{color:#ffdede;background:rgba(0,0,0,0.15);padding:12px;border-radius:8px;max-height:240px;overflow:auto}
  .small{font-size:13px;padding:8px 12px;border-radius:8px}
  .cards-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:860px){.cards-row{grid-template-columns:1fr}}
  .muted-small{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">G</div>
    <div>
      <h1>Guardian — Admin</h1>
      <div class="muted-small">Risk automation & enforcement</div>
    </div>
    <div class="meta">
      <div id="kite_status" class="muted-small">Kite: —</div>
      <div id="guard_status" class="muted-small">Guardian: —</div>
      <div id="now" class="muted-small">--:--:--</div>
    </div>
  </header>

  <!-- ADMIN TOKEN CARD -->
  <section class="card">
    <div style="display:flex;flex-direction:column;gap:10px">
      <div>
        <div class="label">Admin token (stored locally; masked)</div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="admin_token" type="password" placeholder="Enter admin token" />
          <button id="save_token" class="btn">Save</button>
          <button id="clear_token" class="btn ghost">Clear</button>
          <button id="toggle_token" class="btn ghost">Show</button>
        </div>
        <div class="muted-small">Saving token unlocks admin controls. The token will not be printed anywhere (we show masked).</div>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <button id="login_zerodha" class="btn ghost small">Login Zerodha</button>
        <button id="refresh_state" class="btn ghost small">Refresh</button>
        <div style="margin-left:auto" class="muted-small">Admin controls unlock after saving token.</div>
      </div>
    </div>
  </section>

  <!-- KPI CARD -->
  <section class="card">
    <h3 style="margin-top:0">Live overview <button id="refresh_stats" class="btn ghost small" style="float:right">Refresh</button></h3>
    <div class="stats" id="stats">
      <div class="stat">
        <h3>Capital @ 09:15</h3>
        <div class="val" id="capital915">—</div>
        <div class="muted-small">Base for daily limits</div>
        <div style="margin-top:8px">
          <label class="muted-small">Admin override capital</label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input id="override_capital" type="number" placeholder="Enter capital override (₹)" />
            <button id="apply_cap_override" class="btn small">Apply</button>
            <button id="clear_cap_override" class="btn ghost small">Clear</button>
          </div>
          <div class="muted-small" id="cap_override_note">No override active</div>
        </div>
      </div>

      <div class="stat">
        <h3>Current Balance (live/fallback)</h3>
        <div class="val" id="live_funds">—</div>
        <div class="muted-small">Uses cached if offline</div>
      </div>

      <div class="stat">
        <h3>Live MTM</h3>
        <div class="val" id="live_mtm">—</div>
        <div class="muted-small">Sum of position PnL</div>
      </div>

      <div class="stat">
        <h3>PnL (R/UR/Total)</h3>
        <div class="val" id="pnl_info">—</div>
        <div class="muted-small">Realtime</div>
      </div>

      <div class="stat">
        <h3>Max Loss (₹)</h3>
        <div class="val" id="max_loss">—</div>
        <div class="muted-small" id="max_loss_pct">—</div>
      </div>

      <div class="stat">
        <h3>Active Loss Floor (₹)</h3>
        <div class="val" id="active_floor">—</div>
        <div class="muted-small">Trail rules</div>
      </div>
    </div>
  </section>

  <!-- RULES + ACTIONS -->
  <div class="cards-row">
    <section class="card" id="rules_card">
      <h3 style="margin-top:0">Rules (editable by admin)</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Max Loss %</label>
          <input id="rule_max_loss_pct" type="number" placeholder="10" />
        </div>
        <div>
          <label>Trailing step (₹)</label>
          <input id="rule_trail_step" type="number" placeholder="5000" />
        </div>
        <div>
          <label>Cooldown (min)</label>
          <input id="rule_cooldown_min" type="number" placeholder="15" />
        </div>
        <div>
          <label>Max consecutive losses</label>
          <input id="rule_max_consec" type="number" placeholder="3" />
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="save_rules" class="btn">Save Rules</button>
        <button id="take_snapshot" class="btn ghost">Take 08:30 Snapshot</button>
        <button id="reset_consec" class="btn ghost">Reset Consecutive</button>
      </div>
    </section>

    <section class="card" id="actions_card">
      <h3 style="margin-top:0">Admin Actions</h3>
      <div class="row" style="margin-top:8px">
        <button id="acquire_lock" class="btn ghost">Acquire Lock</button>
        <button id="release_lock" class="btn ghost">Release Lock</button>
        <button id="enforce_now" class="btn ok">Enforce Now</button>
        <button id="kill_close" class="btn warn">Kill (Close)</button>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
        <button id="cancel_all" class="btn ghost">Cancel All</button>
        <label style="margin-left:8px"><input id="allow_new" type="checkbox" /> Allow New Orders</label>
      </div>

      <div style="margin-top:12px;color:#f7c6c6" id="action_status">—</div>
    </section>
  </div>

  <!-- debug -->
  <section class="card">
    <h3 style="margin-top:0">Last responses & debug</h3>
    <div class="muted-small">Server returns are shown here; keep open to confirm actions and generate logs.</div>
    <pre id="raw_responses">—</pre>
  </section>
</div>

<script>
/* ---------- helpers ---------- */
const $ = id => document.getElementById(id);
function safeLog(txt){
  const pre = $('raw_responses');
  pre.textContent = (txt ? (txt + '\n\n') : '') + pre.textContent;
}
/* token storage */
function getToken(){ return localStorage.getItem('ADMIN_TOKEN') || ''; }
function setToken(v){ if(!v) localStorage.removeItem('ADMIN_TOKEN'); else localStorage.setItem('ADMIN_TOKEN', v); }
/* capital override storage */
function getCapOverride(){ const v = localStorage.getItem('ADMIN_OVERRIDE_CAP'); return v ? Number(v) : null; }
function setCapOverride(v){ if(v==null) localStorage.removeItem('ADMIN_OVERRIDE_CAP'); else localStorage.setItem('ADMIN_OVERRIDE_CAP', String(v)); }

/* inject Authorization header if token present */
function authHeader(){ const t = getToken(); return t ? { 'Authorization': 'Bearer ' + t } : {}; }

/* convenience: send POST and return parsed JSON + status */
async function fetchPost(url, body=null){
  const headers = { ...authHeader() };
  if(body!=null) headers['Content-Type'] = 'application/json';
  try{
    const res = await fetch(url, { method: 'POST', headers, body: body ? JSON.stringify(body) : undefined });
    const text = await res.text();
    try{ return {status: res.status, json: JSON.parse(text)}; } catch(e){ return {status: res.status, text}; }
  }catch(e){ return {status:0, error: e.message}; }
}
async function fetchGet(url){
  try{
    const res = await fetch(url, { method: 'GET', headers: authHeader() });
    const text = await res.text();
    try{ return {status: res.status, json: JSON.parse(text)}; } catch(e){ return {status: res.status, text}; }
  }catch(e){ return {status:0, error: e.message}; }
}

/* ---------- login fallback (try POST, if 405 try GET) ---------- */
async function doZerodhaLogin(){
  safeLog('Zerodha login: trying POST /api/kite/login');
  const attemptPost = await fetchPost('/api/kite/login', {});
  safeLog('/api/kite/login (POST) => ' + JSON.stringify(attemptPost));
  if(attemptPost.status === 405){
    safeLog('POST returned 405 — falling back to GET /api/kite/login');
    const attemptGet = await fetchGet('/api/kite/login');
    safeLog('/api/kite/login (GET) => ' + JSON.stringify(attemptGet));
    return attemptGet.json || attemptGet.text || attemptGet;
  } else {
    return attemptPost.json || attemptPost.text || attemptPost;
  }
}

/* ---------- handlers ---------- */
$('save_token').addEventListener('click', ()=>{
  const v = $('admin_token').value.trim();
  if(!v){ alert('Enter admin token'); return; }
  setToken(v);
  $('admin_token').value = '********';
  setAdminUI(true);
  safeLog('Admin token saved (masked locally)');
  fetchState();
});
$('clear_token').addEventListener('click', ()=>{
  setToken('');
  $('admin_token').value = '';
  setAdminUI(false);
  safeLog('Admin token cleared');
});
$('toggle_token').addEventListener('click', ()=>{
  const cur = $('admin_token');
  if(cur.type === 'password'){ cur.type = 'text'; $('toggle_token').textContent = 'Hide'; }
  else { cur.type = 'password'; $('toggle_token').textContent = 'Show'; }
});

/* login zerodha button tries multiple methods */
$('login_zerodha').addEventListener('click', async ()=>{
  $('action_status').textContent = 'Zerodha login...';
  const res = await doZerodhaLogin();
  safeLog('Zerodha login final => ' + JSON.stringify(res));
  if(res && res.ok) { $('action_status').textContent = 'Zerodha login OK'; }
  else { $('action_status').textContent = 'Zerodha login returned: ' + (res.error || JSON.stringify(res)); }
  setTimeout(()=> fetchState(), 800);
});

/* refresh */
$('refresh_state').addEventListener('click', ()=> fetchState());
$('refresh_stats').addEventListener('click', ()=> fetchState());

/* actions (POST) */
async function postAction(path, body = {}) {
  $('action_status').textContent = 'Posting ' + path + '...';
  const r = await fetchPost(path, body);
  safeLog(path + ' => ' + JSON.stringify(r));
  if(r && r.json && r.json.ok) $('action_status').textContent = 'Success: ' + path;
  else $('action_status').textContent = 'Failed: ' + (r.json?.error || r.text || r.error || JSON.stringify(r));
  setTimeout(()=> fetchState(), 700);
  return r;
}

$('enforce_now').addEventListener('click', ()=> postAction('/api/admin/enforce', { now: true }));
$('kill_close').addEventListener('click', ()=> {
  if(!confirm('Kill (close) — Are you sure?')) return;
  postAction('/api/admin/kill', {});
});
$('cancel_all').addEventListener('click', ()=> postAction('/api/admin/cancel', { cancel_all: true }));
$('acquire_lock').addEventListener('click', ()=> postAction('/api/admin/lock', {}));
$('release_lock').addEventListener('click', ()=> postAction('/api/admin/release', {}));
$('take_snapshot').addEventListener('click', ()=> postAction('/api/admin/snapshot', {}));
$('reset_consec').addEventListener('click', ()=> postAction('/api/admin/reset-consecutive', {}));
$('save_rules').addEventListener('click', async ()=>{
  const payload = {
    max_loss_pct: Number($('rule_max_loss_pct').value || 0),
    trail_step_profit: Number($('rule_trail_step').value || 0),
    cooldown_min: Number($('rule_cooldown_min').value || 0),
    max_consecutive_losses: Number($('rule_max_consec').value || 0)
  };
  await postAction('/api/admin/rules-set', payload);
});

/* ---------- Admin capital override ---------- */
$('apply_cap_override').addEventListener('click', async ()=>{
  const v = Number($('override_capital').value);
  if(!v || isNaN(v)) { alert('Enter numeric capital'); return; }
  // store locally
  setCapOverride(v);
  $('cap_override_note').textContent = 'Override active: ' + formatINR(v) + ' (attempting server update...)';
  safeLog('Local capital override set: ' + v);

  // try multiple likely endpoints on server (best-effort)
  const candidates = [
    '/api/admin/capital-set',
    '/api/admin/override-capital',
    '/api/admin/set-capital',
    '/api/admin/capital'
  ];
  for(const ep of candidates){
    const r = await fetchPost(ep, { capital_day_915: v });
    safeLog(ep + ' => ' + JSON.stringify(r));
    if(r && r.json && r.json.ok){ $('cap_override_note').textContent = 'Server acknowledged override via ' + ep; break; }
    if(r && r.status === 405){ $('cap_override_note').textContent = 'Server ' + ep + ' returned 405; trying next'; continue; }
  }
  // re-render KPIs using override locally for immediate effect
  renderOverride();
});

$('clear_cap_override').addEventListener('click', ()=>{
  setCapOverride(null);
  $('cap_override_note').textContent = 'No override active';
  safeLog('Capital override cleared');
  fetchState();
});

/* ---------- read state & paint ---------- */
function setText(id, txt){ const el = $(id); if(!el) return; el.textContent = txt; }

async function fetchState(){
  try{
    // include admin header when token exists (safe)
    const headers = authHeader();
    const res = await fetch('/api/state?t=' + Date.now(), { headers });
    const j = await res.json();
    safeLog('/api/state => ' + JSON.stringify(j));
    if(!j.ok) { setText('action_status','/api/state returned error'); return; }
    // top meta
    setText('kite_status', 'Kite: ' + (j.kite_status || '—'));
    setText('guard_status', (j.admin ? 'admin' : 'read-only'));
    setText('now', new Date().toLocaleTimeString('en-IN',{hour12:false}));

    const s = j.state || {};
    // fill UI inputs if empty (do not overwrite manual edits)
    if($('rule_max_loss_pct').value === '') $('rule_max_loss_pct').value = s.max_loss_pct ?? '';
    if($('rule_trail_step').value === '') $('rule_trail_step').value = s.trail_step_profit ?? '';
    if($('rule_cooldown_min').value === '') $('rule_cooldown_min').value = s.cooldown_min ?? '';
    if($('rule_max_consec').value === '') $('rule_max_consec').value = s.max_consecutive_losses ?? '';

    // basic state fields
    setText('pnl_info', formatINR(s.realised ?? 0) + ' / ' + formatINR(s.unrealised ?? 0) + ' / ' + formatINR((Number(s.realised||0) + Number(s.unrealised||0))));
    setText('max_loss', formatINR(Math.round((s.capital_day_915 || 0) * ((s.max_loss_pct||10)/100))));
    setText('max_loss_pct', 'Max Loss %: ' + (s.max_loss_pct ?? 10) + '%');
    setText('active_floor', formatINR(s.active_floor || 0));

    // funds endpoint
    try {
      const fr = await fetch('/api/kite/funds?t=' + Date.now(), { headers });
      const fj = await fr.json();
      safeLog('/api/kite/funds => ' + JSON.stringify(fj));
      let av = 0;
      if(fj && fj.ok){
        av = Number(fj.balance ?? fj.funds?.available?.live_balance ?? fj.funds?.available?.cash ?? fj.funds?.cash ?? 0);
      } else if(s.current_balance) {
        av = s.current_balance;
      }
      setText('live_funds', formatINR(av));
    } catch(e){
      safeLog('/api/kite/funds ERROR: ' + e.message);
      setText('live_funds', 'ERR');
    }

    // positions for live MTM
    try {
      const pr = await fetch('/api/kite/positions?t=' + Date.now(), { headers });
      const pj = await pr.json();
      safeLog('/api/kite/positions => ' + JSON.stringify(pj));
      if(pj && pj.ok && Array.isArray(pj.positions?.net)){
        const mtm = pj.positions.net.reduce((acc,p) => acc + Number(p.pnl || 0), 0);
        setText('live_mtm', formatINR(mtm));
      } else {
        setText('live_mtm', formatINR(s.unrealised || 0));
      }
    } catch(e){
      safeLog('/api/kite/positions ERROR: ' + e.message);
      setText('live_mtm', formatINR(s.unrealised || 0));
    }

    // apply capital override if present (local)
    renderOverride();
  }catch(e){
    safeLog('/api/state ERROR: ' + e.message);
  }
}

/* ---------- override render ---------- */
function renderOverride(){
  const override = getCapOverride();
  if(override != null){
    $('capital915').textContent = formatINR(override) + ' (OVERRIDE)';
    $('cap_override_note').textContent = 'Override active: ' + formatINR(override);
  } else {
    // if no override, show server value from latest state (call /api/state again for guarantee)
    // fallback: read stored displayed value, but best is to call state
    (async ()=> {
      try{
        const res = await fetch('/api/state?t=' + Date.now(), { headers: authHeader() });
        const j = await res.json();
        const s = j.state || {};
        $('capital915').textContent = formatINR(s.capital_day_915 || 0);
        $('cap_override_note').textContent = 'No override active';
      }catch(e){
        $('cap_override_note').textContent = 'No override active';
      }
    })();
  }
}

/* ---------- utilities ---------- */
function formatINR(v){ if(v==null || isNaN(Number(v))) return '—'; return '₹' + Number(v).toLocaleString('en-IN',{maximumFractionDigits:0}); }

/* ---------- init ---------- */
(function init(){
  // UI state depending on whether token is present
  if(getToken()) {
    $('admin_token').value = '********';
    setAdminUI(true);
  } else setAdminUI(false);

  fetchState(); // initial
  setInterval(fetchState, 10000);
})();

/* enable/disable admin controls (only UI-level) */
function setAdminUI(enabled){
  const adminOnlyEls = document.querySelectorAll('[data-admin-only], #rules_card input, #rules_card button, #actions_card button');
  if(enabled){
    adminOnlyEls.forEach(e=>e.removeAttribute('disabled'));
    document.getElementById('rules_card').style.opacity = '1';
    document.getElementById('actions_card').style.opacity = '1';
  } else {
    adminOnlyEls.forEach(e=>{ e.setAttribute('disabled','disabled'); });
    document.getElementById('rules_card').style.opacity = '0.6';
    document.getElementById('actions_card').style.opacity = '0.6';
  }
}

/* ---------- fallback fetch helpers for GET version if needed (not used mostly) ---------- */
async function tryGet(path){
  try{
    const r = await fetch(path, { method:'GET', headers: authHeader() });
    const txt = await r.text();
    try{ return JSON.parse(txt); } catch(e){ return { ok:false, text:txt }; }
  }catch(e){ return { ok:false, error: e.message }; }
}
</script>
</body>
</html>
