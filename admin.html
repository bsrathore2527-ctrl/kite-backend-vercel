<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guardian — Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#071026; --panel:#0b1724; --muted:#9aa6b2; --accent:#2b6cf6; --ok:#1f8a37; --danger:#a8302e; }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:
    radial-gradient(900px 300px at 5% 10%, rgba(30,40,60,0.30), transparent),
    radial-gradient(600px 240px at 95% 90%, rgba(20,30,50,0.18), transparent),
    var(--bg); color:#e7f7ff; -webkit-font-smoothing:antialiased}
  .wrap{max-width:980px;margin:18px auto;padding:14px}
  header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#071226,#0d2138);display:flex;align-items:center;justify-content:center;font-weight:800;color:#cfe8ff;font-size:20px}
  h1{margin:0;font-size:26px}
  .meta{margin-left:auto;color:var(--muted);display:flex;gap:16px;font-weight:600;align-items:center}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:14px;padding:18px;margin-bottom:16px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 10px 40px rgba(2,6,23,0.6)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input[type="password"], input[type="text"]{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:12px 14px;border-radius:10px;color:#e7f7ff;min-width:260px}
  button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn-primary{background:linear-gradient(90deg,var(--accent),#1b9cff);color:white;box-shadow:0 6px 18px rgba(43,108,246,0.12)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#bcd6ff;padding:10px 14px;border-radius:10px}
  .btn-green{background:linear-gradient(90deg,#1f8a37,#0f6f2f);color:white}
  .btn-danger{background:var(--danger);color:white}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  .two-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .card{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.03);min-height:84px}
  .card h3{margin:0;font-size:14px;color:var(--muted);font-weight:600}
  .card .big{font-size:22px;font-weight:800;margin-top:8px}
  .muted{color:var(--muted)}
  .status{margin-top:10px;padding:10px;border-radius:8px;background:rgba(0,0,0,0.25);color:#ffdede;display:none}
  .debug{margin-top:10px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);color:#bcd6ff;display:none;white-space:pre-wrap;font-size:12px}
  label{display:inline-flex;align-items:center;gap:8px}
  @media (max-width:720px){
    .two-grid{grid-template-columns:1fr}
    header{flex-direction:column;align-items:flex-start}
    .meta{margin-left:0}
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">G</div>
    <div>
      <h1>Guardian — Admin</h1>
      <div class="muted">Risk automation & enforcement</div>
    </div>
    <div class="meta">
      <div id="kite_status">Kite: —</div>
      <div id="guardian_status">Guardian: —</div>
      <div id="time_now">--:--:--</div>
    </div>
  </header>

  <!-- Admin controls -->
  <section class="panel">
    <div class="row" style="align-items:center">
      <input id="admin_token" type="password" placeholder="Enter admin token" />
      <button id="save_token" class="btn-primary">Save</button>
      <button id="login_kite" class="btn-ghost" title="Login Zerodha">Login Zerodha</button>
      <button id="clear_token" class="btn-ghost">Clear</button>
      <button id="refresh_state" class="btn-ghost">Refresh</button>
    </div>

    <div class="controls">
      <button id="enforce_btn" class="btn-green" disabled>Enforce Now</button>
      <button id="kill_btn" class="btn-danger" disabled>Kill (Close)</button>
      <button id="cancel_btn" class="btn-ghost" disabled>Cancel All</button>
      <label class="muted"><input id="allow_new" type="checkbox" disabled /> Allow New Orders</label>
      <button id="acquire_btn" class="btn-ghost" style="display:none">Acquire Lock</button> <!-- hidden as requested -->
      <button id="release_btn" class="btn-ghost" style="display:none">Release Lock</button>
    </div>

    <div id="action_status" class="status">Action status</div>
    <div id="debug" class="debug"></div>
  </section>

  <!-- Live overview -->
  <section class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">Live overview</h2>
      <button id="refresh_cards" class="btn-ghost">Refresh</button>
    </div>

    <div class="two-grid" style="margin-top:12px">
      <div class="card">
        <h3>Capital @ 09:15</h3>
        <div class="big" id="capital_915">—</div>
        <small class="muted">Base for daily limits</small>
      </div>

      <div class="card">
        <h3>Current Balance (live/fallback)</h3>
        <div class="big" id="live_balance">—</div>
        <small class="muted">Uses cached if offline</small>
      </div>

      <div class="card">
        <h3>Live MTM</h3>
        <div class="big" id="live_mtm">—</div>
        <small class="muted">Sum of position PnL</small>
      </div>

      <div class="card">
        <h3>PnL (R/UR/Total)</h3>
        <div class="big" id="pnl_text">—</div>
        <small class="muted">Realised / Unrealised / Total</small>
      </div>

      <div class="card">
        <h3>Max Loss (₹)</h3>
        <div class="big" id="max_loss">—</div>
        <small id="max_loss_pct" class="muted">Max Loss %: —</small>
      </div>

      <div class="card">
        <h3>Active Loss Floor (₹)</h3>
        <div class="big" id="active_floor">—</div>
        <small class="muted">Next trail: —</small>
      </div>
    </div>
  </section>

</div>

<script>
(async function(){
  // API endpoints — adjust if your files are in different paths
  const API = {
    state: '/api/state',
    funds: '/api/kite/funds',
    kiteLogin: '/api/kite/login',   // UI will try POST then GET
    enforce: '/api/enforce',        // server handler seems to expect GET (we try GET then POST)
    kill: '/api/admin/kill',
    cancel: '/api/admin/cancel'
  };

  // elements
  const el = id => document.getElementById(id);
  const tokenInput = el('admin_token');
  const saveBtn = el('save_token');
  const loginBtn = el('login_kite');
  const clearBtn = el('clear_token');
  const refreshBtn = el('refresh_state');
  const enforceBtn = el('enforce_btn');
  const killBtn = el('kill_btn');
  const cancelBtn = el('cancel_btn');
  const allowNewCheckbox = el('allow_new');
  const refreshCardsBtn = el('refresh_cards');
  const actionStatus = el('action_status');
  const debugBox = el('debug');

  function setStatus(msg, isError=false){
    if (!actionStatus) return;
    actionStatus.style.display = 'block';
    actionStatus.style.background = isError ? 'rgba(255,30,30,0.06)' : 'rgba(50,200,100,0.06)';
    actionStatus.style.color = isError ? '#ffdede' : '#d1ffd6';
    actionStatus.textContent = msg;
    setTimeout(()=>actionStatus.style.display='none', 8000);
  }
  function debug(msg){ debugBox.style.display='block'; debugBox.textContent = msg; }

  // token management
  function savedToken(){ return localStorage.getItem('ADMIN_TOKEN') || ''; }
  function setSavedToken(v){ if (v) localStorage.setItem('ADMIN_TOKEN', v); else localStorage.removeItem('ADMIN_TOKEN'); }
  function authHeader(){ const t = savedToken(); return t ? { 'Authorization': t.startsWith('Bearer ') ? t : 'Bearer ' + t } : {}; }

  // mask token if already saved
  tokenInput.value = savedToken() ? '********' : '';
  let tokenEdited = false;
  tokenInput.addEventListener('input', ()=> { tokenEdited = true; });

  saveBtn.onclick = ()=>{
    if (!tokenEdited && savedToken()){
      setStatus('Token already saved.');
      return;
    }
    if (!tokenInput.value){
      setStatus('No token entered', true);
      return;
    }
    setSavedToken(tokenInput.value);
    tokenEdited = false;
    tokenInput.value = '********';
    updateButtons();
    setStatus('Admin token saved.');
  };

  clearBtn.onclick = ()=>{
    setSavedToken('');
    tokenInput.value = '';
    tokenEdited = false;
    updateButtons();
    setStatus('Admin token cleared.');
  };

  function updateButtons(){
    const has = !!savedToken();
    [enforceBtn, killBtn, cancelBtn, allowNewCheckbox, loginBtn].forEach(b=>{
      if (b) b.disabled = !has;
    });
  }
  updateButtons();

  // helpers
  function fmtINR(v){
    if (v === null || v === undefined) return '—';
    const n = Number(v);
    if (Number.isNaN(n)) return '—';
    // show 1 decimal if fractional, else no decimal
    const opts = (Math.abs(n) % 1 !== 0) ? {maximumFractionDigits:2} : {maximumFractionDigits:0};
    return '₹' + n.toLocaleString('en-IN', opts);
  }
  function setText(id, txt){ const e = el(id); if (e) e.textContent = txt; }

  // fetch with fallback for method-not-allowed scenarios
  async function fetchWithFallback(url, { headers = {}, body = null } = {}, methods = ['POST','GET']){
    const combined = { ...headers, ...authHeader() };
    let last = null;
    for (const method of methods){
      try {
        const res = await fetch(url, { method, headers: { 'Content-Type':'application/json', ...combined }, body: body ? JSON.stringify(body) : null });
        let txt = await res.text();
        let json;
        try{ json = JSON.parse(txt); } catch(e){ json = { ok:false, error: txt || 'Invalid JSON' }; }
        if (res.status === 405) { last = { status:405, body: json }; continue; }
        return { status: res.status, body: json };
      } catch (err){
        last = { status: 0, body: { ok:false, error: String(err) } };
      }
    }
    return last;
  }

  // load state and funds
  async function loadState(){
    try {
      const s = await fetch(API.state);
      const j = await s.json();
      if (!j.ok) throw new Error(j.error || 'state error');
      const st = j.state || {};
      setText('capital_915', fmtINR(st.capital_day_915 ?? 0));
      setText('max_loss', fmtINR( (st.capital_day_915 || 0) * (st.max_loss_pct ?? 10) / 100 ));
      setText('max_loss_pct', 'Max Loss %: ' + ((st.max_loss_pct ?? 10) + '%'));
      setText('active_floor', fmtINR(st.active_loss_floor ?? 0));
      setText('pnl_text', `${fmtINR(st.realised ?? 0)} / ${fmtINR(st.unrealised ?? 0)} / ${fmtINR((st.realised??0)+(st.unrealised??0))}`);
      setText('guardian_status', j.admin ? 'admin' : '—');
      setText('time_now', j.time || '--:--:--');
      // cached balance fallback
      if (st.current_balance != null) setText('live_balance', fmtINR(st.current_balance));
    } catch (e){
      setStatus('Failed to load state: ' + (e.message || e), true);
    }

    // funds
    try {
      const r = await fetch(API.funds, { headers: {...authHeader()} });
      const jf = await r.json();
      if (!jf.ok) {
        setText('live_balance', jf.error ? 'ERR: ' + jf.error : '—');
      } else {
        const av = Number(
          jf.funds?.available?.live_balance ??
          jf.funds?.net ??
          jf.balance ??
          jf.funds?.available?.cash ??
          jf.funds?.cash ??
          0
        );
        if (!Number.isNaN(av)) setText('live_balance', fmtINR(av));
      }
    } catch (e){
      // keep cached value if any
    }
  }

  // actions
  loginBtn.onclick = async ()=>{
    loginBtn.disabled = true;
    try {
      const r = await fetchWithFallback(API.kiteLogin, {}, ['POST','GET']);
      debug('Login returned: ' + JSON.stringify(r.body));
      if (!r.body.ok) setStatus('Zerodha login returned: ' + JSON.stringify(r.body), true);
      else setStatus('Zerodha login OK');
      await loadState();
    } finally { loginBtn.disabled = false; }
  };

  enforceBtn.onclick = async ()=>{
    enforceBtn.disabled = true;
    try {
      // enforce endpoint likely supports GET, try GET then POST
      const r = await fetchWithFallback(API.enforce, {}, ['GET','POST']);
      debug('Enforce returned: ' + JSON.stringify(r.body));
      if (!r.body.ok) setStatus('Enforce failed: ' + JSON.stringify(r.body), true);
      else setStatus('Enforce done: ' + JSON.stringify(r.body));
      await loadState();
    } finally { enforceBtn.disabled = false; }
  };

  killBtn.onclick = async ()=>{
    killBtn.disabled = true;
    try {
      const r = await fetchWithFallback(API.kill, {}, ['POST','GET']);
      debug('Kill returned: ' + JSON.stringify(r.body));
      if (!r.body.ok) setStatus('Kill failed: ' + JSON.stringify(r.body), true);
      else setStatus('Kill executed');
      await loadState();
    } finally { killBtn.disabled = false; }
  };

  cancelBtn.onclick = async ()=>{
    cancelBtn.disabled = true;
    try {
      const r = await fetchWithFallback(API.cancel, {}, ['POST','GET']);
      debug('Cancel returned: ' + JSON.stringify(r.body));
      if (!r.body.ok) setStatus('Cancel failed: ' + JSON.stringify(r.body), true);
      else setStatus('Cancel done: ' + JSON.stringify(r.body));
      await loadState();
    } finally { cancelBtn.disabled = false; }
  };

  refreshBtn.onclick = loadState;
  refreshCardsBtn.onclick = loadState;

  // periodically update header time
  setInterval(()=> {
    const t = new Date().toLocaleTimeString('en-IN', {hour12:false});
    setText('time_now', t);
  }, 1000);

  // set button enabled state based on saved token
  function updateButtons(){ const has = !!savedToken(); [enforceBtn, killBtn, cancelBtn, allowNewCheckbox, loginBtn].forEach(b=>{ if(b) b.disabled = !has; }); }
  updateButtons();

  // initial load
  await loadState();

})();
</script>
</body>
</html>
