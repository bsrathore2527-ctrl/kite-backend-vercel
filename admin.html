<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guardian — Admin</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --bg1:#071024; --card:#0f1724; --muted:#9aa7b3; --accent:#3b82f6;
    --accent2:#10b981; --danger:#ef4444; --radius:12px;
  }
  html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#051025 0%, #02111b 100%);color:#e9f2ff}
  .wrap{max-width:980px;margin:16px auto;padding:14px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,#071628,#0b2130);display:grid;place-items:center;font-weight:700}
  h1{margin:0;font-size:20px}
  .status{margin-left:auto;display:flex;gap:8px;align-items:center;color:var(--muted);font-size:13px}
  .badge{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type=text], input[type=password], input[type=number] {padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#2b6df6);color:#fff}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .btn.warn{background:linear-gradient(90deg,#ff8a65,#ff7043);color:#fff}
  .btn.danger{background:linear-gradient(90deg,#d33,#b42323);color:#fff}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .value{font-weight:800;font-size:18px}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:12px;color:var(--muted)}
  .pages{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;gap:14px;padding-bottom:12px;scroll-behavior:smooth}
  .page{min-width:100%;scroll-snap-align:center}
  .pager{display:flex;gap:8px;justify-content:center;margin-top:8px}
  pre.log{white-space:pre-wrap;background:rgba(0,0,0,0.12);padding:10px;border-radius:8px;max-height:320px;overflow:auto;color:#ffdede}
  .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
  @media(max-width:720px){ .grid-2{grid-template-columns:1fr} header{flex-wrap:wrap} .status{margin-left:0} }
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,0.7);padding:10px 14px;border-radius:8px;color:white;display:none}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">G</div>
    <div>
      <h1>Guardian — Admin</h1>
      <div class="small muted">Risk automation & enforcement</div>
    </div>
    <div class="status">
      <div id="kite_status" class="badge">Kite: —</div>
      <div id="guardian_status" class="badge">Guardian: —</div>
      <div id="now" class="badge">--:--:--</div>
    </div>
  </header>

  <div class="pages" id="pages">
    <!-- page 1: admin -->
    <section class="page card" id="page_admin">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div style="flex:1;min-width:240px">
          <div class="muted">Admin token — save to unlock actions (stored locally)</div>
          <div class="row" style="margin-top:8px">
            <input id="admin_token" type="password" placeholder="ADMIN_TOKEN (password)" />
            <button id="toggle_token" class="btn ghost">Show</button>
            <button id="save_token" class="btn primary">Save</button>
            <button id="clear_token" class="btn ghost">Clear</button>
          </div>

          <div style="margin-top:10px" class="row">
            <button id="login_zerodha" class="btn ghost">Login Zerodha</button>
            <button id="refresh_state" class="btn ghost">Refresh</button>
          </div>

          <div id="admin_actions" style="margin-top:12px;display:none">
            <div class="row" style="margin-bottom:8px">
              <button id="enforce_btn" class="btn warn">Enforce Now</button>
              <button id="kill_btn" class="btn danger">Kill (Close)</button>
              <button id="cancel_btn" class="btn ghost">Cancel All</button>
              <label style="margin-left:auto" class="small muted"><input id="allow_new" type="checkbox" /> Allow New Orders</label>
            </div>

            <div style="margin-top:8px">
              <div class="muted">Override capital (applies today)</div>
              <div class="row" style="margin-top:6px">
                <input id="capital_input" type="text" placeholder="Enter amount" />
                <button id="set_capital_btn" class="btn primary">Set Capital</button>
                <button id="clear_capital_btn" class="btn ghost">Clear</button>
              </div>
              <div id="set_capital_msg" class="small" style="margin-top:6px"></div>
            </div>

            <div style="margin-top:12px">
              <div class="muted">Behavioral config</div>
              <div class="row" style="margin-top:6px;align-items:center">
                <label class="small muted"><input id="cfg_cooldown_on_profit" type="checkbox" /> Cooldown on profit</label>
                <label class="small muted">Min loss to count (₹) <input id="cfg_min_loss_to_count" type="number" min="0" style="width:90px;margin-left:6px" /></label>
                <button id="save_cfg_btn" class="btn primary">Save Config</button>
                <div id="save_cfg_msg" class="small" style="margin-left:8px"></div>
              </div>
            </div>

            <div id="admin_resp" class="small" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- page 2: Live overview -->
    <section class="page card" id="page_live">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Live overview</h3>
        <div><button id="refresh_top" class="btn ghost">Refresh</button></div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <div class="card" style="background:transparent;border:0;padding:8px">
          <div class="muted">Capital @ 09:15</div>
          <div id="capital915" class="value">—</div>
          <div class="small">Base for daily limits</div>
        </div>

        <div class="card" style="background:transparent;border:0;padding:8px">
          <div class="muted">Current Balance (live/fallback)</div>
          <div id="live_balance" class="value">—</div>
          <div class="small">Prefers live_balance from Kite</div>
        </div>

        <div class="card" style="background:transparent;border:0;padding:8px">
          <div class="muted">Live MTM</div>
          <div id="live_mtm" class="value">—</div>
          <div class="small">Sum of position P&L</div>
        </div>

        <div class="card" style="background:transparent;border:0;padding:8px">
          <div class="muted">PnL (R / UR / Total)</div>
          <div id="pnl_box" class="value">—</div>
          <div id="pnl_hint" class="small"></div>
        </div>

        <div class="card" style="background:transparent;border:0;padding:8px">
          <div class="muted">Consecutive Losses</div>
          <div id="consec_losses" class="value">0</div>
          <div class="small">Resets on profitable close</div>
        </div>

        <div class="card" style="background:transparent;border:0;padding:8px">
          <div class="muted">Max Loss (₹)</div>
          <div id="max_loss" class="value">—</div>
          <div id="max_loss_pct" class="small"></div>
        </div>

        <div class="card" style="background:transparent;border:0;padding:8px">
          <div class="muted">Active Loss Floor (₹)</div>
          <div id="active_floor" class="value">—</div>
          <div class="small" id="floor_hint"></div>
        </div>

        <div class="card" style="background:transparent;border:0;padding:8px">
          <div class="muted">Remaining to Max Loss (₹)</div>
          <div id="remaining_loss" class="value">—</div>
          <div class="small">Room before floor trip</div>
        </div>
      </div>
    </section>

    <!-- page 3: Rules -->
    <section class="page card" id="page_rules">
      <h3 style="margin:0">Rules (admin editable)</h3>
      <div class="grid-2" style="margin-top:12px">
        <div>
          <div class="muted">Max Loss %</div>
          <input id="rule_max_loss_pct" type="text" placeholder="10" />
        </div>
        <div>
          <div class="muted">Trailing step (₹)</div>
          <input id="rule_trail_step" type="text" placeholder="5000" />
        </div>
        <div>
          <div class="muted">Cooldown (min)</div>
          <input id="rule_cooldown_min" type="text" placeholder="15" />
        </div>
        <div>
          <div class="muted">Max consecutive losses</div>
          <input id="rule_max_consec" type="text" placeholder="3" />
        </div>
      </div>
      <div class="small muted" style="margin-top:8px">Only editable when admin token is saved.</div>
    </section>

    <!-- page 4: Logs & actions -->
    <section class="page card" id="page_logs">
      <h3 style="margin:0">Logs & actions</h3>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button id="enforce_trades_btn" class="btn ghost">Enforce Trades</button>
        <button id="cancel_all_btn" class="btn ghost">Cancel All</button>
        <button id="kill_btn2" class="btn danger">Kill</button>
        <button id="clear_logs" class="btn ghost">Clear Logs</button>
      </div>

      <!-- Logs filter controls -->
      <div class="filters">
        <button id="filter_errors" class="btn ghost">Show Errors</button>
        <button id="filter_trades" class="btn ghost">Show Executed Trades</button>
        <button id="filter_all" class="btn ghost">Show All</button>
        <div id="logs_hint" class="small muted">Trades fetched from <code>/api/kite/trades</code> if available; fallback to client logs.</div>
      </div>

      <div style="margin-top:12px">
        <div class="muted">Server responses & request log</div>
        <pre id="raw_responses" class="log">—</pre>
      </div>
    </section>
  </div>

  <div class="pager">
    <button id="prev" class="btn ghost">⟨ Prev</button>
    <button id="next" class="btn ghost">Next ⟩</button>
  </div>

  <footer style="margin-top:12px" class="small muted">Guardian • admin console</footer>
</div>

<div id="toast" class="toast"></div>

<script>
/* =========================
   Admin UI script — full
   ========================= */
const ENDPOINTS = {
  state: '/api/state',
  kite_funds: '/api/kite/funds',
  kite_login: '/api/kite/login',
  set_config: '/api/admin/set-config',
  kite_trades: '/api/kite/trades', // recommended server endpoint
  set_capital_candidates: ['/api/admin/set-capital','/api/admin/set_capital','/api/admin/setcapital','/api/admin/set-captial'],
  enforce_candidates: ['/api/enforce','/api/admin/enforce','/api/admin/enforce-trades'],
  cancel_candidates: ['/api/admin/cancel','/api/admin/cancel_all','/api/admin/cancel-all','/api/admin/cancel'],
  kill_candidates: ['/api/admin/kill','/api/admin/close','/api/admin/kill']
};

const $ = id => document.getElementById(id);
function toast(msg, t=3000){ const el=$('toast'); el.textContent=msg; el.style.display='block'; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none',t); }
function now(){ return new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata',hour12:false}); }
function fmtINR(v){ if(v==null||isNaN(Number(v))) return '—'; return '₹'+Number(v).toLocaleString('en-IN',{maximumFractionDigits:0}); }
function log(s){ const pre = $('raw_responses'); pre.textContent = `[${new Date().toLocaleTimeString()}] ${s}\n\n` + pre.textContent; }

/* pager */
const pages = document.querySelectorAll('.page');
let pageIndex = 0;
function go(idx){ pageIndex = Math.max(0, Math.min(pages.length-1, idx)); pages[pageIndex].scrollIntoView({behavior:'smooth'}); }
$('prev').addEventListener('click', ()=> go(pageIndex-1));
$('next').addEventListener('click', ()=> go(pageIndex+1));
document.addEventListener('keydown', e=>{ if(e.key==='ArrowLeft') go(pageIndex-1); if(e.key==='ArrowRight') go(pageIndex+1); });

/* auth header */
function authHeader(){ const tk = localStorage.getItem('ADMIN_TOKEN') || ''; return tk ? { 'Authorization': tk.startsWith('Bearer ') ? tk : 'Bearer '+tk } : {}; }

/* init */
document.addEventListener('DOMContentLoaded', init);
function init(){
  // wire buttons
  $('save_token').addEventListener('click', saveToken);
  $('clear_token').addEventListener('click', clearToken);
  $('toggle_token').addEventListener('click', toggleToken);
  $('login_zerodha').addEventListener('click', loginKite);
  $('refresh_state').addEventListener('click', loadAll);
  $('refresh_top').addEventListener('click', loadAll);

  $('enforce_btn').addEventListener('click', enforceNow);
  $('enforce_trades_btn').addEventListener('click', enforceNow);
  $('kill_btn').addEventListener('click', killNow);
  $('kill_btn2').addEventListener('click', killNow);
  $('cancel_btn').addEventListener('click', cancelAll);
  $('cancel_all_btn').addEventListener('click', cancelAll);
  $('set_capital_btn').addEventListener('click', setCapital);
  $('clear_capital_btn').addEventListener('click', ()=>{ $('capital_input').value=''; $('set_capital_msg').textContent=''; });

  $('save_cfg_btn').addEventListener('click', saveConfig);

  // logs filters
  $('filter_errors').addEventListener('click', showOnlyErrors);
  $('filter_trades').addEventListener('click', showExecutedTrades);
  $('filter_all').addEventListener('click', showAllLogs);
  $('clear_logs').addEventListener('click', ()=> $('raw_responses').textContent = '');

  applyTokenUI();
  if(localStorage.getItem('ADMIN_TOKEN')) enableAdmin(true);

  loadAll();
  setInterval(()=> $('now').textContent = now(), 1000);
}

/* token UI */
function applyTokenUI(){
  const t = localStorage.getItem('ADMIN_TOKEN');
  if(t){ $('admin_token').value='*******'; $('admin_token').dataset.saved='1'; } else { $('admin_token').value=''; $('admin_token').dataset.saved='0'; }
}
function saveToken(){
  const val = $('admin_token').value.trim();
  if($('admin_token').dataset.saved==='1' && val==='*******'){ toast('Token already saved (masked)'); return; }
  if(!val){ toast('Enter token'); return; }
  localStorage.setItem('ADMIN_TOKEN', val); $('admin_token').value='*******'; $('admin_token').dataset.saved='1'; enableAdmin(true); toast('Token saved (local)');
}
function clearToken(){ localStorage.removeItem('ADMIN_TOKEN'); $('admin_token').value=''; $('admin_token').dataset.saved='0'; enableAdmin(false); toast('Admin token cleared'); }
function toggleToken(){ const saved = localStorage.getItem('ADMIN_TOKEN'); if(saved){ $('admin_token').type='text'; $('admin_token').value=saved; setTimeout(()=>{ $('admin_token').type='password'; $('admin_token').value='*******'; }, 3500); } else { $('admin_token').type = $('admin_token').type==='password' ? 'text' : 'password'; } }
function enableAdmin(v){ const el = $('admin_actions'); if(!el) return; el.style.display = v ? 'block' : 'none'; const arr = ['enforce_btn','kill_btn','cancel_btn','set_capital_btn','save_cfg_btn','filter_trades']; arr.forEach(id=>{ const b=$(id); if(b) b.disabled = !v; }); }

/* helpers to try multiple candidates */
async function tryList(list, opts={method:'POST', body:{} }) {
  for(const p of list){
    try{
      const headers = { ...(opts.headers||{}), ...authHeader() };
      let init = { method: opts.method, headers };
      if(opts.body !== undefined){
        headers['Content-Type'] = headers['Content-Type'] || 'application/json';
        init.body = typeof opts.body === 'string' ? opts.body : JSON.stringify(opts.body);
      }
      const r = await fetch(p, init);
      const txt = await r.text().catch(()=>null);
      let json=null; try{ json = txt ? JSON.parse(txt) : null }catch(e){ json={ok:false,raw:txt}; }
      log(`${opts.method} ${p} => ${txt||r.status}`);
      if(r.status !== 404) return { path:p, status:r.status, json, txt, ok:r.ok };
    }catch(e){ log(`fetch ${p} failed: ${e.message}`); }
  }
  return { ok:false, error:'no candidate succeeded' };
}

/* login flow */
async function loginKite(){
  $('login_zerodha').disabled = true;
  try{
    let r = await fetch(ENDPOINTS.kite_login, { method:'GET', headers: authHeader() });
    if(r.status === 405 || r.status === 400){
      r = await fetch(ENDPOINTS.kite_login, { method:'POST', headers: {'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify({}) });
    }
    const txt = await r.text().catch(()=>null);
    let json=null; try{ json = txt ? JSON.parse(txt) : null } catch(e){ json={ok:false,raw:txt} }
    log(`login => ${txt||r.status}`);
    if(json && json.ok && json.url) { window.open(json.url, '_blank'); toast('Opened kite login'); }
    else toast('Login result: ' + (json && (json.error||json.message) ? JSON.stringify(json) : 'see logs'));
    await loadAll();
  }catch(e){ toast('Login failed: '+(e.message||e)); log('login error: '+e.message); }
  finally{ $('login_zerodha').disabled = false; }
}

/* enforce, kill, cancel, setCapital, saveConfig (same logic as earlier) */
async function enforceNow(){
  $('enforce_btn').disabled = true;
  try{
    for(const p of ENDPOINTS.enforce_candidates){
      try{ const r = await fetch(p, { method:'GET', headers: authHeader() }); const txt=await r.text().catch(()=>null); log(`GET ${p} => ${txt||r.status}`); if(r.status!==404){ $('admin_resp').textContent = txt; toast('Enforce: check logs'); await loadAll(); $('enforce_btn').disabled=false; return; } }catch(e){ log('GET enforce failed: '+e.message); }
    }
    const res = await tryList(ENDPOINTS.enforce_candidates, { method:'POST', body:{} });
    $('admin_resp').textContent = res.json ? JSON.stringify(res.json) : (res.txt||res.error);
    toast('Enforce: ' + (res.ok ? 'ok' : 'failed'));
    await loadAll();
  }catch(e){ toast('Enforce error: '+e.message); log('enforce error: '+e.message); }
  finally{ $('enforce_btn').disabled = false; }
}

async function killNow(){
  if(!confirm('Kill will attempt to close running positions. Proceed?')) return;
  const btn = $('kill_btn'); btn.disabled = true;
  try{
    const res = await tryList(ENDPOINTS.kill_candidates, { method:'POST', body:{ force:true } });
    $('admin_resp').textContent = res.json ? JSON.stringify(res.json) : (res.txt||res.error);
    toast('Kill: ' + (res.ok ? 'ok' : 'failed'));
    await loadAll();
  }catch(e){ toast('Kill failed: '+e.message); log('kill error: '+e.message); }
  finally{ btn.disabled = false; }
}

async function cancelAll(){
  if(!confirm('Cancel all pending orders?')) return;
  const btn = $('cancel_btn'); btn.disabled = true;
  try{
    const res = await tryList(ENDPOINTS.cancel_candidates, { method:'POST', body:{} });
    $('admin_resp').textContent = res.json ? JSON.stringify(res.json) : (res.txt||res.error);
    toast('Cancel: ' + (res.ok ? 'ok' : 'failed'));
    await loadAll();
  }catch(e){ toast('Cancel failed: '+e.message); log('cancel error: '+e.message); }
  finally{ btn.disabled = false; }
}

async function setCapital(){
  const raw = $('capital_input').value.trim();
  if(!raw){ $('set_capital_msg').textContent='Enter capital'; return; }
  const val = Number(String(raw).replace(/[^0-9.-]/g,'')); if(isNaN(val)){ $('set_capital_msg').textContent='Invalid number'; return; }
  $('set_capital_msg').textContent='Setting...'; $('set_capital_btn').disabled=true;
  try{
    const res = await tryList(ENDPOINTS.set_capital_candidates, { method:'POST', body:{ capital: val } });
    if(res.json && res.json.ok){ $('set_capital_msg').textContent='Set capital OK'; toast('Set capital OK'); }
    else { $('set_capital_msg').textContent = 'Failed: ' + (res.json && res.json.error ? res.json.error : (res.error||'no response')); toast('Set capital failed'); }
    await loadAll();
  }catch(e){ $('set_capital_msg').textContent='Error: '+e.message; log('setCapital err: '+e.message); }
  finally{ $('set_capital_btn').disabled=false; }
}

async function saveConfig(){
  const btn = $('save_cfg_btn'); btn.disabled=true; $('save_cfg_msg').textContent='Saving...';
  const payload = { cooldown_on_profit: !!$('cfg_cooldown_on_profit').checked, min_loss_to_count: Number($('cfg_min_loss_to_count').value || 0) };
  try{
    const r = await fetch(ENDPOINTS.set_config, { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify(payload) });
    const txt = await r.text().catch(()=>null); let j=null; try{ j = txt ? JSON.parse(txt) : null }catch(e){ j={ok:false} }
    if(j && j.ok){ $('save_cfg_msg').textContent='Saved'; toast('Config saved'); setTimeout(()=> $('save_cfg_msg').textContent='',2000); loadAll(); }
    else{ $('save_cfg_msg').textContent='Save failed'; toast('Save failed'); log('saveConfig: '+(j && j.error ? j.error : txt)); }
  }catch(e){ $('save_cfg_msg').textContent='Error'; log('saveConfig err: '+e.message); }
  finally{ btn.disabled=false; }
}

/* load state & funds */
async function loadAll(){ await Promise.allSettled([ loadState(), loadFunds() ]); }
async function loadState(){
  try{
    const r = await fetch(ENDPOINTS.state, { method:'GET', headers: authHeader() });
    const txt = await r.text().catch(()=>null); let j=null; try{ j = txt ? JSON.parse(txt) : null }catch(e){ j={ok:false} }
    log(`GET ${ENDPOINTS.state} => ${txt||r.status}`);
    if(!j || !j.ok){ toast('Failed load state'); return; }
    $('now').textContent = j.time || now();
    $('guardian_status').textContent = j.admin ? 'admin' : 'online';
    $('kite_status').textContent = j.kite_status === 'ok' ? 'Kite: Connected' : (j.kite_status || 'not_logged_in');
    const s = j.state || {};
    $('capital915').textContent = fmtINR(s.capital_day_915 ?? 0);
    $('live_mtm').textContent = fmtINR(s.unrealised ?? 0);
    const realised = Number(s.realised ?? 0), unreal = Number(s.unrealised ?? 0), total = realised + unreal;
    $('pnl_box').textContent = `${fmtINR(realised)} / ${fmtINR(unreal)} / ${fmtINR(total)}`;
    $('pnl_hint').textContent = total < 0 ? 'In loss' : (total>0 ? 'In profit' : '—');
    $('consec_losses') && ($('consec_losses').textContent = (s.consecutive_losses ?? 0).toString());
    $('max_loss').textContent = fmtINR(((s.capital_day_915||0) * ((s.max_loss_pct ?? 10)/100)) || 0);
    $('max_loss_pct').textContent = `Max Loss %: ${(s.max_loss_pct ?? 10).toFixed(2)}%`;
    $('active_floor').textContent = fmtINR(s.active_loss_floor ?? 0);
    $('remaining_loss').textContent = fmtINR((s.capital_day_915 ?? 0) - Math.abs(total));
    $('cfg_cooldown_on_profit').checked = !!s.cooldown_on_profit;
    $('cfg_min_loss_to_count').value = Number(s.min_loss_to_count ?? 0);
    if(j.admin) enableAdmin(true); else if(localStorage.getItem('ADMIN_TOKEN')) enableAdmin(true); else enableAdmin(false);
  }catch(e){ log('loadState err: '+(e.message||e)); toast('State load failed'); }
}
async function loadFunds(){
  try{
    const r = await fetch(ENDPOINTS.kite_funds, { method:'GET', headers: authHeader() });
    const txt = await r.text().catch(()=>null); let j=null; try{ j = txt ? JSON.parse(txt) : null }catch(e){ j={ok:false} }
    log(`GET ${ENDPOINTS.kite_funds} => ${txt||r.status}`);
    if(!j || j.ok === false){
      const cached = await fetch(ENDPOINTS.state).then(r=>r.json()).catch(()=>null);
      const val = cached?.state?.current_balance ?? cached?.state?.capital_day_915 ?? 0;
      $('live_balance').textContent = fmtINR(val);
      return;
    }
    let av = null;
    if (j.funds && j.funds.available && typeof j.funds.available.live_balance !== 'undefined') av = j.funds.available.live_balance;
    else if (j.funds && typeof j.funds.net !== 'undefined') av = j.funds.net;
    else if (typeof j.balance !== 'undefined') av = j.balance;
    else if (j.funds && j.funds.available && typeof j.funds.available.cash !== 'undefined') av = j.funds.available.cash;
    $('live_balance').textContent = fmtINR(av ?? (j.balance ?? 0));
  }catch(e){ log('loadFunds err: '+(e.message||e)); const cached = await fetch(ENDPOINTS.state).then(r=>r.json()).catch(()=>null); const val = cached?.state?.current_balance ?? cached?.state?.capital_day_915 ?? 0; $('live_balance').textContent = fmtINR(val); }
}

/* ========== Logs filtering & trades fetch ========== */
function getRawLogLines(){
  const pre = $('raw_responses'); if(!pre) return []; return pre.textContent.split(/\n{1,}/).filter(Boolean).map(s=>s.trim());
}
function showAllLogs(){ /* no-op — raw area already has logs */ toast('Showing all logs'); }
function showOnlyErrors(){
  const pre = $('raw_responses'); if(!pre) return;
  const lines = getRawLogLines();
  const filtered = lines.filter(l => /error|err[:\s]|failed|4\d{2}|5\d{2}|\"ok\":\s*false/i.test(l));
  pre.textContent = filtered.join('\n\n') || '—';
  toast('Filtered: errors');
}

/* Attempt to fetch trades from server endpoint, else fallback to scanning logs */
async function showExecutedTrades(){
  const pre = $('raw_responses'); if(!pre) return;
  // Try server endpoint first
  try{
    const r = await fetch(ENDPOINTS.kite_trades, { method: 'GET', headers: authHeader() });
    if(r.ok){
      const txt = await r.text().catch(()=>null); let j=null; try{ j=txt?JSON.parse(txt):null }catch(e){ j=null }
      // If server returns array or { trades: [...] }
      const trades = Array.isArray(j) ? j : (j && Array.isArray(j.trades) ? j.trades : null);
      if(trades && trades.length){
        pre.textContent = formatTradesList(trades);
        toast('Fetched trades from server');
        return;
      }
    }
  }catch(e){ /* ignore */ }

  // fallback: scan logs
  const lines = getRawLogLines();
  const candidates = lines.filter(l => /\b(trade|trade_id|order_id|executed|filled|avg_price|filled_qty)\b/i.test(l));
  if(candidates.length){
    pre.textContent = candidates.join('\n\n');
    toast('Showing trades from client logs (fallback)');
    return;
  }
  pre.textContent = 'No executed trades found in server endpoint or logs.';
  toast('No trades found');
}

function formatTradesList(trades){
  return trades.map(t => {
    const id = t.trade_id || t.tradeId || t.order_id || t.orderId || t.id || '—';
    const sym = t.tradingsymbol || t.trading_symbol || t.instrument || t.symbol || '—';
    const qty = t.quantity || t.qty || t.filled_qty || '—';
    const price = t.price || t.trade_price || t.avg_price || t.price_executed || '—';
    const side = (t.transaction_type || t.side || t.order_side || '').toUpperCase() || (t.qty && Number(t.qty) < 0 ? 'SELL' : 'BUY');
    const ts = t.trade_time || t.timestamp || t.exchange_timestamp || t.time || t._ts || null;
    const timestr = ts ? (new Date(Number(ts)).toLocaleString() || ts) : '';
    return `trade_id: ${id}\nsymbol: ${sym}\nside: ${side}\nqty: ${qty}\nprice: ${price}\ntime: ${timestr}\n`;
  }).join('\n---\n');
}
</script>
</body>
                                                                                                </html>
