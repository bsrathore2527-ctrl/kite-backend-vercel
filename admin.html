<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guardian — Admin</title>
<style>
  :root{
    --bg:#041026; --card:#0b1420; --muted:#98a7bb; --accent:#2f6df6;
    --success:#1f7a2f; --danger:#b93131; --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02); --radius:14px;
    --card-border: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#061123 0%, #041026 50%, #000511 100%);font-family:Inter,Arial,Helvetica;color:#e6eef8}
  .wrap{max-width:1100px;margin:14px auto;padding:18px;}
  header{display:flex;align-items:center;gap:18px;margin-bottom:14px}
  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,#061428,#0f1b2b);display:grid;place-items:center;font-weight:700}
  h1{margin:0;font-size:28px}
  .meta{margin-left:auto;display:flex;gap:12px;align-items:center;color:var(--muted)}
  .card{background:linear-gradient(180deg,var(--glass),var(--glass-2));border-radius:var(--radius);padding:16px;margin:14px 0;box-shadow:0 6px 28px rgba(0,0,0,0.6);border:1px solid var(--card-border)}
  .admin-grid{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
  .label{color:var(--muted);font-size:13px;margin-bottom:6px}
  .token-wrap{display:flex;align-items:center;gap:8px}
  input[type="password"], input[type="text"]{width:100%;padding:12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}
  .btn{padding:10px 18px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .btn.warn{background:var(--danger)}
  .btn.ok{background:var(--success)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted);font-size:13px}
  .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .stat{padding:14px;border-radius:12px;background:rgba(0,0,0,0.12);border:1px solid rgba(255,255,255,0.02)}
  .stat h3{margin:0;font-size:12px;color:var(--muted)}
  .stat .val{font-weight:800;font-size:20px;margin-top:8px}
  .small{font-size:13px;padding:8px 12px;border-radius:8px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:rgba(0,0,0,0.78);color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.6);display:none}
  .toast.show{display:block}
  pre#raw_responses{white-space:pre-wrap;color:#ffdede;background:rgba(0,0,0,0.12);padding:12px;border-radius:8px;margin-top:8px;max-height:240px;overflow:auto}
  label.switch{display:inline-flex;align-items:center;gap:6px;color:var(--muted)}
  .controls {display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
  .muted-block {color:var(--muted);margin-top:8px}
  .input-eye{cursor:pointer;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)}
  @media (max-width:640px){ .stats{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">G</div>
    <div>
      <h1>Guardian — Admin</h1>
      <div class="muted">Risk automation & enforcement</div>
    </div>
    <div class="meta">
      <div id="kite_status" class="muted">Kite: —</div>
      <div id="guard_status" class="muted">Guardian: —</div>
      <div id="now" class="muted">--:--:--</div>
    </div>
  </header>

  <!-- ADMIN CARD -->
  <section class="card" id="admin_card">
    <div>
      <div class="label">Admin token (keeps UI read-only unless saved)</div>
      <div class="token-wrap" style="gap:10px">
        <input id="admin_token" type="password" placeholder="Enter admin token" aria-label="Admin token" />
        <button id="toggle_token" class="input-eye">Show</button>
        <button id="save_token" class="btn">Save</button>
        <button id="clear_token" class="btn ghost">Clear</button>
      </div>
      <div class="muted-block">Token stored locally only. We will not display the real token; only masked placeholder will be shown.</div>
    </div>

    <div class="controls">
      <button id="login_zerodha" class="btn ghost small">Login Zerodha</button>
      <button id="refresh_state" class="btn ghost small">Refresh</button>
      <div style="flex:1"></div>
      <label class="muted">Admin controls unlock after saving token</label>
    </div>

    <div style="height:8px"></div>

    <div class="controls">
      <button id="enforce_btn" class="btn ok">Enforce Now</button>
      <button id="kill_btn" class="btn warn">Kill (Close)</button>
      <button id="cancel_all_btn" class="btn ghost">Cancel All</button>

      <label style="margin-left:auto" class="switch"><input id="allow_new_checkbox" type="checkbox" /> Allow New Orders</label>
    </div>

    <div id="last_action_msg" style="margin-top:12px;color:#ffbcbc">—</div>
  </section>

  <!-- STATS CARD -->
  <section class="card">
    <h2 style="margin-top:0">Live overview <button id="refresh_stats" class="btn ghost small" style="float:right">Refresh</button></h2>
    <div class="stats" id="stats_grid">
      <div class="stat">
        <h3>Capital @ 09:15</h3>
        <div class="val" id="capital915">—</div>
        <div class="muted">Base for daily limits</div>
      </div>
      <div class="stat">
        <h3>Current Balance (live/fallback)</h3>
        <div class="val" id="live_funds">—</div>
        <div class="muted">Uses cached if offline</div>
      </div>
      <div class="stat">
        <h3>Live MTM</h3>
        <div class="val" id="live_mtm">—</div>
        <div class="muted">Sum of position PnL</div>
      </div>
      <div class="stat">
        <h3>PnL (R/UR/Total)</h3>
        <div class="val" id="pnl_info">—</div>
        <div class="muted">Realtime</div>
      </div>
      <div class="stat">
        <h3>Consecutive Losses</h3>
        <div class="val" id="consec_losses">—</div>
        <div class="muted">Count for today</div>
      </div>
      <div class="stat">
        <h3>Cooldown Until</h3>
        <div class="val" id="cooldown_until">—</div>
        <div class="muted">Locked until</div>
      </div>
    </div>
  </section>

  <!-- LOGS & ACTIONS CARD -->
  <section class="card">
    <h2 style="margin-top:0">Logs & last responses</h2>
    <div class="muted">Server responses for last actions are shown here (keeps a running history)</div>
    <pre id="raw_responses">—</pre>
  </section>

</div>

<div id="toast" class="toast"></div>

<script>
/* --------------------------
   Small helpers & UI utils
   -------------------------- */
const $ = id => document.getElementById(id);
const toastEl = $('toast');
function showToast(msg, t = 2500){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), t); }
function nowTime(){ return new Date().toLocaleTimeString('en-IN', { timeZone:'Asia/Kolkata', hour12:false }); }
function safeStringify(j){ try{return JSON.stringify(j);}catch(e){return String(j);} }

/* --------------------------
   Token storage / UI
   -------------------------- */
const tokenInput = $('admin_token');
const toggleBtn = $('toggle_token');
const saveBtn = $('save_token');
const clearBtn = $('clear_token');

function getStoredToken(){ return localStorage.getItem('admin_token') || ''; }
function setStoredToken(v){ if(v) localStorage.setItem('admin_token', v); else localStorage.removeItem('admin_token'); }

function applyTokenUI(){
  const t = getStoredToken();
  if(t){
    tokenInput.value = '********';          // always mask in UI
    tokenInput.dataset.saved = '1';
    tokenInput.type = 'password';
  } else {
    tokenInput.value = '';
    tokenInput.dataset.saved = '0';
    tokenInput.type = 'password';
  }
  setAdminEnabled(!!t);
}
applyTokenUI();

toggleBtn.addEventListener('click', () => {
  // If a real token is saved, reveal it briefly (not kept)
  const saved = getStoredToken();
  if(!saved){
    // toggle visibility of typed input
    tokenInput.type = tokenInput.type === 'password' ? 'text' : 'password';
    toggleBtn.textContent = tokenInput.type === 'password' ? 'Show' : 'Hide';
    return;
  }
  tokenInput.type = 'text';
  tokenInput.value = saved;
  toggleBtn.textContent = 'Hide';
  setTimeout(()=>{ tokenInput.type = 'password'; tokenInput.value = '********'; toggleBtn.textContent = 'Show'; }, 3500);
});

saveBtn.addEventListener('click', () => {
  const typed = tokenInput.value.trim();
  const alreadySaved = tokenInput.dataset.saved === '1';
  if(alreadySaved && typed === '********'){ showToast('Token already saved'); return; }
  if(!typed){ showToast('Enter token first'); return; }
  setStoredToken(typed);
  applyTokenUI();
  showToast('Token saved');
});

clearBtn.addEventListener('click', () => {
  setStoredToken('');
  applyTokenUI();
  showToast('Token cleared');
});

/* --------------------------
   Admin enable/disable UI
   -------------------------- */
let adminEnabled = false;
function setAdminEnabled(v){
  adminEnabled = !!v;
  // which buttons should be disabled when no token
  ['enforce_btn','kill_btn','cancel_all_btn','login_zerodha'].forEach(id => {
    const el = $(id);
    if(!el) return;
    el.disabled = !adminEnabled;
    el.classList.toggle('ghost', !adminEnabled);
  });
}
setAdminEnabled(!!getStoredToken());

/* --------------------------
   Response history UI
   -------------------------- */
function pushResponse(text){
  const pre = $('raw_responses');
  const ts = new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata', hour12:false});
  const entry = `[${ts}] ${text}\n\n`;
  pre.textContent = entry + pre.textContent;
  console.log('ADMIN RESPONSE:', text);
}

/* --------------------------
   Auth header helper
   -------------------------- */
function authHeaders(){
  const t = getStoredToken();
  if(!t) return {};
  const hv = t.startsWith('Bearer ') ? t : 'Bearer ' + t;
  return { 'Authorization': hv };
}

/* --------------------------
   fetchWithFallback: try GET first, if 405 -> try POST
   returns parsed JSON or { ok:false, error:... }
   -------------------------- */
async function fetchWithFallback(path, body = null, prefer = ['GET','POST']){
  // prefer is array of methods to attempt in order; default GET then POST
  const methods = Array.isArray(prefer) ? prefer : ['GET','POST'];
  const headersBase = { ...authHeaders() };
  // try methods sequentially
  for(const method of methods){
    try{
      let opts = { method, headers: { ...headersBase } };
      if(method === 'POST' || method === 'PUT' || method === 'PATCH'){
        opts.headers['Content-Type'] = 'application/json';
        opts.body = body ? JSON.stringify(body) : JSON.stringify({});
      }
      // For GET we append a cache-busting query param to avoid cached results
      const url = method === 'GET' && body ? `${path}?_=${Date.now()}` : path;
      const resp = await fetch(url, opts);
      // If server returns 405 (Method Not Allowed), try next method
      if(resp.status === 405){
        // push a short note to responses and continue
        pushResponse(`${path} => 405 Method Not Allowed for ${method}, trying next method`);
        continue;
      }
      // parse JSON safely
      let j;
      try { j = await resp.json(); } catch(e) { j = { ok:false, error:'invalid_json', status: resp.status }; }
      // attach method & status info
      const out = { _method: method, _status: resp.status, _raw: j, ... (typeof j === 'object' ? j : { result: j }) };
      return out;
    } catch(err){
      // network or fetch error - record and try next method
      pushResponse(`${path} => fetch error (${method}): ${err.message}`);
      continue;
    }
  }
  return { ok:false, error:'all_methods_failed' };
}

/* --------------------------
   UI actions - bind handlers
   -------------------------- */

$('refresh_state').addEventListener('click', () => { loadState(); loadFunds(); showToast('Refreshed'); });
$('refresh_stats').addEventListener('click', () => { loadState(); loadFunds(); showToast('Refreshed'); });

$('enforce_btn').addEventListener('click', async () => {
  $('last_action_msg').textContent = 'Enforcing...';
  const allowNew = !!$('allow_new_checkbox').checked;
  const res = await fetchWithFallback('/api/admin/enforce', { allow_new: allowNew }, ['GET','POST']);
  pushResponse(`/api/admin/enforce -> ${safeStringify(res)}`);
  $('last_action_msg').textContent = res.ok ? 'Enforced' : `Enforce failed: ${res.error || res._raw?.error || res._status}`;
  await loadState();
});

$('cancel_all_btn').addEventListener('click', async () => {
  $('last_action_msg').textContent = 'Cancelling...';
  const res = await fetchWithFallback('/api/admin/cancel', { cancel_all: true }, ['GET','POST']);
  pushResponse(`/api/admin/cancel -> ${safeStringify(res)}`);
  $('last_action_msg').textContent = res.ok ? 'Cancelled' : `Cancel failed: ${res.error || res._raw?.error || res._status}`;
  await loadState();
});

$('kill_btn').addEventListener('click', async () => {
  $('last_action_msg').textContent = 'Killing...';
  const res = await fetchWithFallback('/api/admin/kill', {}, ['GET','POST']);
  pushResponse(`/api/admin/kill -> ${safeStringify(res)}`);
  $('last_action_msg').textContent = res.ok ? 'Killed' : `Kill failed: ${res.error || res._raw?.error || res._status}`;
  await loadState();
});

$('login_zerodha').addEventListener('click', async () => {
  $('last_action_msg').textContent = 'Zerodha login...';
  const res = await fetchWithFallback('/api/kite/login', {}, ['GET','POST']);
  pushResponse(`/api/kite/login -> ${safeStringify(res)}`);
  $('last_action_msg').textContent = res.ok ? 'Zerodha login OK' : `Zerodha login failed: ${res.error || res._raw?.error || res._status}`;
  await loadState();
});

/* --------------------------
   Load state & funds
   -------------------------- */
async function loadState(){
  try{
    const r = await fetch('/api/state?_=' + Date.now());
    const j = await r.json().catch(()=>({ ok:false }));
    if(!j.ok){ pushResponse(`/api/state -> error`); return; }
    $('now').textContent = j.time || nowTime();
    $('kite_status').textContent = 'Kite: ' + (j.kite_status || '—');
    $('guard_status').textContent = (j.admin ? 'admin' : 'read-only');
    const s = j.state || {};
    $('capital915').textContent = formatINR(s.capital_day_915 || 0);
    $('live_mtm').textContent = formatINR(s.unrealised || 0);
    $('pnl_info').textContent = `${formatINR(s.realised||0)} / ${formatINR(s.unrealised||0)} / ${formatINR((s.realised||0)+(s.unrealised||0))}`;
    $('consec_losses').textContent = (s.consecutive_losses ?? 0);
    $('cooldown_until').textContent = s.cooldown_until ? new Date(s.cooldown_until).toLocaleString() : '—';
    window._state = s;
  }catch(e){ console.error('loadState', e); pushResponse('/api/state fetch failed: '+e.message); }
}

async function loadFunds(){
  try{
    const r = await fetch('/api/kite/funds?_=' + Date.now());
    const j = await r.json().catch(()=>({ ok:false }));
    if(!j.ok){ $('live_funds').textContent = 'ERR'; pushResponse('/api/kite/funds -> error'); return; }
    // prefer live_balance -> net -> available.cash -> funds.balance
    const av = Number(j.funds?.available?.live_balance ?? j.funds?.net ?? j.funds?.available?.cash ?? j.balance ?? j.funds?.cash || 0);
    $('live_funds').textContent = formatINR(av);
  }catch(e){ console.error('loadFunds', e); $('live_funds').textContent = 'ERR'; pushResponse('/api/kite/funds fetch failed: '+e.message); }
}

/* --------------------------
   Small formatters
   -------------------------- */
function formatINR(v){
  if(v==null || isNaN(Number(v))) return '—';
  const n = Number(v);
  if(Math.abs(n) >= 1000) return '₹' + n.toLocaleString('en-IN', { maximumFractionDigits: 0 });
  return '₹' + n.toFixed(2);
}

/* --------------------------
   Initial load
   -------------------------- */
window.addEventListener('load', async () => {
  applyTokenUI();
  await loadState();
  await loadFunds();
  setInterval(()=> $('now').textContent = nowTime(), 1000);
});

/* debug helper: expose for console debugging */
window.guardianAdmin = {
  fetchWithFallback, getStoredToken, setStoredToken, loadState, loadFunds, pushResponse
};

</script>
</body>
</html>
