<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guardian â€” Admin</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    --bg:#0b0d14; --bg2:#0f1724; --card:#0f1624; --line:#1f2937; --fg:#e6eef8; --muted:#94a3b8;
    --accent:#3b82f6; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --r:12px; --pad:12px; --gap:12px;
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  body{
    background:
      radial-gradient(700px 360px at 10% -10%, rgba(59,130,246,.12), transparent 35%),
      linear-gradient(180deg,var(--bg2),var(--bg));
    color:var(--fg); -webkit-font-smoothing:antialiased;
  }
  .wrap{max-width:1100px;margin:18px auto;padding:16px}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .title{font-weight:800;font-size:18px}
  .badge{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:linear-gradient(180deg,#0d1726,#0b1420);font-size:13px}
  .dot{width:9px;height:9px;border-radius:50%}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:12px;align-items:center}
  .card{background:linear-gradient(180deg,#0f1726,#0b1118);border:1px solid var(--line);border-radius:12px;padding:12px}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .kpi{background:linear-gradient(180deg,#091021,#071018);border-radius:10px;padding:10px;border:1px solid #16202b}
  .kpi .h{font-size:12px;color:var(--muted);margin-bottom:6px}
  .kpi .v{font-weight:800;font-size:16px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select{width:100%;padding:10px;border-radius:10px;background:transparent;border:1px solid var(--line);color:var(--fg)}
  button{padding:10px 12px;border-radius:10px;border:0;background:linear-gradient(180deg,var(--accent),#1e60d6);color:white;font-weight:700;cursor:pointer}
  .btn-ghost{background:transparent;border:1px solid var(--line);color:var(--fg)}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:linear-gradient(180deg,#07101a,#071018);font-size:13px}
  .admin-only{opacity:0.5;pointer-events:none}
  .admin-enabled .admin-only{opacity:1;pointer-events:auto}
  @media (max-width:900px){ .kpis{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:560px){ .kpis{grid-template-columns:1fr} .row{flex-direction:column} }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">ðŸ›¡ Guardian â€¢ Admin</div>
    <div id="kiteBadge" class="badge"><span class="dot" style="background:#f59e0b;margin-right:8px"></span>Zerodha: â€”</div>
    <div id="guardBadge" class="badge"><span class="dot" style="background:#94a3b8;margin-right:8px"></span>Guardian: â€”</div>
    <div style="margin-left:auto" class="muted tiny" id="now">â€”</div>
  </div>

  <!-- top row: token + actions -->
  <div class="card row" style="gap:10px;margin-bottom:12px;align-items:center">
    <input id="adminToken" type="password" placeholder="ADMIN_TOKEN (stored locally)" style="flex:1" />
    <button onclick="saveToken()">Save</button>
    <button class="btn-ghost" onclick="clearToken()">Clear</button>
    <a href="/api/login"><button class="btn-ghost">Login Zerodha</button></a>
    <button class="btn-ghost" onclick="manualEnforce()">Enforce Now</button>
    <button class="btn-ghost" onclick="refresh()">Refresh</button>
  </div>

  <!-- KPI cards -->
  <div class="card" style="margin-bottom:12px">
    <div class="kpis">
      <div class="kpi"><div class="h">Capital @ 09:15</div><div class="v" id="k_cap">â€”</div><div class="muted tiny">Auto-captured</div></div>
      <div class="kpi"><div class="h">Current Balance</div><div class="v" id="k_balance">â€”</div><div class="muted tiny">live / cached</div></div>
      <div class="kpi"><div class="h">Live MTM</div><div class="v" id="k_mtm">â€”</div><div class="muted tiny">sum of net pnl</div></div>

      <div class="kpi"><div class="h">PnL (Real/Unreal/Total)</div><div class="v" id="k_pnl">â€”</div><div class="muted tiny" id="k_pnl_sub">â€”</div></div>
      <div class="kpi"><div class="h">Active Loss Floor</div><div class="v" id="k_floor">â€”</div><div class="muted tiny" id="k_floor_sub">â€”</div></div>
      <div class="kpi"><div class="h">Remaining to Floor</div><div class="v" id="k_remaining">â€”</div><div class="muted tiny">room left</div></div>
    </div>
  </div>

  <div id="mainGrid" class="grid admin-only">
    <!-- left: live state -->
    <div class="card" style="grid-column:span 6">
      <h3 style="margin:0 0 10px">Live State</h3>
      <div class="row" style="margin-bottom:8px">
        <div style="flex:1">
          <label>Day Status</label><div id="dayStatus" class="pill">â€”</div>
        </div>
        <div style="flex:1">
          <label>New Orders</label><div id="newOrders" class="pill">â€”</div>
        </div>
      </div>

      <div class="row" style="margin-bottom:8px">
        <div style="flex:1">
          <label>Consecutive Losses</label><div id="consec" class="pill">0</div>
        </div>
        <div style="flex:1">
          <label>Cooldown Until</label><div id="cool" class="pill">â€”</div>
        </div>
      </div>

      <div style="margin-top:8px">
        <label>Broker Live Funds</label><div id="liveFunds" class="pill">â€”</div>
      </div>
    </div>

    <!-- right: rules -->
    <div class="card" style="grid-column:span 6">
      <h3 style="margin:0 0 10px">Daily Rules (editable)</h3>

      <div class="row" style="margin-bottom:10px">
        <div style="flex:1">
          <label>Max Loss %</label>
          <input id="max_loss_pct" type="number" step="0.1" placeholder="10" />
        </div>
        <div style="flex:1">
          <label>Trail Step (â‚¹)</label>
          <input id="trail_step_profit" type="number" step="100" placeholder="5000" />
        </div>
      </div>

      <div class="row" style="margin-bottom:10px">
        <div style="flex:1">
          <label>Cooldown Min</label>
          <input id="cooldown_min" type="number" step="1" placeholder="15" />
        </div>
        <div style="flex:1">
          <label>Max Consecutive Losses</label>
          <input id="max_consecutive_losses" type="number" step="1" placeholder="3" />
        </div>
      </div>

      <div class="row" style="margin-bottom:10px">
        <div style="flex:1">
          <label>Allow new after 10% lock?</label>
          <select id="allow_new_after_lock10"><option value="false">No</option><option value="true">Yes</option></select>
        </div>
        <div style="flex:1">
          <label>Expiry Day Mode</label>
          <select id="expiry_flag"><option value="false">No</option><option value="true">Yes</option></select>
        </div>
      </div>

      <div class="actions" style="margin-top:8px">
        <button onclick="saveRules()">Save Rules</button>
        <button class="btn-ghost" onclick="postAction('/api/admin/kill')">Kill Day</button>
        <button class="btn-ghost" onclick="postAction('/api/admin/unlock')">Unlock</button>
        <button class="btn-ghost" onclick="postAction('/api/kite/cancel-all')">Cancel Pending</button>
        <button class="btn-ghost" onclick="postAction('/api/kite/exit-all')">Exit All</button>
      </div>
    </div>
  </div>

  <div class="muted" style="margin-top:10px;font-size:13px">Tip: Save ADMIN_TOKEN locally (not on server). Buttons that modify state require admin token.</div>
</div>

<script>
/* Minimal self-contained admin client
   - Stores admin token in localStorage (key: ADMIN_TOKEN)
   - Reads /api/state, /api/kite/funds, /api/kite/positions
   - Calls admin endpoints with Authorization: Bearer <token>
*/
const $ = id => document.getElementById(id);
const ADMIN_KEY = 'ADMIN_TOKEN';

function readToken(){ return localStorage.getItem(ADMIN_KEY) || ''; }
function setText(id,t){ const e=$(id); if(e) e.textContent = t; }
function fmtINR(v){ try { return new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR',maximumFractionDigits:0}).format(Math.round(v)); } catch { return 'â‚¹'+Math.round(v); } }

function setAdminMode(enabled){
  const root = document.querySelector('.wrap');
  if(enabled) root.classList.add('admin-enabled');
  else root.classList.remove('admin-enabled');
  // show badges
}

function saveToken(){
  const v = $('adminToken').value.trim();
  if(!v){ alert('Enter token'); return; }
  localStorage.setItem(ADMIN_KEY, v);
  $('adminToken').value = '';
  refresh();
}

function clearToken(){
  localStorage.removeItem(ADMIN_KEY);
  refresh();
}

async function fetchJson(url, opts = {}){
  try{
    const r = await fetch(url, opts);
    if(r.status === 401) { throw new Error('Unauthorized'); }
    return await r.json();
  } catch(e){ return { ok:false, error: e.message || String(e) }; }
}

async function refresh(){
  const token = readToken();
  setAdminMode(!!token);

  // state
  const stateRes = await fetchJson('/api/state', token ? { headers:{ Authorization: 'Bearer '+token } } : {});
  if(!stateRes.ok){ setText('k_pnl_sub','State fetch failed'); console.error(stateRes); return; }

  const s = stateRes.state || {};
  setText('now', stateRes.time || 'â€”');
  setText('dayStatus', s.tripped_day ? 'TRIPPED' : 'ACTIVE');
  setText('newOrders', s.block_new_orders ? 'BLOCKED' : 'ALLOWED');
  setText('consec', s.consecutive_losses || 0);
  setText('cool', s.cooldown_until ? new Date(s.cooldown_until).toLocaleTimeString() : 'â€”');

  // derived
  setText('k_cap', s.capital_day_915 ? fmtINR(s.capital_day_915): 'â€”');
  setText('k_pnl', `${fmtINR(s.realised||0)} / ${fmtINR(s.unrealised||0)} / ${fmtINR((s.realised||0)+(s.unrealised||0))}`);
  setText('k_pnl_sub', (s.realised||0)+(s.unrealised||0) >=0 ? 'In profit' : 'In loss');

  // rules into inputs
  $('max_loss_pct').value = s.max_loss_pct ?? 10;
  $('trail_step_profit').value = s.trail_step_profit ?? 5000;
  $('cooldown_min').value = s.cooldown_min ?? 15;
  $('max_consecutive_losses').value = s.max_consecutive_losses ?? 3;
  $('allow_new_after_lock10').value = String(s.allow_new_after_lock10 ?? false);
  $('expiry_flag').value = String(s.expiry_flag ?? false);

  // live funds
  try {
    const fundsRes = await fetchJson('/api/kite/funds');
    if(fundsRes.ok){
      const av = Number(fundsRes.balance ?? fundsRes.funds?.available?.live_balance ?? fundsRes.funds?.net ?? fundsRes.funds?.available?.cash ?? 0);
      setText('liveFunds', av ? fmtINR(av) : 'â€”');
      setText('k_balance', av ? fmtINR(av) : 'â€”');
    } else {
      // fallback to cached
      setText('k_balance', s.current_balance ? fmtINR(s.current_balance) : 'â€”');
      setText('liveFunds', s.current_balance ? fmtINR(s.current_balance) : 'â€”');
    }
  } catch(e){ setText('liveFunds','â€”'); }

  // live mtm
  try {
    const posRes = await fetchJson('/api/kite/positions');
    if(posRes.ok && posRes.positions?.net){
      const mtm = posRes.positions.net.reduce((a,p)=> a + Number(p.pnl||0), 0);
      setText('k_mtm', fmtINR(mtm));
    } else {
      setText('k_mtm', s.unrealised ? fmtINR(s.unrealised) : 'â€”');
    }
  } catch(e){ setText('k_mtm','â€”'); }

  // floor calculation display (best-effort)
  const cap = Number(s.capital_day_915 || 0);
  const maxPct = Number(s.max_loss_pct ?? 10);
  const baseFloor = -(cap * (maxPct/100));
  setText('k_floor', fmtINR(baseFloor));
  setText('k_floor_sub', `Max ${maxPct}% of capital`);
  const totalPnL = (Number(s.realised||0) + Number(s.unrealised||0));
  setText('k_remaining', fmtINR(Math.max(0, baseFloor - totalPnL)));
}

async function saveRules(){
  const token = readToken();
  if(!token){ alert('Admin token required'); return; }
  const payload = {
    max_loss_pct: Number($('max_loss_pct').value||10),
    trail_step_profit: Number($('trail_step_profit').value||5000),
    cooldown_min: Number($('cooldown_min').value||15),
    max_consecutive_losses: Number($('max_consecutive_losses').value||3),
    allow_new_after_lock10: $('allow_new_after_lock10').value === 'true',
    expiry_flag: $('expiry_flag').value === 'true'
  };
  const r = await fetch('/api/admin/rules-set', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
    body:JSON.stringify(payload)
  });
  const j = await r.json();
  if(!j.ok) alert('Save failed: '+(j.error||'unknown')); else { alert('Saved'); refresh(); }
}

async function postAction(path){
  const token = readToken();
  if(!token){ alert('Admin token required'); return; }
  const r = await fetch(path, { method:'POST', headers:{ Authorization: 'Bearer '+token } });
  const j = await r.json();
  if(!j.ok) alert('Action failed: '+(j.error||'unknown')); else { alert(j.message || 'OK'); refresh(); }
}

async function manualEnforce(){
  const token = readToken();
  const headers = token ? { 'Authorization':'Bearer '+token } : {};
  const r = await fetch('/api/enforce', { method:'POST', headers });
  const j = await r.json();
  if(!j.ok) alert('Enforce failed: '+(j.error||'unknown')); else { alert('Enforce executed'); refresh(); }
}

refresh();
setInterval(refresh, 12000);
</script>
</body>
</html>
