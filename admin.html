<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guardian — Admin</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --bg1:#0b1220;
    --bg2:#071026;
    --card:#0f1720;
    --muted:#9aa7b3;
    --accent:#3b82f6;
    --accent2:#10b981;
    --danger:#ef4444;
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02);
    --radius:14px;
  }
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background: linear-gradient(180deg,var(--bg1) 0%, #051025 45%, #03121b 100%); color:#e6eef6;}
  .wrap{max-width:980px;margin:18px auto;padding:18px;}
  header {display:flex;align-items:center;gap:18px;margin-bottom:14px}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#0b1b2e,#071225);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;box-shadow:0 6px 20px rgba(3,8,15,0.6)}
  h1{margin:0;font-size:24px}
  .status-row{margin-left:auto;display:flex;gap:12px;align-items:center}
  .badge{padding:6px 12px;border-radius:999px;background:var(--glass);font-size:13px;color:var(--muted);display:flex;gap:8px;align-items:center}
  .badge.green{background:linear-gradient(90deg,#08321a,#07301b);color:#8ff0b2}
  .badge.red{background:linear-gradient(90deg,#3a0610,#2b0510);color:#ffb3b3}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px;border-radius:var(--radius); box-shadow: 0 6px 24px rgba(2,6,12,0.6); margin-bottom:14px; border:1px solid rgba(255,255,255,0.02)}
  .controls {display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .token-row{display:flex;gap:12px;flex:1;min-width:260px}
  input[type=password], input[type=text], input[type=number]{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;outline:none}
  .btn{padding:10px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:600}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#2b6df6);color:white;box-shadow:0 6px 18px rgba(43,109,246,0.12)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .btn.warn{background:linear-gradient(90deg,#2f6f18,var(--accent2));color:white}
  .btn.danger{background:linear-gradient(90deg,#b42323,var(--danger));color:white}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .info {padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.02)}
  .info h3{margin:0;font-size:18px}
  .info p{margin:6px 0 0;color:var(--muted);font-size:13px}
  .value{font-size:20px;font-weight:700;margin-top:8px}
  .muted{color:var(--muted);font-size:13px}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  .small{font-size:12px;color:var(--muted);margin-top:8px}
  @media (max-width:720px){
    .grid{grid-template-columns:repeat(1,1fr)}
    header{flex-wrap:wrap}
    .status-row{margin-left:0}
  }
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,0.7);padding:12px 18px;border-radius:10px;color:white;z-index:999;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
  .hint{font-size:12px;color:var(--muted);margin-top:8px}
  .two-col{display:flex;gap:12px;flex-wrap:wrap}
  /* small helper for TRIPPED status */
  .tripped-pill{background:linear-gradient(90deg,#7b1220,#5a0d16);padding:6px 10px;border-radius:999px;color:#ffd6d6;font-weight:700}
  .active-pill{background:linear-gradient(90deg,#07321a,#0a3a1d);padding:6px 10px;border-radius:999px;color:#8ff0b2;font-weight:700}
  pre.log { white-space: pre-wrap; max-height:300px; overflow:auto; background:rgba(0,0,0,0.25); padding:12px; border-radius:10px; color:#eaf2ff }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">G</div>
    <div>
      <h1>Guardian — Admin</h1>
      <div class="muted">Risk automation & enforcement</div>
    </div>

    <div class="status-row">
      <div id="kite_status" class="badge">Kite: —</div>
      <div id="guardian_status" class="badge">Guardian: —</div>
      <div id="day_flag" style="display:inline-block"></div>
      <div id="now_time" class="badge">--:--:--</div>
    </div>
  </header>

  <!-- ADMIN CONTROLS -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <div style="flex:1">
        <div class="muted">Read-only mode. Enter admin token to enable changes.</div>
        <div class="controls" style="margin-top:10px;">
          <div class="token-row">
            <input id="admin_token" type="password" placeholder="ADMIN_TOKEN (password)" />
            <button id="save_token" class="btn primary">Save</button>
            <button id="clear_token" class="btn ghost">Clear</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="login_kite" class="btn ghost">Login Zerodha</button>
            <button id="refresh_btn" class="btn ghost">Refresh</button>
          </div>
        </div>
        <div class="hint">Admin-only controls unlock the action buttons below. Token is stored locally only.</div>
      </div>
    </div>

    <!-- admin actions (hidden until unlocked) -->
    <div id="admin_actions" style="margin-top:14px;display:none;">
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
        <button id="enforce_btn" class="btn warn">Enforce Now</button>
        <button id="kill_btn" class="btn danger">Kill (Close)</button>
        <button id="cancel_btn" class="btn ghost">Cancel All</button>
        <label style="display:flex;align-items:center;gap:8px;color:var(--muted);margin-left:6px;">
          <input id="allow_new" type="checkbox" /> <span class="muted">Allow New Orders</span>
        </label>
      </div>

      <!-- set capital inline (keeps your previous UX) -->
      <div style="display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap">
        <input id="set_capital_input" type="number" placeholder="Set capital (₹)" style="max-width:260px"/>
        <button id="set_capital_btn" class="btn primary">Set Capital</button>
        <button id="clear_capital" class="btn ghost">Clear</button>
      </div>

      <div id="admin_resp" class="small"></div>
    </div>
  </div>

  <!-- LIVE overview (page 1 of cards) -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Live overview</h3>
      <div><button id="refresh_top" class="btn ghost">Refresh</button></div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="info">
        <div class="muted">Capital @ 09:15</div>
        <div id="capital915" class="value">—</div>
        <div class="small">Base for daily limits</div>
      </div>

      <div class="info">
        <div class="muted">Current Balance (live/fallback)</div>
        <div id="live_balance" class="value">—</div>
        <div class="small">Uses cached if offline</div>
      </div>

      <div class="info">
        <div class="muted">Live MTM</div>
        <div id="live_mtm" class="value">—</div>
        <div class="small">Sum of position PnL</div>
      </div>

      <div class="info">
        <div class="muted">PnL (R/UR/Total)</div>
        <div id="pnl_box" class="value">—</div>
        <div class="small" id="pnl_hint">—</div>
      </div>

      <div class="info">
        <div class="muted">Consecutive Losses</div>
        <div id="consec_losses" class="value">0</div>
        <div class="small">Resets on profitable close</div>
      </div>

      <div class="info">
        <div class="muted">Max Loss (₹)</div>
        <div id="max_loss" class="value">—</div>
        <div class="small" id="max_loss_pct">—</div>
      </div>

      <div class="info">
        <div class="muted">Active Loss Floor (₹)</div>
        <div id="active_floor" class="value">—</div>
        <div class="small" id="floor_hint">—</div>
      </div>

      <div class="info">
        <div class="muted">Remaining to Max Loss (₹)</div>
        <div id="remaining_loss" class="value">—</div>
        <div class="small">Room left before floor</div>
      </div>

      <div class="info">
        <div class="muted">10% Profit Lock (₹)</div>
        <div id="p10" class="value">—</div>
        <div class="small" id="p10_hint">—</div>
      </div>

      <div class="info">
        <div class="muted">Day status</div>
        <div id="day_status_box" class="value">—</div>
        <div class="small" id="day_reason">—</div>
      </div>
    </div>
  </div>

  <!-- RULES card (admin-editable) -->
  <div class="card">
    <h3 style="margin:0">Rules (admin editable)</h3>
    <div class="muted" style="margin-top:6px">Only editable when admin token is saved.</div>

    <div class="grid" style="margin-top:12px">
      <div class="info">
        <div class="muted">Max Loss %</div>
        <input id="rule_max_loss_pct" type="number" placeholder="10" />
      </div>

      <div class="info">
        <div class="muted">Trailing step (₹)</div>
        <input id="rule_trail_step" type="number" placeholder="5000" />
      </div>

      <div class="info">
        <div class="muted">Cooldown (min)</div>
        <input id="rule_cooldown_min" type="number" placeholder="15" />
      </div>

      <div class="info">
        <div class="muted">Max consecutive losses</div>
        <input id="rule_max_consec" type="number" placeholder="3" />
      </div>

      <div class="info">
        <div class="muted">Max Profit %</div>
        <input id="rule_max_profit_pct" type="number" placeholder="10" />
      </div>

      <div class="info">
        <div class="muted">Admin override capital active</div>
        <div id="admin_override_active" class="value">—</div>
        <div class="small">If enabled, capital shown above uses override.</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-top:12px;align-items:center">
      <button id="save_rules" class="btn primary">Save Rules</button>
      <button id="reload_rules" class="btn ghost">Reload</button>
    </div>
    <div id="rules_resp" class="small"></div>
  </div>

  <!-- LOGS -->
  <div class="card">
    <h3 style="margin:0">Logs & actions</h3>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;align-items:center">
      <button id="show_err" class="btn ghost">Show Errors</button>
      <button id="show_exec" class="btn ghost">Show Executed Trades</button>
      <button id="show_all" class="btn ghost">Show All</button>
      <button id="clear_log" class="btn ghost">Clear Logs</button>
    </div>

    <div class="small muted" style="margin-top:8px">Raw request & server responses (useful for debugging)</div>
    <pre id="raw_log" class="log">—</pre>
  </div>

  <footer>Guardian • admin console</footer>
</div>

<div id="toast" style="display:none" class="toast"></div>

<script>
/**
 * Keep endpoints same as before. Added set-config for rules saving.
 */
const ENDPOINTS = {
  state: '/api/state',
  kite_login: '/api/kite/login',
  kite_funds: '/api/kite/funds',
  enforce: '/api/admin/enforce',     // keep existing
  kill: '/api/admin/kill',
  cancel: '/api/admin/cancel',
  setCapital: '/api/admin/set-capital',
  setConfig: '/api/admin/set-config' // new: save rules
};

// small helpers
const $ = id => document.getElementById(id);
const toast = (msg, t=3500) => {
  const el = $('toast'); el.textContent = msg; el.style.display='block';
  clearTimeout(el._t); el._t = setTimeout(()=>el.style.display='none', t);
};
const fmtINR = v => {
  if (v === null || v === undefined || Number.isNaN(Number(v))) return '—';
  return new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR',maximumFractionDigits:0}).format(Math.round(Number(v)));
};
const nowIST = () => new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata',hour12:false});
function getAuthHeader() {
  const tk = localStorage.getItem('ADMIN_TOKEN') || '';
  if (tk) return { 'Authorization': 'Bearer ' + tk };
  return {};
}
function setText(id, val) { const el=$(id); if(el) el.textContent = val; }

// initial wiring
document.addEventListener('DOMContentLoaded', init);

async function init(){
  // wire buttons
  $('save_token').addEventListener('click', saveToken);
  $('clear_token').addEventListener('click', clearToken);
  $('refresh_btn').addEventListener('click', loadAll);
  $('refresh_top').addEventListener('click', loadAll);
  $('login_kite').addEventListener('click', loginKite);
  $('enforce_btn').addEventListener('click', enforceNow);
  $('kill_btn').addEventListener('click', killNow);
  $('cancel_btn').addEventListener('click', cancelAll);

  $('set_capital_btn').addEventListener('click', setCapital);
  $('clear_capital').addEventListener('click', ()=>{$('set_capital_input').value='';});

  $('save_rules').addEventListener('click', saveRules);
  $('reload_rules').addEventListener('click', loadAll);

  $('show_err').addEventListener('click', ()=>filterLog('errors'));
  $('show_exec').addEventListener('click', ()=>filterLog('executed'));
  $('show_all').addEventListener('click', ()=>filterLog('all'));
  $('clear_log').addEventListener('click', ()=>{$('raw_log').textContent='—';});

  // show token if present (masked)
  const stored = localStorage.getItem('ADMIN_TOKEN');
  if (stored) {
    $('admin_token').value = stored;
    unlockAdmin();
  }

  // load data repeatedly
  await loadAll();
  setInterval(updateTime, 1000);
}

function updateTime(){ setText('now_time', nowIST()); }

function unlockAdmin(){
  $('admin_actions').style.display = 'block';
  $('admin_token').type = 'password';
  $('admin_token').value = localStorage.getItem('ADMIN_TOKEN') || $('admin_token').value;
  $('save_token').textContent = 'Save';
}

function lockAdmin(){
  $('admin_actions').style.display = 'none';
  $('admin_token').type = 'password';
}

function saveToken(){
  const v = $('admin_token').value.trim();
  if(!v){ toast('Enter admin token (password) to save'); return; }
  localStorage.setItem('ADMIN_TOKEN', v);
  unlockAdmin();
  toast('Admin token saved locally');
  loadAll();
}

function clearToken(){
  localStorage.removeItem('ADMIN_TOKEN');
  $('admin_token').value = '';
  lockAdmin();
  toast('Admin token cleared');
  loadAll();
}

// login to kite via server
async function loginKite(){
  const url = ENDPOINTS.kite_login;
  $('login_kite').disabled = true;
  try {
    let r = await fetch(url, { method: 'GET', headers: getAuthHeader() });
    if (r.status === 405 || r.status === 400) {
      r = await fetch(url, { method: 'POST', headers: { 'Content-Type':'application/json', ...getAuthHeader() } });
    }
    const json = await r.json().catch(()=>({ok:false,error:'Invalid JSON'}));
    toast('Zerodha login returned: ' + (json.ok ? 'ok' : JSON.stringify(json)));
    loadAll();
  } catch (e) {
    toast('Login failed: ' + (e.message||e));
  } finally { $('login_kite').disabled = false; }
}

// call enforce (square-off + cancel)
async function enforceNow(){
  const url = ENDPOINTS.enforce;
  $('enforce_btn').disabled = true;
  try {
    const r = await fetch(url, { method: 'GET', headers: getAuthHeader() });
    const j = await r.json().catch(()=>({ok:false,error:'Invalid JSON'}));
    $('admin_resp').textContent = 'Enforce response: ' + JSON.stringify(j);
    toast('Enforce: ' + (j.ok? 'ok' : (j.error || 'failed')));
    await loadAll();
  } catch(e){
    $('admin_resp').textContent = 'Enforce failed: ' + e.message;
    toast('Enforce failed: ' + e.message);
  } finally { $('enforce_btn').disabled = false; }
}

// kill (POST)
async function killNow(){
  if(!confirm('Kill will attempt to close running positions. Proceed?')) return;
  $('kill_btn').disabled = true;
  try {
    const r = await fetch(ENDPOINTS.kill, { method:'POST', headers: { 'Content-Type':'application/json', ...getAuthHeader() }, body: JSON.stringify({force:true}) });
    const j = await r.json().catch(()=>({ok:false,error:'Invalid JSON'}));
    $('admin_resp').textContent = 'Kill response: ' + JSON.stringify(j);
    toast('Kill: ' + (j.ok? 'ok' : JSON.stringify(j)));
    await loadAll();
  } catch(e){
    $('admin_resp').textContent = 'Kill failed: ' + e.message;
    toast('Kill failed: '+e.message);
  } finally { $('kill_btn').disabled = false; }
}

// cancel all
async function cancelAll(){
  if(!confirm('Cancel all pending orders?')) return;
  $('cancel_btn').disabled = true;
  try {
    const r = await fetch(ENDPOINTS.cancel, { method:'POST', headers: { 'Content-Type':'application/json', ...getAuthHeader() }, body: JSON.stringify({}) });
    const j = await r.json().catch(()=>({ok:false,error:'Invalid JSON'}));
    $('admin_resp').textContent = 'Cancel response: ' + JSON.stringify(j);
    toast('Cancel: ' + (j.ok? 'ok' : (j.error || 'failed')));
    await loadAll();
  } catch(e){
    $('admin_resp').textContent = 'Cancel failed: ' + e.message;
    toast('Cancel failed: '+e.message);
  } finally { $('cancel_btn').disabled = false; }
}

// set capital (admin)
async function setCapital(){
  const val = Number($('set_capital_input').value || 0);
  if (!val || isNaN(val)) { toast('Enter valid capital'); return; }
  $('set_capital_btn').disabled = true;
  try {
    const r = await fetch(ENDPOINTS.setCapital, { method:'POST', headers: { 'Content-Type':'application/json', ...getAuthHeader() }, body: JSON.stringify({ capital_day_915: val }) });
    const j = await r.json().catch(()=>({ok:false,error:'Invalid JSON'}));
    if (j.ok) {
      toast('Capital updated');
      loadAll();
    } else {
      $('admin_resp').textContent = 'Set capital failed: ' + (j.error || JSON.stringify(j));
      toast('Set capital failed: ' + (j.error || ''));
    }
  } catch (e) {
    $('admin_resp').textContent = 'Set capital failed: ' + e.message;
    toast('Set capital failed: ' + e.message);
  } finally { $('set_capital_btn').disabled = false; }
}

// save rules (admin)
async function saveRules(){
  // read values
  const payload = {
    max_loss_pct: Number($('rule_max_loss_pct').value || 0),
    trail_step_profit: Number($('rule_trail_step').value || 0),
    cooldown_min: Number($('rule_cooldown_min').value || 0),
    max_consecutive_losses: Number($('rule_max_consec').value || 0),
    p10_pct: Number($('rule_max_profit_pct').value || 0)
  };
  $('save_rules').disabled = true;
  try {
    const r = await fetch(ENDPOINTS.setConfig, { method:'POST', headers: { 'Content-Type':'application/json', ...getAuthHeader() }, body: JSON.stringify(payload) });
    const j = await r.json().catch(()=>({ok:false,error:'Invalid JSON'}));
    if (j.ok) {
      $('rules_resp').textContent = 'Rules saved';
      toast('Rules saved');
      await loadAll();
    } else {
      $('rules_resp').textContent = 'Save failed: ' + (j.error || JSON.stringify(j));
      toast('Save failed: ' + (j.error || ''));
    }
  } catch(e){
    $('rules_resp').textContent = 'Save failed: ' + e.message;
    toast('Save failed: ' + e.message);
  } finally { $('save_rules').disabled = false; }
}

// load state + funds
async function loadAll(){
  updateTime();
  await Promise.allSettled([ loadState(), loadFunds() ]);
}

// load public/admin state
async function loadState(){
  // clear placeholders
  setText('capital915','—'); setText('live_mtm','—'); setText('pnl_box','—'); setText('pnl_hint','');
  try {
    const r = await fetch(ENDPOINTS.state, { method: 'GET', headers: getAuthHeader() });
    const j = await r.json();
    if(!j || !j.ok){ setText('guardian_status','—'); setText('kite_status','—'); if(j && j.error) toast('State error: '+j.error); return; }

    // time & kite status
    setText('now_time', j.time || nowIST());
    setText('guardian_status', j.admin ? 'admin' : 'online');
    $('kite_status').textContent = j.kite_status === 'ok' ? 'Kite: Connected' : (j.kite_status || 'Kite: not_logged_in');

    const s = j.state || {};
    // capital: server may have admin override already applied (server-side)
    setText('capital915', fmtINR(Number(s.capital_day_915 ?? 0)));
    setText('consec_losses', (s.consecutive_losses ?? 0).toString());
    setText('cooldown_until', s.cooldown_until ? new Date(s.cooldown_until).toLocaleString() : '—');
    setText('expiry_flag', s.expiry_flag ? 'YES' : 'NO');

    // PnL: realised/unrealised/total
    const realised = Number(s.realised ?? 0);
    const unreal = Number(s.unrealised ?? 0);
    const total = realised + unreal;
    setText('pnl_box', `${fmtINR(realised)} / ${fmtINR(unreal)} / ${fmtINR(total)}`);
    setText('pnl_hint', total < 0 ? 'In loss' : (total>0?'In profit':'—'));

    // limits & floor
    const maxLossAmt = ((s.capital_day_915||0) * ((s.max_loss_pct ?? 10)/100)) || 0;
    setText('max_loss', fmtINR(maxLossAmt));
    setText('max_loss_pct', `Max Loss %: ${(s.max_loss_pct ?? 10).toFixed(2)}%`);
    setText('active_floor', fmtINR(s.active_loss_floor ?? 0));
    setText('remaining_loss', fmtINR((s.capital_day_915 ?? 0) - Math.abs(total)));

    // p10 display: if server stores percent, show percent; if rupee, keep
    if (typeof s.p10 === 'number' && s.p10 > 1000) {
      // older shape: rupee number
      setText('p10', fmtINR(s.p10));
      setText('p10_hint','(fixed rupees)');
    } else {
      setText('p10', (s.p10 || 0) + '%');
      setText('p10_hint','(percentage)');
    }

    // day status
    const tripped = !!s.tripped_day;
    $('day_flag').innerHTML = tripped ? '<span class="tripped-pill">TRIPPED</span>' : '<span class="active-pill">ACTIVE</span>';
    setText('day_status_box', tripped ? 'TRIPPED' : 'ACTIVE');
    setText('day_reason', s.trip_reason ? s.trip_reason : '-');

    // rules populate
    $('rule_max_loss_pct').value = s.max_loss_pct ?? '';
    $('rule_trail_step').value = s.trail_step_profit ?? '';
    $('rule_cooldown_min').value = s.cooldown_min ?? '';
    $('rule_max_consec').value = s.max_consecutive_losses ?? '';
    // prefer p10_pct or p10 numeric
    $('rule_max_profit_pct').value = (s.p10 || s.p10_pct || '');

    // admin override indicator: server provides admin_override_capital flag if override used
    if (typeof s.admin_override_capital !== 'undefined') {
      setText('admin_override_active', s.admin_override_capital ? 'YES' : 'NO');
    } else {
      setText('admin_override_active', 'NO');
    }

    // show admin actions if server says admin
    if (j.admin) unlockAdmin(); else lockAdmin();

  } catch (e){
    console.error('loadState error',e);
    toast('Failed to load state: ' + (e.message||e));
  }
}

// load kite funds (with fallback)
async function loadFunds(){
  setText('broker_balance','—');
  try {
    const r = await fetch(ENDPOINTS.kite_funds, { method:'GET', headers: getAuthHeader() });
    const j = await r.json();
    if(!j || j.ok === false){
      const cached = await fetch(ENDPOINTS.state, { method:'GET' }).then(res=>res.json()).catch(()=>null);
      const val = cached?.state?.current_balance ?? cached?.state?.capital_day_915 ?? 0;
      setText('live_balance', fmtINR(val));
      setText('broker_balance', j && j.error ? 'ERR: ' + j.error : '—');
      return;
    }
    let av = null;
    if (j.funds && j.funds.available && typeof j.funds.available.live_balance !== 'undefined') av = j.funds.available.live_balance;
    else if (j.funds && typeof j.funds.net !== 'undefined') av = j.funds.net;
    else if (typeof j.balance !== 'undefined') av = j.balance;
    else if (j.funds && j.funds.available && typeof j.funds.available.cash !== 'undefined') av = j.funds.available.cash;
    setText('live_balance', fmtINR(av ?? (j.balance ?? '—')));
    setText('broker_balance', fmtINR(av ?? (j.balance ?? 0)));
  } catch (e){
    console.warn('loadFunds fail',e);
    const cached = await fetch(ENDPOINTS.state, { method:'GET' }).then(res=>res.json()).catch(()=>null);
    const val = cached?.state?.current_balance ?? cached?.state?.capital_day_915 ?? 0;
    setText('live_balance', fmtINR(val));
    setText('broker_balance','—');
  }
}

/* small client log filter — only minimal client-side functionality: errors/executed if available */
function filterLog(mode){
  // server logs are appended raw in raw_log; we just filter by simple heuristics
  const raw = $('raw_log').textContent || '';
  if (!raw || raw === '—') return;
  if (mode === 'all') { /* show original */ $('raw_log').textContent = raw; return; }
  const lines = raw.split('\n').filter(Boolean);
  const out = lines.filter(l=>{
    if (mode==='errors') return /error|failed|ERR|Invalid JSON/i.test(l);
    if (mode==='executed') return /trade|executed|filled|filled_qty|order_id/i.test(l);
    return true;
  });
  $('raw_log').textContent = out.join('\n') || '—';
}

// append to raw log visible area
function appendLog(msg){
  const el = $('raw_log');
  const stamp = '[' + nowIST() + '] ';
  el.textContent = stamp + msg + '\n' + (el.textContent === '—' ? '' : el.textContent);
}
</script>
</body>
</html>
