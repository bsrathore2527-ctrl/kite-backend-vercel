<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guardian — Admin</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --bg:#071022; --card:#0f1724; --muted:#9aa7b3; --accent:#3b82f6;
    --accent2:#10b981; --danger:#ef4444; --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02); --radius:14px;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#061123 0%, #071022 40%, #05060a 100%);font-family:Inter,Arial;color:#e6eef8}
  .wrap{max-width:980px;margin:18px auto;padding:18px;}
  header{display:flex;align-items:center;gap:18px;margin-bottom:14px}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#0b1b2e,#071225);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
  h1{margin:0;font-size:24px}
  .status-row{margin-left:auto;display:flex;gap:12px;align-items:center}
  .badge{padding:6px 12px;border-radius:999px;background:var(--glass);font-size:13px;color:var(--muted);display:flex;gap:8px;align-items:center}
  .badge.green{background:linear-gradient(90deg,#08321a,#07301b);color:#8ff0b2}
  .badge.red{background:linear-gradient(90deg,#3a0610,#2b0510);color:#ffb3b3}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px;border-radius:var(--radius); box-shadow: 0 6px 24px rgba(2,6,12,0.6); margin-bottom:14px; border:1px solid rgba(255,255,255,0.02)}
  .controls {display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .token-row{display:flex;gap:12px;flex:1;min-width:260px}
  input[type=password], input[type=text], input[type=number]{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;outline:none}
  .btn{padding:10px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:600}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#2b6df6);color:white;box-shadow:0 6px 18px rgba(43,109,246,0.12)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .btn.warn{background:linear-gradient(90deg,#2f6f18,var(--accent2));color:white}
  .btn.danger{background:linear-gradient(90deg,#b42323,var(--danger));color:white}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .info {padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.02)}
  .info h3{margin:0;font-size:18px}
  .info p{margin:6px 0 0;color:var(--muted);font-size:13px}
  .value{font-size:20px;font-weight:700;margin-top:8px}
  .muted{color:var(--muted);font-size:13px}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  .small{font-size:12px;color:var(--muted);margin-top:8px}
  @media (max-width:720px){
    .grid{grid-template-columns:repeat(1,1fr)}
    header{flex-wrap:wrap}
    .status-row{margin-left:0}
  }
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,0.7);padding:12px 18px;border-radius:10px;color:white;z-index:999;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
  pre.log{white-space:pre-wrap;background:rgba(0,0,0,0.12);padding:12px;border-radius:8px;margin-top:8px;max-height:300px;overflow:auto;color:#ffdede}
  .pages{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;gap:18px;padding-bottom:12px}
  .page{min-width:100%;scroll-snap-align:center}
  .pager-nav{display:flex;gap:8px;justify-content:center;margin-top:8px}
  .status-pill {display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700}
  .status-active {background:linear-gradient(90deg,#08321a,#07301b); color:#8ff0b2}
  .status-tripped {background:linear-gradient(90deg,#3a0610,#2b0510); color:#ffb3b3}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">G</div>
    <div>
      <h1>Guardian — Admin</h1>
      <div class="muted">Risk automation & enforcement</div>
    </div>

    <div class="status-row">
      <div id="kite_status" class="badge">Kite: —</div>
      <div id="guardian_status" class="badge">Guardian: —</div>
      <div id="now_time" class="badge">--:--:--</div>
    </div>
  </header>

  <!-- ADMIN CONTROLS -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <div style="flex:1">
        <div class="muted">Read-only mode. Enter admin token to enable changes.</div>
        <div class="controls" style="margin-top:10px;">
          <div class="token-row">
            <input id="admin_token" type="password" placeholder="ADMIN_TOKEN (password)" />
            <button id="toggle_token" class="btn ghost">Show</button>
            <button id="save_token" class="btn primary">Save</button>
            <button id="clear_token" class="btn ghost">Clear</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="login_kite" class="btn ghost">Login Zerodha</button>
            <button id="refresh_btn" class="btn ghost">Refresh</button>
          </div>
        </div>
        <div class="hint small" style="margin-top:8px">Admin-only controls unlock the action buttons below. Token stored locally only.</div>
      </div>
    </div>

    <!-- admin actions (hidden until unlocked) -->
    <div id="admin_actions" style="margin-top:14px;display:none;">
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
        <button id="enforce_btn" class="btn warn">Enforce Now</button>
        <button id="kill_btn" class="btn danger">Kill (Close)</button>
        <button id="cancel_btn" class="btn ghost">Cancel All</button>
        <label style="display:flex;align-items:center;gap:8px;color:var(--muted);margin-left:6px;">
          <input id="allow_new" type="checkbox" /> <span class="muted">Allow New Orders</span>
        </label>
      </div>

      <div style="margin-top:12px">
        <div class="muted">Override capital (applies today)</div>
        <div class="row" style="margin-top:6px">
          <input id="capital_input" type="text" placeholder="Enter amount" />
          <button id="set_capital_btn" class="btn primary">Set Capital</button>
          <button id="clear_capital_btn" class="btn ghost">Clear</button>
        </div>
        <div id="set_capital_msg" class="small" style="margin-top:6px"></div>
      </div>

      <div style="margin-top:12px">
        <div class="muted">Behavioral config</div>
        <div class="row" style="margin-top:6px;align-items:center">
          <label class="small muted"><input id="cfg_cooldown_on_profit" type="checkbox" /> Cooldown on profit</label>
          <label class="small muted">Min loss to count (₹) <input id="cfg_min_loss_to_count" type="number" min="0" style="width:90px;margin-left:6px" /></label>
          <button id="save_cfg_btn" class="btn primary">Save Config</button>
          <div id="save_cfg_msg" class="small" style="margin-left:8px"></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="reset_day_btn" class="btn ghost">Reset Day</button>
        <div id="admin_resp" class="small" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- swipeable pages -->
  <div class="pages" id="pages">
    <div class="page card">
      <h2 style="margin-top:0">Live overview <button id="refresh_stats" class="btn ghost small" style="float:right">Refresh</button></h2>
      <div class="grid" id="stats_grid" style="margin-top:12px">
        <div class="info">
          <div class="muted">Capital @ 09:15</div>
          <div class="value" id="capital915">—</div>
          <div class="small">Base for daily limits</div>
        </div>
        <div class="info">
          <div class="muted">Current Balance (live/fallback)</div>
          <div class="value" id="live_balance">—</div>
          <div class="small">Uses cached if offline</div>
        </div>
        <div class="info">
          <div class="muted">Live MTM</div>
          <div class="value" id="live_mtm">—</div>
          <div class="small">Sum of position PnL</div>
        </div>
        <div class="info">
          <div class="muted">PnL (R/UR/Total)</div>
          <div class="value" id="pnl_info">—</div>
          <div class="small">Realtime</div>
        </div>
        <div class="info">
          <div class="muted">Consecutive Losses</div>
          <div class="value" id="consec_losses">0</div>
          <div class="small">Resets on profitable close (configurable)</div>
        </div>
        <div class="info">
          <div class="muted">Max Loss (₹)</div>
          <div class="value" id="max_loss">—</div>
          <div class="small" id="max_loss_pct">—</div>
        </div>
        <div class="info">
          <div class="muted">Max Profit %</div>
          <div class="value" id="p10">—</div>
          <div class="small" id="p10_hint">Profit lock status</div>
        </div>
        <div class="info">
          <div class="muted">Active Loss Floor (₹)</div>
          <div class="value" id="active_floor">—</div>
          <div class="small" id="floor_hint">—</div>
        </div>
        <div class="info">
          <div class="muted">Remaining to Max Loss (₹)</div>
          <div class="value" id="remaining_loss">—</div>
          <div class="small">Room left before floor</div>
        </div>
        <div class="info">
          <div class="muted">Last Trade @</div>
          <div class="value" id="last_trade">—</div>
          <div class="small">Blank if none</div>
        </div>
      </div>
    </div>

    <div class="page card">
      <h2 style="margin-top:0">Rules (editable by admin)</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label class="muted">Max Loss %</label>
          <input id="rule_max_loss_pct" type="number" placeholder="10" />
        </div>
        <div>
          <label class="muted">Trailing step (₹)</label>
          <input id="rule_trail_step" type="number" placeholder="5000" />
        </div>
        <div>
          <label class="muted">Cooldown (min)</label>
          <input id="rule_cooldown_min" type="number" placeholder="15" />
        </div>
        <div>
          <label class="muted">Max consecutive losses</label>
          <input id="rule_max_consec" type="number" placeholder="3" />
        </div>

        <div>
          <label class="muted">Max Profit % (p10)</label>
          <input id="rule_p10_amount" type="number" placeholder="e.g. 10" />
        </div>

        <div>
          <div class="muted">Day status (read-only)</div>
          <div id="rule_day_status" class="muted">—</div>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <button id="save_rules_btn" class="btn primary">Save Rules</button>
        <div id="save_rules_msg" class="small" style="margin-left:8px"></div>
      </div>

      <div class="small muted" style="margin-top:8px">Only editable when admin token is saved. Saving posts to <code>/api/admin/set-config</code>.</div>
    </div>

    <div class="page card">
      <h2 style="margin-top:0">Logs & actions</h2>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <button id="enforce_trades_btn" class="btn ghost">Enforce Trades</button>
        <button id="cancel_all_btn" class="btn ghost">Cancel All</button>
        <button id="kill_btn2" class="btn danger">Kill</button>
        <button id="clear_logs" class="btn ghost">Clear Logs</button>
      </div>

      <div style="margin-top:12px">
        <div class="muted">Server responses & request log</div>
        <pre id="raw_responses" class="log">—</pre>
      </div>
    </div>
  </div>

  <div class="pager-nav">
    <button id="prev_page" class="btn ghost">⟨ Prev</button>
    <button id="next_page" class="btn ghost">Next ⟩</button>
  </div>

  <footer>Guardian • admin console</footer>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
/* ----------------------------
   Admin UI script (complete)
   ---------------------------- */

/* Endpoints - keep these unless your routes differ */
const ENDPOINTS = {
  state: '/api/state',
  kite_funds: '/api/kite/funds',
  kite_login: '/api/kite/login',
  set_config: '/api/admin/set-config',
  enforce: '/api/enforce',
  admin_kill: '/api/admin/kill',
  admin_cancel: '/api/admin/cancel',
  set_capital_candidates: ['/api/admin/set-capital','/api/admin/set_capital','/api/admin/setcapital','/api/admin/set-captial']
};

/* small util */
const $ = id => document.getElementById(id);
function toast(msg, t=3000){ const el=$('toast'); el.textContent=msg; el.style.display='block'; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none', t); }
function logLine(s){ const pre = $('raw_responses'); pre.textContent = `[${new Date().toLocaleTimeString()}] ${s}\n\n` + pre.textContent; }

/* pager controls */
const pages = Array.from(document.querySelectorAll('.page'));
let pageIndex = 0;
function go(idx){ pageIndex = Math.max(0, Math.min(pages.length-1, idx)); pages[pageIndex].scrollIntoView({behavior:'smooth'}); }
$('prev_page').addEventListener('click', ()=> go(pageIndex-1));
$('next_page').addEventListener('click', ()=> go(pageIndex+1));
document.addEventListener('keydown', e=>{ if(e.key==='ArrowLeft') go(pageIndex-1); if(e.key==='ArrowRight') go(pageIndex+1); });

/* authorization */
function authHeader(){ const tk = localStorage.getItem('ADMIN_TOKEN') || ''; return tk ? { 'Authorization': tk.startsWith('Bearer ') ? tk : 'Bearer '+tk } : {}; }

/* initial wiring */
document.addEventListener('DOMContentLoaded', init);

function init(){
  // token buttons
  $('save_token').addEventListener('click', saveToken);
  $('clear_token').addEventListener('click', clearToken);
  $('toggle_token').addEventListener('click', toggleToken);

  // system buttons
  $('login_kite').addEventListener('click', loginKite);
  $('refresh_btn').addEventListener('click', loadAll);
  $('refresh_stats').addEventListener('click', loadAll);

  // admin actions
  $('enforce_btn').addEventListener('click', enforceNow);
  $('enforce_trades_btn').addEventListener('click', enforceNow);
  $('kill_btn').addEventListener('click', killNow);
  $('kill_btn2').addEventListener('click', killNow);
  $('cancel_btn').addEventListener('click', cancelAll);
  $('cancel_all_btn').addEventListener('click', cancelAll);
  $('set_capital_btn').addEventListener('click', setCapital);
  $('clear_capital_btn').addEventListener('click', ()=>{ $('capital_input').value=''; $('set_capital_msg').textContent=''; });

  $('save_cfg_btn') && $('save_cfg_btn').addEventListener('click', saveConfig);
  $('save_rules_btn').addEventListener('click', saveRules);

  $('reset_day_btn').addEventListener('click', resetDay);

  $('filter_trades')?.addEventListener('click', showExecutedTrades);
  $('filter_errors')?.addEventListener('click', showOnlyErrors);
  $('filter_all')?.addEventListener('click', showAllLogs);
  $('clear_logs').addEventListener('click', ()=> $('raw_responses').textContent = '');

  applyTokenUI();
  if(localStorage.getItem('ADMIN_TOKEN')) enableAdmin(true);

  loadAll();
  // show local IST clock every 10 seconds (matches backend time display expectation)
  setInterval(()=> $('now_time').textContent = new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata',hour12:false}), 10000);
}

/* token helpers */
function applyTokenUI(){ const t = localStorage.getItem('ADMIN_TOKEN'); if(t){ $('admin_token').value='*******'; $('admin_token').dataset.saved='1'; } else { $('admin_token').value=''; $('admin_token').dataset.saved='0'; } }
function saveToken(){ const val = $('admin_token').value.trim(); if($('admin_token').dataset.saved==='1' && val==='*******'){ toast('Token already saved'); return; } if(!val){ toast('Enter token'); return; } localStorage.setItem('ADMIN_TOKEN', val); $('admin_token').value='*******'; $('admin_token').dataset.saved='1'; enableAdmin(true); toast('Token saved (local)'); loadAll(); }
function clearToken(){ localStorage.removeItem('ADMIN_TOKEN'); $('admin_token').value=''; $('admin_token').dataset.saved='0'; enableAdmin(false); toast('Admin token cleared'); }
function toggleToken(){ const saved = localStorage.getItem('ADMIN_TOKEN'); if(saved){ $('admin_token').type='text'; $('admin_token').value=saved; setTimeout(()=>{ $('admin_token').type='password'; $('admin_token').value='*******'; }, 3500); } else { $('admin_token').type = $('admin_token').type==='password' ? 'text' : 'password'; } }
function enableAdmin(v){ const el = $('admin_actions'); if(!el) return; el.style.display = v ? 'block' : 'none'; const arr = ['enforce_btn','kill_btn','cancel_btn','set_capital_btn','save_cfg_btn','save_rules_btn','reset_day_btn']; arr.forEach(id=>{ const b=$(id); if(b) b.disabled = !v; }); }

/* try multiple endpoints helper */
async function tryEndpoints(list, options={method:'POST', body:{}}){
  for(const p of list){
    try{
      const headers = { ...(options.headers||{}), ...authHeader() };
      let init = { method: options.method, headers };
      if(options.body !== undefined){
        headers['Content-Type'] = headers['Content-Type'] || 'application/json';
        init.body = typeof options.body === 'string' ? options.body : JSON.stringify(options.body);
      }
      const r = await fetch(p, init);
      const txt = await r.text().catch(()=>null);
      logLine(`${options.method} ${p} => ${txt || r.status}`);
      if(r.status !== 404) return { path:p, status:r.status, text: txt, ok:r.ok, json: (()=>{ try{ return txt ? JSON.parse(txt) : null }catch(e){ return null } })() };
    }catch(e){ logLine(`fetch ${p} failed: ${e.message}`); }
  }
  return { ok:false, error:'no candidate' };
}

/* login to kite */
async function loginKite(){
  $('login_kite').disabled = true;
  try{
    let r = await fetch(ENDPOINTS.kite_login, { method:'GET', headers: authHeader() });
    if(r.status === 405 || r.status === 400){
      r = await fetch(ENDPOINTS.kite_login, { method:'POST', headers: {'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify({}) });
    }
    const txt = await r.text().catch(()=>null);
    logLine(`login => ${txt || r.status}`);
    let json=null; try{ json = txt ? JSON.parse(txt) : null }catch(e){}
    if(json && json.ok && json.url){ window.open(json.url,'_blank'); toast('Opened kite login'); } else toast('Login result: see logs');
    await loadAll();
  }catch(e){ toast('Login failed: '+(e.message||e)); logLine('login error: '+(e.message||e)); }
  finally{ $('login_kite').disabled = false; }
}

/* enforce, kill, cancel */
async function enforceNow(){
  const btn = $('enforce_btn'); btn.disabled=true;
  try{
    const r = await fetch(ENDPOINTS.enforce, { method:'GET', headers: authHeader() });
    const txt = await r.text().catch(()=>null);
    logLine(`GET /api/enforce => ${txt || r.status}`);
    toast('Enforce called');
    await loadAll();
  }catch(e){ logLine('enforce err: '+e.message); toast('Enforce failed'); }
  finally{ btn.disabled=false; }
}

async function killNow(){
  if(!confirm('Kill will attempt to close running positions. Proceed?')) return;
  const btn = $('kill_btn'); btn.disabled = true;
  try{
    const r = await fetch(ENDPOINTS.admin_kill, { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify({ force:true }) });
    const txt = await r.text().catch(()=>null);
    logLine(`POST ${ENDPOINTS.admin_kill} => ${txt || r.status}`);
    toast('Kill called');
    await loadAll();
  }catch(e){ logLine('kill err: '+e.message); toast('Kill failed'); }
  finally{ btn.disabled=false; }
}

async function cancelAll(){
  if(!confirm('Cancel all pending orders?')) return;
  const btn = $('cancel_btn'); btn.disabled = true;
  try{
    const r = await fetch(ENDPOINTS.admin_cancel, { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify({}) });
    const txt = await r.text().catch(()=>null);
    logLine(`POST ${ENDPOINTS.admin_cancel} => ${txt || r.status}`);
    toast('Cancel called');
    await loadAll();
  }catch(e){ logLine('cancel err: '+e.message); toast('Cancel failed'); }
  finally{ btn.disabled=false; }
}

/* set capital */
async function setCapital(){
  const raw = $('capital_input').value.trim();
  if(!raw){ $('set_capital_msg').textContent='Enter capital'; return; }
  const val = Number(String(raw).replace(/[^0-9.-]/g,'')); if(isNaN(val)){ $('set_capital_msg').textContent='Invalid number'; return; }
  $('set_capital_msg').textContent='Setting...'; $('set_capital_btn').disabled=true;
  try{
    const res = await tryEndpoints(ENDPOINTS.set_capital_candidates, { method:'POST', body:{ capital: val } });
    if(res.json && res.json.ok){ $('set_capital_msg').textContent='Set capital OK'; toast('Set capital OK'); }
    else { $('set_capital_msg').textContent = 'Failed: ' + (res.json && res.json.error ? res.json.error : (res.error||'no response')); toast('Set capital failed'); }
    await loadAll();
  }catch(e){ $('set_capital_msg').textContent='Error: '+e.message; logLine('setCapital err: '+e.message); }
  finally{ $('set_capital_btn').disabled=false; }
}

/* Save rules */
async function saveRules(){
  const btn = $('save_rules_btn'); btn.disabled = true; $('save_rules_msg').textContent='Saving...';
  const payload = {
    max_loss_pct: Number($('rule_max_loss_pct').value || 0),
    trail_step_profit: Number($('rule_trail_step').value || 0),
    cooldown_min: Number($('rule_cooldown_min').value || 0),
    max_consecutive_losses: Number($('rule_max_consec').value || 0),
    p10: Number($('rule_p10_amount').value || 0),
    p10_is_pct: true
  };
  try{
    const r = await fetch(ENDPOINTS.set_config, { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify(payload) });
    const txt = await r.text().catch(()=>null); let j=null; try{ j = txt ? JSON.parse(txt) : null }catch(e){}
    logLine(`POST ${ENDPOINTS.set_config} => ${txt || r.status}`);
    if(j && j.ok){ $('save_rules_msg').textContent='Saved'; toast('Rules saved'); setTimeout(()=> $('save_rules_msg').textContent='',2000); await loadAll(); }
    else { $('save_rules_msg').textContent='Save failed'; toast('Save failed'); }
  }catch(e){ $('save_rules_msg').textContent='Error'; logLine('saveRules err: '+e.message); }
  finally{ btn.disabled = false; }
}

/* Save config (cooldown_on_profit, min_loss_to_count, allow_new) */
async function saveConfig(){
  const btn = $('save_cfg_btn'); if(!btn) return;
  btn.disabled=true; $('save_cfg_msg').textContent='Saving...';
  const payload = { cooldown_on_profit: !!$('cfg_cooldown_on_profit').checked, min_loss_to_count: Number($('cfg_min_loss_to_count').value || 0), allow_new: !!$('allow_new').checked };
  try{
    const r = await fetch(ENDPOINTS.set_config, { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify(payload) });
    const txt = await r.text().catch(()=>null); let j=null; try{ j = txt ? JSON.parse(txt) : null }catch(e){}
    logLine(`POST ${ENDPOINTS.set_config} => ${txt || r.status}`);
    if(j && j.ok){ $('save_cfg_msg').textContent='Saved'; toast('Config saved'); setTimeout(()=> $('save_cfg_msg').textContent='',2000); loadAll(); }
    else{ $('save_cfg_msg').textContent='Save failed'; toast('Save failed'); }
  }catch(e){ $('save_cfg_msg').textContent='Error'; logLine('saveConfig err: '+e.message); }
  finally{ btn.disabled=false; }
}

/* Reset day inline handler (no extra endpoint needed) */
async function resetDay(){
  if(!confirm('Reset today? OK = preserve losses, Cancel = reset losses to 0')) return;
  const preserve = confirm('Click OK to PRESERVE consecutive losses, Cancel to reset consecutive losses to 0.');
  try{
    const r = await fetch(ENDPOINTS.set_config, { method:'POST', headers:{ 'Content-Type':'application/json', ...authHeader() }, body: JSON.stringify({ reset_day: true, preserve_losses: preserve }) });
    const txt = await r.text().catch(()=>null);
    logLine(`POST ${ENDPOINTS.set_config} => ${txt || r.status}`);
    toast('Reset triggered');
    await loadAll();
  }catch(e){ logLine('resetDay err: '+e.message); toast('Reset failed'); }
}

/* load state & funds */
async function loadAll(){ await Promise.allSettled([ loadState(), loadFunds() ]); }

async function loadState(){
  try{
    const r = await fetch(ENDPOINTS.state, { method: 'GET', headers: authHeader() });
    const txt = await r.text().catch(()=>null); let j=null; try{ j = txt ? JSON.parse(txt) : null }catch(e){}
    logLine(`GET ${ENDPOINTS.state} => ${txt || r.status}`);
    if(!j || !j.ok){ toast('Failed load state'); return; }

    $('now_time').textContent = j.time || new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata',hour12:false});
    $('guardian_status').textContent = j.admin ? 'admin' : 'online';
    $('kite_status').textContent = j.kite_status === 'ok' ? 'Kite: Connected' : (j.kite_status || 'not_logged_in');

    const s = j.state || {};
    $('capital915').textContent = s.capital_day_915 ? '₹' + Number(s.capital_day_915).toLocaleString('en-IN') : '—';
    $('consec_losses').textContent = (s.consecutive_losses ?? 0).toString();
    $('last_trade').textContent = s.last_trade_time ? new Date(Number(s.last_trade_time)).toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata',hour12:false}) : '—';

    // PnL
    const realised = Number(s.realised ?? 0);
    const unreal = Number(s.unrealised ?? 0);
    const total = realised + unreal;
    $('pnl_info').textContent = `${formatINR(realised)} / ${formatINR(unreal)} / ${formatINR(total)}`;
    $('live_mtm').textContent = formatINR(unreal);

    // balances
    $('live_balance').textContent = formatINR(s.live_balance ?? s.current_balance ?? 0);

    // limits & floor
    const cap = Number(s.capital_day_915 || 0);
    const maxLossPct = Number(s.max_loss_pct ?? 10);
    const maxLossAbs = Math.round(cap * maxLossPct / 100);
    $('max_loss').textContent = formatINR(s.max_loss_abs ?? maxLossAbs);
    $('max_loss_pct').textContent = `Max Loss %: ${maxLossPct}%`;

    // p10 display: prefer p10 (percentage) else p10_amount
    let p10display = '—';
    if(typeof s.p10 !== 'undefined') p10display = String(s.p10) + '%';
    else if(typeof s.p10_amount !== 'undefined') p10display = formatINR(s.p10_amount);
    else p10display = (s.p10_amount || s.p10) ? String(s.p10_amount || s.p10) : '—';
    $('p10').textContent = p10display;

    $('active_floor').textContent = formatINR(s.active_loss_floor ?? s.active_loss_floor ?? 0);
    $('remaining_loss').textContent = formatINR(s.remaining_to_max_loss ?? 0);

    // show/hide admin actions depending on token/server
    if (j.admin) enableAdmin(true);
    else if(localStorage.getItem('ADMIN_TOKEN')) enableAdmin(true);
    else enableAdmin(false);

  }catch(e){ logLine('loadState err: '+(e.message||e)); toast('State load failed'); }
}

async function loadFunds(){
  try{
    const r = await fetch(ENDPOINTS.kite_funds, { method:'GET', headers: authHeader() });
    const txt = await r.text().catch(()=>null); let j=null; try{ j = txt ? JSON.parse(txt) : null }catch(e){}
    logLine(`GET ${ENDPOINTS.kite_funds} => ${txt || r.status}`);
    if(!j || j.ok === false){
      const cached = await fetch(ENDPOINTS.state, { method:'GET' }).then(res=>res.json()).catch(()=>null);
      const val = cached?.state?.current_balance ?? cached?.state?.capital_day_915 ?? 0;
      $('live_balance').textContent = formatINR(val);
      return;
    }
    let av = null;
    if (j.funds && j.funds.available && typeof j.funds.available.live_balance !== 'undefined') av = j.funds.available.live_balance;
    else if (j.funds && typeof j.funds.net !== 'undefined') av = j.funds.net;
    else if (typeof j.balance !== 'undefined') av = j.balance;
    else if (j.funds && j.funds.available && typeof j.funds.available.cash !== 'undefined') av = j.funds.available.cash;
    $('live_balance').textContent = formatINR(av ?? (j.balance ?? 0));
  }catch(e){ logLine('loadFunds err: '+(e.message||e)); const cached = await fetch(ENDPOINTS.state).then(r=>r.json()).catch(()=>null); const val = cached?.state?.current_balance ?? cached?.state?.capital_day_915 ?? 0; $('live_balance').textContent = formatINR(val); }
}

/* Logs helpers (simple) */
function getRawLogLines(){ const pre = $('raw_responses'); if(!pre) return []; return pre.textContent.split(/\n{1,}/).filter(Boolean).map(s=>s.trim()); }
function showAllLogs(){ toast('Showing all logs'); }
function showOnlyErrors(){ const pre = $('raw_responses'); if(!pre) return; const lines = getRawLogLines(); const filtered = lines.filter(l => /error|err[:\s]|failed|4\d{2}|5\d{2}|\"ok\":\s*false/i.test(l)); pre.textContent = filtered.join('\n\n') || '—'; toast('Filtered: errors'); }
async function showExecutedTrades(){ toast('Showing trades — fallback to logs (server endpoint optional)'); }

/* small utils */
function formatINR(v){ if(v==null||isNaN(Number(v))) return '—'; return '₹' + Number(v).toLocaleString('en-IN',{maximumFractionDigits:0}); }

/* general helpers */
function logLineSafe(s){ try{ logLine(s); }catch(e){} }

/* initial load */
window.addEventListener('load', ()=>{
  applyTokenUI();
  if(localStorage.getItem('ADMIN_TOKEN')) enableAdmin(true);
  loadAll();
  setInterval(()=> $('now_time').textContent = new Date().toLocaleTimeString('en-IN',{timeZone:'Asia/Kolkata',hour12:false}), 10000);
});
</script>
</body>
  </html>
