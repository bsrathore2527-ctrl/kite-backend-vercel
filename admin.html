<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guardian â€¢ Admin / Trader</title>
<style>
:root{--bg:#0b0d14;--fg:#e6eef8;--muted:#98a3b3;--card:#0f1724;--accent:#3b82f6}
body{margin:0;background:linear-gradient(180deg,#071022,#07121b);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1100px;margin:18px auto;padding:12px}
.header{display:flex;align-items:center;gap:12px}
.title{font-weight:800;font-size:18px}
.badge{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:13px}
.card{background:linear-gradient(180deg,#071623,#081024);border:1px solid rgba(255,255,255,0.03);border-radius:10px;padding:12px;margin-top:12px}
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)}
.row{display:flex;gap:10px;margin-top:10px}
.btn{padding:10px;border-radius:8px;border:none;cursor:pointer}
.btn-primary{background:linear-gradient(180deg,#1e40af,#19399b);color:white}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--fg)}
.small{font-size:12px;color:var(--muted)}
.pill{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px}
.input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--fg)}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">ðŸ›¡ Guardian</div>
    <div class="badge" id="kiteBadge">Zerodha: â€”</div>
    <div class="badge" id="guardBadge">Guardian: â€”</div>
    <div style="margin-left:auto" id="now" class="small"></div>
  </div>

  <div class="card">
    <div style="display:flex;gap:10px;align-items:center">
      <input id="token" class="input" placeholder="ADMIN_TOKEN" />
      <button class="btn btn-primary" onclick="saveToken()">Save Token</button>
      <a href="/api/login"><button class="btn btn-ghost">Login Zerodha</button></a>
      <button class="btn btn-ghost" onclick="clearToken()">Clear Token</button>
      <button class="btn btn-ghost" onclick="refresh()">Refresh</button>
    </div>

    <div class="kpis" style="margin-top:12px">
      <div class="kpi"><div class="small">Capital @ 09:15</div><div id="k_cap" style="font-weight:800">â€”</div></div>
      <div class="kpi"><div class="small">Current Balance (live/fallback)</div><div id="k_live" style="font-weight:800">â€”</div></div>
      <div class="kpi"><div class="small">Live MTM</div><div id="k_mtm" style="font-weight:800">â€”</div></div>

      <div class="kpi"><div class="small">PnL (R/UR/Total)</div><div id="k_pnl" style="font-weight:800">â€”</div></div>
      <div class="kpi"><div class="small">Active Loss Floor</div><div id="k_floor" style="font-weight:800">â€”</div></div>
      <div class="kpi"><div class="small">Remaining to Floor</div><div id="k_rem" style="font-weight:800">â€”</div></div>
    </div>

    <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
      <div style="min-width:320px" class="card">
        <div class="small">Daily Rules</div>
        <div class="row">
          <input id="max_loss_pct" class="input" placeholder="Max loss %" />
          <input id="trail_step_profit" class="input" placeholder="Trail step â‚¹" />
        </div>
        <div class="row" style="margin-top:8px">
          <input id="cooldown_min" class="input" placeholder="Cooldown min" />
          <input id="max_consecutive_losses" class="input" placeholder="Max consecutive losses" />
        </div>
      </div>

      <div style="flex:1;min-width:320px" class="card">
        <div class="small">Actions</div>
        <div class="row" style="margin-top:8px">
          <button class="btn btn-primary" onclick="saveRules()">Save Rules</button>
          <button class="btn btn-ghost" onclick="postAction('/api/admin/kill')">Kill</button>
          <button class="btn btn-ghost" onclick="postAction('/api/admin/unlock')">Unlock</button>
          <button class="btn btn-ghost" onclick="postAction('/api/kite/cancel-all')">Cancel All</button>
          <button class="btn btn-ghost" onclick="postAction('/api/kite/exit-all')">Exit All</button>
        </div>
      </div>
    </div>

    <div class="small" style="margin-top:12px">Notes: Admin token required for actions. Guardian enforces rules on schedule (QStash).</div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
function readToken(){ return localStorage.getItem('ADMIN_TOKEN') || ''; }
function saveToken(){ const v=$('token').value.trim(); if(!v){return alert('Enter token');} localStorage.setItem('ADMIN_TOKEN',v); $('token').value=''; refresh(); }
function clearToken(){ localStorage.removeItem('ADMIN_TOKEN'); refresh(); }
function inr(n){ if(!n && n!==0) return 'â€”'; try{return new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR',maximumFractionDigits:0}).format(n);}catch{return 'â‚¹'+Math.round(n);} }

async function refresh(){
  const headers = readToken() ? { 'Authorization':'Bearer '+readToken() } : {};
  const j = await fetch('/api/state',{headers}).then(r=>r.json()).catch(e=>({ok:false,error:e.message}));
  if(!j.ok){ $('kiteBadge').textContent='Zerodha: â€”'; $('guardBadge').textContent='Guardian: Error'; return; }
  $('now').textContent = 'Time: '+(j.time||'â€”');
  $('kiteBadge').textContent = j.kite_status==='ok' ? 'Zerodha: Connected' : 'Zerodha: Not logged in';
  $('guardBadge').textContent = 'Guardian: Online';
  const s = j.state||{};
  const cap = Number(s.capital_day_915||0);
  const r = Number(s.realised||0);
  const u = Number(s.unrealised||0);
  const ttl = r+u;
  $('k_cap').textContent = inr(cap);
  $('k_live').textContent = inr(s.current_balance || 0);
  $('k_mtm').textContent = inr(u);
  $('k_pnl').textContent = inr(r)+ ' / ' + inr(u) + ' / ' + inr(ttl);
  const maxPct = s.max_loss_pct ?? 10;
  const baseFloor = -(cap * (maxPct/100));
  $('k_floor').textContent = inr(baseFloor);
  $('k_rem').textContent = inr(Math.max(0, baseFloor - ttl));
  ['max_loss_pct','trail_step_profit','cooldown_min','max_consecutive_losses'].forEach(id=>{
    const v = s[id]; if(v!==undefined && v!==null) $(id).value = v;
  });
}

async function saveRules(){
  const t = readToken(); if(!t) return alert('Admin token needed');
  const body = {};
  ['max_loss_pct','trail_step_profit','cooldown_min','max_consecutive_losses'].forEach(id=>{
    const v = $(id).value.trim(); if(v!=='') body[id]=Number(v);
  });
  const r = await fetch('/api/admin/rules-set',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+t},body:JSON.stringify(body)});
  const j = await r.json();
  if(!j.ok) return alert('Save failed: '+(j.error||'unknown'));
  alert('Saved'); refresh();
}

async function postAction(url){
  const t = readToken(); if(!t) return alert('Admin token needed');
  const r = await fetch(url, { method:'POST', headers:{ 'Authorization':'Bearer '+t }});
  const j = await r.json();
  if(!j.ok) return alert('Action failed: '+(j.error||'unknown'));
  alert(j.message || 'OK'); refresh();
}

refresh(); setInterval(refresh, 10000);
</script>
</body>
</html>
