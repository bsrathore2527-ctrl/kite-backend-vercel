<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guardian â€” Admin</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    --bg:#0b0d14; --bg2:#0d111a; --card:#121a2d; --line:#20283a; --fg:#eef3ff; --muted:#98a3b3;
    --accent:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --r:12px; --pad:12px; --gap:12px;
  }
  html,body{height:100%}
  body{
    margin:0;color:var(--fg);font-family: ui-rounded,system-ui,Roboto,Arial,sans-serif;
    background:
      radial-gradient(900px 560px at 12% -10%, rgba(59,130,246,.18), transparent 60%),
      radial-gradient(700px 420px at 95% 8%, rgba(34,197,94,.10), transparent 60%),
      linear-gradient(180deg, var(--bg2) 0%, var(--bg) 100%);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1080px;margin:0 auto;padding:14px}
  .muted{color:var(--muted)} .tiny{font-size:12px}

  .header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .title{font-weight:800;font-size:18px;display:flex;align-items:center;gap:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;border:1px solid var(--line);
    background:linear-gradient(180deg,#141a2b,#0f1524);color:#cfe3ff;font-size:12px}
  .dot{width:8px;height:8px;border-radius:50%}
  .b-ok{border-color:#1d2f24}.b-warn{border-color:#3d2e10}.b-bad{border-color:#3a1616}

  .banner{
    display:grid;grid-template-columns:1fr auto auto auto auto;gap:10px;align-items:center;
    background:linear-gradient(180deg,#131a2d,#0f1525);border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px
  }
  .banner .mode{grid-column:1/-1;font-size:12px;color:#dbe5f2}
  .banner input,.banner button{
    padding:10px;border-radius:10px;border:1px solid var(--line);
    background:linear-gradient(180deg,#0f1523,#0d111a);color:var(--fg)
  }
  .btn{background:linear-gradient(180deg,#1e40af,#19399b);font-weight:700;border-color:#1c3692;cursor:pointer}
  .ghost{background:linear-gradient(180deg,#0f1523,#0d111a)}
  @media (max-width:760px){.banner{grid-template-columns:1fr 1fr 1fr}.banner input{grid-column:1/-1}}

  .grid{display:grid;gap:var(--gap);grid-template-columns:repeat(12,minmax(0,1fr))}
  .card{grid-column:span 12;background:linear-gradient(180deg,#131a2d,#0f1525);border:1px solid var(--line);
    border-radius:12px;padding:var(--pad);box-shadow:0 10px 28px rgba(0,0,0,.28)}
  .card h3{margin:0 0 8px;font-size:13px;font-weight:800}
  @media (min-width:900px){.span-6{grid-column:span 6}}

  .kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  @media (max-width:720px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:380px){.kpis{grid-template-columns:1fr}}
  .kpi{background:linear-gradient(180deg,#111a33,#0e1527);border:1px solid #1a2236;border-radius:10px;padding:8px}
  .kpi .hd{font-size:11px;color:#9aa3ad;margin-bottom:3px}
  .kpi .vl{font-size:16px;font-weight:800}
  .kpi .sub{font-size:11px;color:#9aa3ad;margin-top:2px}

  label{display:block;font-size:11px;color:var(--muted);margin:6px 0 5px}
  input,select,button{width:100%;padding:11px;border-radius:10px;border:1px solid var(--line);
    background:linear-gradient(180deg,#101523,#0d111a);color:var(--fg);outline:none}
  input:focus,select:focus{border-color:#2856b8;box-shadow:0 0 0 3px rgba(59,130,246,.18)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:760px){.row{grid-template-columns:1fr}}

  .pill{display:inline-flex;align-items:center;min-height:30px;padding:7px 10px;border:1px solid var(--line);
    border-radius:10px;background:linear-gradient(180deg,#0f1524,#0e1421);font-size:12px;color:#dbe5f2}

  .actions{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  @media (max-width:760px){.actions{grid-template-columns:1fr 1fr}}
  @media (max-width:520px){.actions{grid-template-columns:1fr}}
  .btn-ok{background:linear-gradient(180deg,#166534,#115c2e);border-color:#0b4d25;color:#fff;font-weight:700}
  .btn-warn{background:linear-gradient(180deg,#7c2d12,#6b2109);border-color:#5c1a07;color:#fff;font-weight:700}
  .btn-ghost{background:linear-gradient(180deg,#101523,#0d111a);color:#fff}

  .disabled *[data-admin-only]{pointer-events:none;opacity:.55;filter:saturate(.75)}
  .footer{margin-top:8px;color:var(--muted);font-size:11px;text-align:right}

  pre { color:#ffdede; background: rgba(0,0,0,0.15); padding:12px; border-radius:8px; max-height:220px; overflow:auto; }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="title">ðŸ›¡ Guardian</div>
    <span id="kite-badge" class="badge"><span class="dot" style="background:#555"></span> Zerodha: â€”</span>
    <span id="engine-badge" class="badge"><span class="dot" style="background:#555"></span> Guardian: â€”</span>
    <div class="muted tiny" id="now" style="margin-left:auto">â€”</div>
  </div>

  <div class="banner">
    <div class="mode" id="modeText"><b>Read-only</b> mode. Enter token to enable changes.</div>

    <!-- masked token field: we never print the token back -->
    <input id="token" type="password" placeholder="ADMIN_TOKEN" autocomplete="off" />
    <button class="btn" id="saveBtn">Save</button>

    <!-- Login now uses POST (via JS) to /api/kite/login so no 405 -->
    <button class="btn" id="loginBtn">Login Zerodha</button>

    <button class="ghost" id="clearBtn">Clear</button>
    <button class="ghost" id="refreshBtn">Refresh</button>
  </div>

  <section class="card" style="padding-top:10px;padding-bottom:10px">
    <div class="kpis">
      <div class="kpi"><div class="hd">Capital @ 09:15</div><div class="vl" id="k_cap">â€”</div><div class="sub">Auto from Zerodha</div></div>
      <div class="kpi"><div class="hd">Current Balance (live/fallback)</div><div class="vl" id="k_live_balance">â€”</div><div class="sub">Uses cached if offline</div></div>
      <div class="kpi"><div class="hd">Live MTM</div><div class="vl" id="k_live_mtm">â€”</div><div class="sub">Sum of position PnL</div></div>

      <div class="kpi"><div class="hd">PnL (R/UR/Total)</div><div class="vl" id="k_pnl">â€”</div><div class="sub" id="k_pnl_sub">â€”</div></div>
      <div class="kpi"><div class="hd">Max Loss (â‚¹)</div><div class="vl" id="k_maxloss_amt">â€”</div><div class="sub" id="k_maxloss_pct">â€”</div></div>
      <div class="kpi"><div class="hd">Active Loss Floor (â‚¹)</div><div class="vl" id="k_active_floor">â€”</div><div class="sub" id="k_next_trail">â€”</div></div>

      <div class="kpi"><div class="hd">Remaining to Max Loss</div><div class="vl" id="k_remaining">â€”</div><div class="sub" id="k_remaining_note">â€”</div></div>
      <div class="kpi"><div class="hd">10% Profit Lock</div><div class="vl" id="k_lock10_amt">â€”</div><div class="sub" id="k_lock10_state">â€”</div></div>
      <div class="kpi"><div class="hd">20% Profit Lock</div><div class="vl" id="k_lock20_amt">â€”</div><div class="sub" id="k_lock20_state">â€”</div></div>

      <div class="kpi"><div class="hd">Trailing Step (â‚¹)</div><div class="vl" id="k_trail_step">â€”</div><div class="sub">Loss floor trails by step</div></div>
    </div>
  </section>

  <div id="content" class="grid disabled" style="margin-top:10px">
    <section class="card span-6">
      <h3>Live State</h3>
      <div class="row">
        <div><label>Capital</label><div id="cap" class="pill">â€”</div></div>
        <div><label>PnL</label><div id="pnl" class="pill">â€”</div></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>Day Status</label><div id="day" class="pill">â€”</div></div>
        <div><label>New Orders</label><div id="block" class="pill">â€”</div></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>Consecutive Losses</label><div id="losses" class="pill">â€”</div></div>
        <div><label>Cooldown Until</label><div id="cool" class="pill">â€”</div></div>
      </div>

      <div class="row" style="margin-top:10px">
        <div><label>Broker Balance (live/fallback)</label><div id="live_funds" class="pill">â€”</div></div>
        <div><label>Live Positions MTM</label><div id="live_mtm" class="pill">â€”</div></div>
      </div>
    </section>

    <section class="card span-6" data-admin-only>
      <h3>Daily Rules</h3>
      <div class="row">
        <div><label>Max Loss %</label><input id="max_loss_pct" type="number" step="0.1" placeholder="10"></div>
        <div><label>Trailing Step (â‚¹)</label><input id="trail_step_profit" type="number" step="100" placeholder="5000"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>Cooldown (min)</label><input id="cooldown_min" type="number" step="1" placeholder="15"></div>
        <div><label>Max Consecutive Losses</label><input id="max_consecutive_losses" type="number" step="1" placeholder="3"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>Allow New After 10%?</label>
          <select id="allow_new_after_lock10"><option value="false">No</option><option value="true">Yes</option></select>
        </div>
        <div><label>Expiry Day?</label>
          <select id="expiry_flag"><option value="false">No</option><option value="true">Yes</option></select>
        </div>
      </div>
    </section>

    <section class="card span-12" data-admin-only>
      <h3>Actions</h3>
      <div class="actions">
        <button class="btn-ok" id="saveRulesBtn">Save Rules</button>
        <button class="btn-warn" id="killBtn">Kill (Block + Trip)</button>
        <button class="btn-ghost" id="unlockBtn">Unlock (Allow New)</button>
        <button class="btn-ghost" id="cancelAllBtn">Cancel All Pending</button>
        <button class="btn-ghost" id="exitAllBtn">Exit All Positions</button>
      </div>
    </section>

    <section class="card span-12" data-admin-only>
      <h3>Last responses & debug</h3>
      <div class="muted">Server returns are shown here; keep this open to confirm actions and generate logs.</div>
      <pre id="raw_responses">â€”</pre>
    </section>
  </div>

  <div class="footer">Guardian UI â€¢ v3.4 â€¢ Auto capital, cached balance fallback, live MTM merges</div>
</div>

<script>
/* --- helpers --- */
const $ = id => document.getElementById(id);
function readToken(){ return localStorage.getItem('ADMIN_TOKEN') || ''; }
function setToken(t){ if(!t) localStorage.removeItem('ADMIN_TOKEN'); else localStorage.setItem('ADMIN_TOKEN', t); }
function authHeader(){ const t = readToken(); return t ? { 'Authorization': 'Bearer ' + t } : {}; }
function safeLog(text){
  const pre = $('raw_responses');
  pre.textContent = (text ? (text + '\n\n') : '') + pre.textContent;
}

/* UI enable/disable */
function setMode(isAdmin){
  const content = $('content');
  const modeText = $('modeText');
  if(isAdmin){ content.classList.remove('disabled'); modeText.innerHTML = '<b>Admin</b> mode enabled.'; }
  else { content.classList.add('disabled'); modeText.innerHTML = '<b>Read-only</b> mode. Enter token to enable changes.'; }
}

/* token save/clear */
$('saveBtn').addEventListener('click', ()=>{
  const v = $('token').value.trim();
  if(!v){ alert('Enter token'); return; }
  setToken(v);
  // do not leave plaintext visible in the input â€” clear and set admin mode
  $('token').value = '';
  setMode(true);
  safeLog('Token saved (masked)');
  fetchState(); // refresh immediately with admin header
});
$('clearBtn').addEventListener('click', ()=>{
  setToken('');
  setMode(false);
  $('token').value = '';
  safeLog('Token cleared');
});

/* refresh button */
$('refreshBtn').addEventListener('click', ()=> fetchState());

/* POST helper that includes Authorization header when token present */
async function post(url, body = null){
  try{
    const headers = { ...(body ? {'Content-Type':'application/json'} : {}), ...authHeader() };
    const opts = { method: 'POST', headers };
    if(body) opts.body = JSON.stringify(body);
    const r = await fetch(url, opts);
    const txt = await r.text();
    // attempt parse
    let j;
    try { j = JSON.parse(txt); }
    catch { j = { ok: false, error: 'invalid json', raw: txt }; }
    safeLog(url + ' => ' + JSON.stringify(j));
    return j;
  }catch(e){
    safeLog(url + ' => ERROR: ' + e.message);
    return { ok:false, error: e.message };
  }
}

/* login zerodha: use POST /api/kite/login to avoid 405 (was previously called with GET) */
$('loginBtn').addEventListener('click', async ()=>{
  safeLog('Zerodha login initiated...');
  // call POST /api/kite/login with Authorization header if token present
  const res = await post('/api/kite/login', {}); // backend should accept POST
  if(res.ok) alert('Zerodha login OK');
  else alert('Zerodha login failed: ' + (res.error || JSON.stringify(res)));
  fetchState();
});

/* action buttons - endpoints from repo: keep same paths as working UI */
$('saveRulesBtn').addEventListener('click', async ()=> {
  const t = readToken(); if(!t){ alert('Enter admin token first'); return; }
  const body = {};
  copyNum('max_loss_pct', body);
  copyNum('trail_step_profit', body);
  copyNum('cooldown_min', body);
  copyNum('max_consecutive_losses', body);
  copyBool('allow_new_after_lock10', body);
  copyBool('expiry_flag', body);
  const res = await post('/api/admin/rules-set', body);
  if(!res.ok) alert('Save failed: ' + (res.error||JSON.stringify(res)));
  else { alert('Rules saved'); fetchState(); }
});

$('killBtn').addEventListener('click', ()=> {
  if(!confirm('Kill (block + trip) â€” are you sure?')) return;
  post('/api/admin/kill');
  setTimeout(fetchState,600);
});
$('unlockBtn').addEventListener('click', ()=> post('/api/admin/unlock').then(()=> setTimeout(fetchState,600)));
$('cancelAllBtn').addEventListener('click', ()=> post('/api/kite/cancel-all').then(()=> setTimeout(fetchState,600)));
$('exitAllBtn').addEventListener('click', ()=> post('/api/kite/exit-all').then(()=> setTimeout(fetchState,600)));

/* copy helpers for saving rules */
function copyNum(id, out){ const el = $(id); if(!el) return; const v = el.value.trim(); if(v==='') return; const n = Number(v); if(!Number.isNaN(n)) out[id] = n; }
function copyBool(id, out){ const el = $(id); if(!el) return; const v = el.value.trim(); if(v==='true') out[id] = true; if(v==='false') out[id]=false; }

/* fetch state & funds & positions (uses admin header when token saved) */
async function fetchState(){
  try{
    const headers = authHeader();
    // state
    const stateRes = await fetch('/api/state?t=' + Date.now(), { headers });
    const j = await stateRes.json();
    if(!j.ok){ safeLog('/api/state => ' + JSON.stringify(j)); alert('State error: ' + (j.error || 'unknown')); return; }
    paint(j);

    // funds (fallback to cached)
    try {
      const fundsRes = await fetch('/api/kite/funds?t=' + Date.now(), { headers });
      const fundsJ = await fundsRes.json();
      if(fundsJ.ok) {
        const av = Number(fundsJ.balance ??
                 fundsJ.funds?.available?.live_balance ??
                 fundsJ.funds?.available?.cash ??
                 fundsJ.funds?.cash ?? 0);
        if(!Number.isNaN(av)) {
          setText('live_funds', formatINR(av));
          setText('k_live_balance', formatINR(av));
        } else {
          setText('live_funds', (j.state && j.state.current_balance) ? formatINR(j.state.current_balance) : 'â€”');
        }
      } else {
        setText('live_funds', (j.state && j.state.current_balance) ? formatINR(j.state.current_balance) : 'â€”');
      }
      safeLog('/api/kite/funds => ' + JSON.stringify(fundsJ));
    } catch(e){
      safeLog('/api/kite/funds => ERROR: ' + e.message);
      setText('live_funds', (j.state && j.state.current_balance) ? formatINR(j.state.current_balance) : 'â€”');
    }

    // positions -> live MTM
    try {
      const posRes = await fetch('/api/kite/positions?t=' + Date.now(), { headers });
      const posJ = await posRes.json();
      if(posJ.ok && posJ.positions?.net) {
        const mtm = posJ.positions.net.reduce((a,p)=> a + Number(p.pnl||0), 0);
        setText('live_mtm', formatINR(mtm));
        setText('k_live_mtm', formatINR(mtm));
        // update derived using live mtm
        renderDerivedUsing(j.state, { unrealised: mtm });
      } else {
        setText('live_mtm', (j.state && typeof j.state.unrealised === 'number') ? formatINR(j.state.unrealised) : 'â€”');
      }
      safeLog('/api/kite/positions => ' + JSON.stringify(posJ));
    } catch(e){
      safeLog('/api/kite/positions => ERROR: ' + e.message);
      setText('live_mtm', (j.state && typeof j.state.unrealised === 'number') ? formatINR(j.state.unrealised) : 'â€”');
    }

  }catch(e){
    safeLog('/api/state => ERROR: ' + e.message);
    console.error(e);
  }
}

/* paint state to UI */
function setText(id, text){ const el = $(id); if(!el) return; el.textContent = text; }
function paint(j){
  setText('now','Time: '+(j.time || new Date().toLocaleTimeString()));
  const kb = $('kite-badge'), eb = $('engine-badge');
  kb.className='badge'; eb.className='badge';
  if(j.kite_status === 'ok'){ kb.innerHTML = '<span class="dot" style="background:#22c55e"></span> Zerodha: Connected'; kb.classList.add('b-ok'); }
  else if(j.kite_status === 'invalid'){ kb.innerHTML = '<span class="dot" style="background:#ef4444"></span> Zerodha: Token invalid'; kb.classList.add('b-bad'); }
  else { kb.innerHTML = '<span class="dot" style="background:#f59e0b"></span> Zerodha: Not logged in'; kb.classList.add('b-warn'); }

  eb.innerHTML = j.ok ? '<span class="dot" style="background:#3b82f6"></span> Guardian: Online' : '<span class="dot" style="background:#ef4444"></span> Guardian: Error';

  if(!j.ok){ safeLog('/api/state returned error: ' + JSON.stringify(j)); return; }

  const s = j.state || {};
  // set rule inputs only if empty so admin values are preserved while editing
  setIfEmpty('max_loss_pct', s.max_loss_pct ?? '');
  setIfEmpty('trail_step_profit', s.trail_step_profit ?? '');
  setIfEmpty('cooldown_min', s.cooldown_min ?? '');
  setIfEmpty('max_consecutive_losses', s.max_consecutive_losses ?? '');
  setIfEmpty('allow_new_after_lock10', String(s.allow_new_after_lock10 ?? 'false'));
  setIfEmpty('expiry_flag', String(s.expiry_flag ?? 'false'));

  setText('day', s.tripped_day ? 'TRIPPED' : 'ACTIVE');
  setText('block', s.block_new_orders ? 'BLOCKED' : 'ALLOWED');
  setText('losses', Number(s.consecutive_losses || 0));
  setText('cool', s.cooldown_until ? new Date(s.cooldown_until).toLocaleTimeString() : 'â€”');

  // derived metrics
  renderDerivedUsing(s);

  // admin enable if server says admin true OR token present locally
  const adminPresent = !!readToken() || !!j.admin;
  setMode(adminPresent);
}

/* derived KPI rendering */
function renderDerivedUsing(state, overrides = {}){
  const s = { ...state, ...overrides };
  const cap = Number(s.capital_day_915 || 0);
  const r = Number(s.realised || 0);
  const u = Number(s.unrealised || 0);
  const ttl = r + u;
  const maxPct = Number(s.max_loss_pct ?? 10);
  const step = Number(s.trail_step_profit ?? 5000);
  const baseFloor = -(cap * (maxPct/100));
  const steps = Math.max(0, Math.floor(Math.max(0, r) / step));
  const trailFloor = -(steps * step);
  const activeFloor = Math.max(baseFloor, trailFloor);
  const remaining = activeFloor - ttl;
  const l10 = cap * 0.10, l20 = cap * 0.20, nextTrail = steps * step + step;

  setText('k_cap', formatINR(cap));
  setText('k_pnl', `${formatINR(r)} / ${formatINR(u)} / ${formatINR(ttl)}`);
  setText('k_pnl_sub', ttl >= 0 ? 'In profit' : 'In loss');
  setText('k_maxloss_amt', formatINR(-baseFloor));
  setText('k_maxloss_pct', `Max Loss %: ${maxPct.toFixed(2)}%`);
  setText('k_active_floor', formatINR(activeFloor));
  setText('k_next_trail', `Next trail at realised â‰¥ ${formatINR(nextTrail)} (step â‚¹${step})`);
  setText('k_remaining', formatINR(Math.max(0, remaining)));
  setText('k_remaining_note', remaining <= 0 ? 'Floor breached' : 'Room left before floor');
  setText('k_trail_step', 'â‚¹' + (step || 0));
  setText('k_lock10_amt', formatINR(l10));
  setText('k_lock20_amt', formatINR(l20));

  setText('cap', (cap).toFixed(2));
  setText('pnl', `${r.toFixed(2)} / ${u.toFixed(2)} / ${ttl.toFixed(2)}`);
}

/* util */
function setIfEmpty(id, val){ const el = $(id); if(!el) return; if(el.value === '' || el.value == null) el.value = String(val); }
function formatINR(n){ if(n==null || isNaN(Number(n))) return 'â€”'; return 'â‚¹' + Number(n).toLocaleString('en-IN',{maximumFractionDigits:0}); }

/* init */
(async function init(){
  // if token exists, keep admin enabled (but input remains editable until saved/cleared)
  if(readToken()) setMode(true);
  await fetchState();
  // periodic refresh
  setInterval(fetchState, 10_000);
})();

</script>
</body>
</html>
