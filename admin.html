<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Admin Panel</title>
<style>.status-green{color:#16a34a;font-weight:600}.status-red{color:#dc2626;font-weight:600}</style>
</head>

<body class="bg-gray-100 min-h-screen p-6">

  <h1 class="text-3xl font-bold mb-6">Admin Panel</h1>

  <!-- MASTER STATUS -->
  <div class="bg-white p-6 rounded-xl shadow-md border mb-6">
    <h2 class="text-xl font-semibold mb-2">Master Zerodha Status</h2>
    <p id="masterStatus" class="text-gray-700">Click button to check.</p>

    <div class="flex gap-3 mt-3">
      <button onclick="checkMasterStatus()"
        class="px-4 py-2 bg-gray-700 text-white rounded-lg">Check Status</button>

      <button onclick="loginMaster()"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg">Login Master Zerodha</button>
    </div>
  </div>

  <!-- ADD USER -->
  <div class="bg-white p-6 rounded-xl shadow-md border mb-6">
    <h2 class="text-xl font-semibold mb-4">Add New User</h2>

    <div class="flex flex-col md:flex-row gap-3">
      <input id="newUserId" placeholder="User ID"
             class="p-3 border rounded-lg flex-1"/>

      <input id="newUserDays" placeholder="Days" type="number"
             class="p-3 border rounded-lg w-32"/>

      <button onclick="addUser()"
        class="px-4 py-2 bg-green-600 text-white rounded-lg">Add User</button>
    </div>
  </div>

  <!-- USER LIST -->
  <div class="bg-white p-6 rounded-xl shadow-md border">
    <div class="flex justify-between mb-3">
      <h2 class="text-xl font-semibold">Users</h2>

      <button onclick="loadUsers()" class="px-4 py-2 bg-gray-700 text-white rounded-lg">
        Refresh Users
      </button>
    </div>

    <table class="w-full border-collapse">
      <thead>
      <tr class="bg-gray-200 text-left">
        <th class="p-2">User ID</th>
        <th class="p-2">Valid Until</th>
        <th class="p-2">Actions</th>
      </tr>
      </thead>

      <tbody id="usersTable">
      <tr><td class="p-3 text-gray-500" colspan="3">Click Refresh</td></tr>
      </tbody>
    </table>
  </div>

<script>
/* ---------------------------------------------
   UTILITY â€” Ask Admin Token
--------------------------------------------- */
async function askToken() {
  const t = prompt("Enter Admin Token:");
  if (!t) return null;
  return t.trim();
}

/* ---------------------------------------------
   MASTER STATUS
--------------------------------------------- */
async function checkMasterStatus() {
    const token = await askAdminToken();
    if (!token) return;
    const res = await fetch("/api/admin/master-status", {
        headers: { "x-admin-token": token }
    });
    const data = await res.json();
    const el = document.getElementById("masterStatus");
    if (data.connected)
        el.innerHTML = "<span class='status-green'>Connected</span>";
    else
        el.innerHTML = "<span class='status-red'>Not Connected</span>";
}});

  const data = await res.json();
  document.getElementById("masterStatus").innerText =
    data.ok ? (data.connected ? "Connected" : "Not Connected")
            : data.error;
}

async function loginMaster() {
  const token = await askToken();
  if (!token) return;

  window.location.href = `/api/admin/master-login?token=${encodeURIComponent(token)}`;
}

/* ---------------------------------------------
   ADD USER
--------------------------------------------- */
async function addUser() {
  const token = await askToken();
  if (!token) return;

  const user_id = document.getElementById("newUserId").value.trim();
  const days = Number(document.getElementById("newUserDays").value.trim());

  if (!user_id || !days) {
    alert("Provide user ID & days");
    return;
  }

  const res = await fetch("/api/admin/addUser", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-token": token
    },
    body: JSON.stringify({ user_id, days })
  });

  const data = await res.json();
  if (!data.ok) {
    alert(data.error || "Failed");
    return;
  }

  alert("User added");
  loadUsers();
}

/* ---------------------------------------------
   LOAD USERS
--------------------------------------------- */
async function loadUsers() {
    const token = await askAdminToken();
    if (!token) return;
    const res = await fetch("/api/admin/listUsers", {
        headers: { "x-admin-token": token }
    });
    const data = await res.json();
    const tbody = document.getElementById("usersTable");
    tbody.innerHTML = "";
    if (!data.ok) {
        tbody.innerHTML = "<tr><td colspan='3' class='text-red-600'>Error</td></tr>";
        return;
    }
    data.users.forEach(u => {
        const color = u.is_connected ? "status-green" : "status-red";
        const txt = u.is_connected ? "Connected" : "Not Connected";
        tbody.innerHTML += `<tr class="border-b">
            <td class="p-2">${u.id}</td>
            <td class="p-2">${new Date(u.valid_until).toLocaleDateString()}</td>
            <td class="p-2"><span class="${color}">${txt}</span></td>
        </tr>`;
    });
}});

  const data = await res.json();

  const tbody = document.getElementById("usersTable");
  tbody.innerHTML = "";

  if (!data.users || data.users.length === 0) {
    tbody.innerHTML = `<tr><td class="p-3 text-center" colspan="3">No Users</td></tr>`;
    return;
  }

  data.users.forEach(u => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td class="p-2">${u.id}</td>
      <td class="p-2">${u.valid_until ? new Date(u.valid_until).toLocaleString() : "-"}</td>

      <td class="p-2 space-x-2">
        <button onclick="extendUser('${u.id}')" class="px-3 py-1 bg-blue-600 text-white rounded">Extend</button>
        <button onclick="resetTrip('${u.id}')" class="px-3 py-1 bg-orange-600 text-white rounded">Reset</button>
        <button onclick="deleteUser('${u.id}')" class="px-3 py-1 bg-red-600 text-white rounded">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------------------------------------------
   EXTEND USER
--------------------------------------------- */
async function extendUser(user_id) {
  const token = await askToken();
  if (!token) return;

  const days = prompt("Extend by days:");
  if (!days) return;

  const res = await fetch("/api/admin/extendValidity", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-token": token
    },
    body: JSON.stringify({ user_id, days })
  });

  const data = await res.json();
  if (!data.ok) return alert(data.error);
  alert("Extended");
  loadUsers();
}

/* ---------------------------------------------
   RESET TRIP
--------------------------------------------- */
async function resetTrip(user_id) {
  const token = await askToken();
  if (!token) return;

  const res = await fetch("/api/admin/resetTrip", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-token": token
    },
    body: JSON.stringify({ user_id })
  });

  const data = await res.json();
  if (!data.ok) return alert(data.error);
  alert("Trip Reset");
}

/* ---------------------------------------------
   DELETE USER
--------------------------------------------- */
async function deleteUser(user_id) {
  const token = await askToken();
  if (!token) return;

  if (!confirm(`Delete ${user_id}?`)) return;

  const res = await fetch("/api/admin/deleteUser", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-token": token
    },
    body: JSON.stringify({ user_id })
  });

  const data = await res.json();
  if (!data.ok) return alert(data.error);

  alert("Deleted");
  loadUsers();
}

</script>
</body>
</html>
