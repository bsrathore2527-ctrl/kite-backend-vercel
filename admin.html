<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Guardian Admin</title>

<style>
/* ---------- THEME VARIABLES ---------- */
:root {
  --orange: #f97316;
  --bg: #ffffff;
  --bg-card: #f8f9fa;
  --text: #1e293b;
  --text-muted: #64748b;
  --border: #e2e8f0;
  --sidebar-bg: #1e293b;
  --sidebar-text: #e2e8f0;
}
:root.dark {
  --bg: #0d1117;
  --bg-card: #161b22;
  --text: #e2e8f0;
  --text-muted: #94a3b8;
  --border: #30363d;
  --sidebar-bg: #0d1117;
  --sidebar-text: #e2e8f0;
}
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: Inter, system-ui, sans-serif;
}

/* ---------- SIDEBAR ---------- */
#sidebar {
  width: 240px;
  background: var(--sidebar-bg);
  color: var(--sidebar-text);
  height: 100vh;
  position: fixed;
  left: 0;
  top: 0;
  padding: 20px;
  display: flex;
  flex-direction: column;
  transition: transform .3s;
}
#sidebar.hide {
  transform: translateX(-240px);
}
.sidebar-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 20px;
}
.sidebar-link {
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  margin-bottom: 10px;
}
.sidebar-link.active {
  background: var(--orange);
  color: #fff;
}

/* ---------- TOP HEADER ---------- */
#topbar {
  margin-left: 240px;
  height: 56px;
  display: flex;
  align-items: center;
  padding: 0 16px;
  border-bottom: 1px solid var(--border);
  justify-content: space-between;
}
#menuBtn {
  display: none;
}

/* ---------- RESPONSIVE ---------- */
@media (max-width: 900px) {
  #sidebar {
    transform: translateX(-240px);
  }
  #sidebar.show {
    transform: translateX(0);
  }
  #topbar {
    margin-left: 0;
  }
  #menuBtn {
    display: inline-block;
    margin-right: 12px;
  }
}

/* ---------- CARDS ---------- */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  padding: 18px;
  border-radius: 12px;
  margin-bottom: 20px;
}
.card-title {
  font-size: 18px;
  margin-bottom: 12px;
  font-weight: 600;
}

/* ---------- TABLE ---------- */
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  border-bottom: 1px solid var(--border);
  padding: 8px;
  font-size: 14px;
}
th {
  background: var(--bg);
  text-align: left;
}
.buy { color: #16a34a; font-weight: 600; }
.sell { color: #dc2626; font-weight: 600; }

/* ---------- BUTTONS ---------- */
.btn {
  padding: 8px 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 600;
}
.btn-orange { background: var(--orange); color: white; }
.btn-red { background: #dc2626; color: white; }
.btn-ghost {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
}

/* ---------- INPUTS ---------- */
input {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text);
  width: 140px;
}
</style>
</head>

<body>
<div id="sidebar">
  <div class="sidebar-title">Guardian Admin</div>
  <div class="sidebar-link active" data-page="dashboard">Dashboard</div>
  <div class="sidebar-link" data-page="risk">Risk Config</div>
  <div class="sidebar-link" data-page="logs">Logs</div>
</div>

<div id="topbar">
  <div style="display:flex;align-items:center;gap:10px;">
    <button id="menuBtn">â˜°</button>
    <div id="kiteStatus">Kite: â€”</div>
    <div id="dayStatus">Day: â€”</div>
  </div>

  <div style="display:flex;align-items:center;gap:10px;">
    <button id="loginZ" class="btn-ghost">Login Zerodha</button>
    <button id="themeToggle" class="btn-ghost">ðŸŒ™</button>
  </div>
</div>

<div style="margin-left:240px;padding:20px;" id="content">
<!-- DASHBOARD PAGE -->
<div id="page-dashboard">

  <!-- LIVE OVERVIEW -->
  <div class="card">
    <div class="card-title">Live Overview</div>
    <div id="liveOverview">Loading...</div>
  </div>

  <!-- TRADEBOOK -->
  <div class="card">
    <div class="card-title" style="display:flex;justify-content:space-between;">
      Tradebook
      <button id="refreshTB" class="btn-ghost">Refresh</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Symbol</th>
          <th>Side</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Trade ID</th>
          <th>Order ID</th>
        </tr>
      </thead>
      <tbody id="tradeRows">
      </tbody>
    </table>
  </div>

  <!-- ACTIONS -->
  <div class="card">
    <div class="card-title">Actions</div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button id="btnKill" class="btn-red">Kill System</button>
      <button id="btnCancel" class="btn-ghost">Cancel All</button>

      <div style="margin-left:auto;display:flex;gap:10px;">
        <button id="btnReset" class="btn-ghost">Reset Day</button>
        <button id="btnAllow" class="btn-ghost">Allow New Orders</button>
      </div>
    </div>
  </div>

</div>
<!-- RISK CONFIG PAGE -->
<div id="page-risk" style="display:none;">

  <div class="card">
    <div class="card-title">Risk Configuration</div>

    <div style="display:flex;flex-wrap:wrap;gap:15px;">
      <div>Max Loss: <input id="cfg_max_loss"></div>
      <div>Max Profit %: <input id="cfg_max_profit_pct"></div>
      <div>Trail Step: <input id="cfg_trail"></div>
      <div>Override Capital: <input id="cfg_override_cap"></div>
      <div>Min Loss To Count: <input id="cfg_min_loss"></div>
      <div style="display:flex;align-items:center;gap:5px;">
        <input type="checkbox" id="cfg_cooldown"> Cooldown on Profit
      </div>
    </div>

    <button id="saveCfg" class="btn-orange" style="margin-top:20px;">Save</button>

  </div>
</div>



<!-- LOGS PAGE -->
<div id="page-logs" style="display:none;">

  <div class="card">
    <div class="card-title" style="display:flex;justify-content:space-between;">
      Logs
      <button id="refreshLogs" class="btn-ghost">Refresh</button>
    </div>

    <pre id="logsBox" style="white-space:pre-wrap;font-size:14px;">Loading...</pre>
  </div>

</div>
<script>
/* -------- SIDEBAR NAVIGATION -------- */
document.querySelectorAll(".sidebar-link").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".sidebar-link").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const page = btn.dataset.page;
    document.querySelectorAll("[id^='page-']").forEach(pg => pg.style.display = "none");
    document.getElementById("page-" + page).style.display = "block";
  };
});

/* -------- SIDEBAR TOGGLE (MOBILE) -------- */
menuBtn.onclick = () => {
  document.getElementById("sidebar").classList.toggle("show");
};

/* -------- THEME TOGGLE -------- */
themeToggle.onclick = () => {
  document.documentElement.classList.toggle("dark");
};

/* -------- DASHBOARD LOADER -------- */
async function loadDashboard() {
  const res = await fetch("/api/dashboard");
  const data = await res.json();

  kiteStatus.textContent = "Kite: " + data.kite_status;
  dayStatus.textContent = "Day: " + (data.state.tripped_day ? "Tripped" : "Active");

  const st = data.state;

  document.getElementById("liveOverview").innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
      <div>
        <div>Capital @ 9:15: <b>${st.capital_day_915 ?? "-"}</b></div>
        <div>Current Balance: <b>${st.current_balance ?? "-"}</b></div>
        <div>LIVE MTM</div>
        <div style="padding-left:12px;">
          Unrealised: <b>${st.unrealised ?? "-"}</b><br>
          Realised: <b>${st.realised ?? "-"}</b><br>
          Total PNL: <b>${st.total_pnl ?? "-"}</b>
        </div>
        <br>
        <div>Max Loss: <b>${st.max_loss_abs ?? "-"}</b></div>
        <div>Max Loss %: <b>${st.max_loss_pct ?? "-"}</b></div>
        <br>
        <div>Max Profit: <b>${st.peak_profit ?? "-"}</b></div>
        <div>Max Profit %: <b>${st.p10_effective_amount ?? "-"}</b></div>
      </div>

      <div>
        <div>Remaining to Max Loss: <b>${st.remaining_to_max_loss ?? "-"}</b></div>
        <div>Active Loss Floor: <b>${st.active_loss_floor ?? "-"}</b></div>
        <div>No. of Trades Executed: <b>â€”</b></div>
        <div>Consecutive Losses: <b>${st.consecutive_losses ?? "-"}</b></div>
        <br>
        <div>Allow New Orders: <b>â€”</b></div>
      </div>
    </div>
  `;
}

/* -------- TRADEBOOK TABLE -------- */
async function loadTradebook() {
  const res = await fetch("/api/tradebook");
  const trades = await res.json();

  trades.sort((a,b)=>b.ts - a.ts);

  tradeRows.innerHTML = trades.map(t => `
    <tr>
      <td>${t.raw.fill_timestamp.replace("T"," ").replace("Z","")}</td>
      <td>${t.tradingsymbol}</td>
      <td class="${t.side.toLowerCase()}">${t.side}</td>
      <td>${t.qty}</td>
      <td>${t.raw.average_price}</td>
      <td>${t.trade_id}</td>
      <td>${t.raw.order_id}</td>
    </tr>
  `).join("");
}

/* -------- ACTION BUTTONS -------- */
btnKill.onclick = ()=> fetch("/api/admin/kill",{method:"POST"});
btnCancel.onclick = ()=> fetch("/api/admin/cancel",{method:"POST"});
btnReset.onclick = ()=> fetch("/api/admin/reset-day",{method:"POST"});
btnAllow.onclick = ()=> alert("Allow New Orders â€” UI only");

/* -------- LOGIN ZERODHA -------- */
loginZ.onclick = async () => {
  const url = await (await fetch("/api/admin/login-zerodha")).text();
  window.open(url,"_blank");
};

/* -------- RISK CONFIG SAVE -------- */
saveCfg.onclick = async () => {
  const body = {
    max_loss_abs: cfg_max_loss.value,
    max_loss_pct: cfg_max_profit_pct.value,
    trail_step: cfg_trail.value,
    admin_override_capital: cfg_override_cap.value,
    min_loss_to_count: cfg_min_loss.value,
    cooldown_on_profit: cfg_cooldown.checked
  };
  await fetch("/api/admin/save-config",{method:"POST",body:JSON.stringify(body)});
  alert("Saved!");
};

/* -------- LOGS (dummy, no backend endpoint yet) -------- */
refreshLogs.onclick = ()=> logsBox.textContent = "No logs endpoint implemented.";

/* -------- INIT -------- */
loadDashboard();
loadTradebook();
setInterval(loadDashboard, 10000);
</script>

</div>
</body>
</html>
