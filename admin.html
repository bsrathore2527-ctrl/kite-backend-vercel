<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guardian — Admin</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1720; --muted:#9aa3b2; --accent:#3b5df0; --danger:#c84a4a;
      color:#e8eef6;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    }
    body{margin:0;background:linear-gradient(180deg,#07111a,#071020 60%);padding:18px;}
    .wrap{max-width:960px;margin:0 auto;}
    .header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .title{font-size:26px;font-weight:700}
    .badge{background:#071425;padding:8px 12px;border-radius:20px;color:var(--muted);font-weight:600}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
          border-radius:14px;padding:18px;margin-top:18px;box-shadow:0 8px 24px rgba(2,6,23,0.6)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input{flex:1;min-width:160px;padding:10px;border-radius:10px;background:transparent;
           border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .btn{background:var(--accent);padding:10px 16px;border-radius:10px;color:#fff;border:none;font-weight:700;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn-danger{background:var(--danger);padding:10px 14px;border-radius:10px;color:#fff;border:none;cursor:pointer}
    .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:14px}
    .stat{background:rgba(255,255,255,0.02);padding:14px;border-radius:10px}
    .muted{color:var(--muted);font-size:13px}
    pre{white-space:pre-wrap;color:#ffbaba;background:#2b2222;padding:10px;border-radius:8px}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">Guardian — Admin</div>
        <div class="small muted">Risk Automation Control</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="kite_status" class="badge">Kite: —</div>
        <div id="guardian_status" class="badge">Guardian: —</div>
        <div id="time" class="badge">—</div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <input id="admin_token" class="input" placeholder="ADMIN_TOKEN" />
        <button id="save_token" class="btn">Save</button>
        <button id="login_zerodha" class="btn-ghost">Login Zerodha</button>
        <button id="clear_token" class="btn-ghost">Clear</button>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="enforce_now" class="btn">Enforce Now</button>
        <button id="kill" class="btn-danger">Kill (Close)</button>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <input id="set_capital" class="input" placeholder="Set Capital (₹) — Admin only" style="max-width:180px" />
          <button id="save_capital" class="btn-ghost">Set</button>
        </div>
      </div>
      <div id="admin_message" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Live Overview</div>
        <button id="refresh" class="btn-ghost">Refresh</button>
      </div>

      <div class="stat-grid">
        <div class="stat">
          <div class="muted">Capital @ 09:15</div>
          <div id="capital_val" style="font-weight:800;font-size:20px">—</div>
        </div>
        <div class="stat">
          <div class="muted">Current Balance</div>
          <div id="live_funds" style="font-weight:800;font-size:20px">—</div>
        </div>
        <div class="stat">
          <div class="muted">PnL (R/UR/T)</div>
          <div id="pnl" style="font-weight:800;font-size:20px">—</div>
        </div>
        <div class="stat">
          <div class="muted">Consecutive Losses</div>
          <div id="consecutive" style="font-weight:800;font-size:20px">0</div>
        </div>
        <div class="stat">
          <div class="muted">Cooldown Until</div>
          <div id="cooldown" style="font-weight:800;font-size:20px">—</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const setText = (id, txt) => { const e=el(id); if(e) e.textContent=txt; };
    const inr = n => n==null ? "—" : "₹"+Number(n).toLocaleString("en-IN",{maximumFractionDigits:2});
    const showMsg = (m,ok=true)=>{const e=el('admin_message');e.innerHTML='<pre>'+m+'</pre>';setTimeout(()=>e.innerHTML='',6000);};
    const postJSON = async (path,body={},hdr={})=>{
      const h={'Content-Type':'application/json',...hdr};
      const r=await fetch(path,{method:'POST',headers:h,body:JSON.stringify(body)});
      const j=await r.json().catch(()=>({ok:false,error:'invalid json'}));
      return {status:r.status,body:j};
    };
    const getAuthHeader=()=>{
      const t=localStorage.getItem('ADMIN_TOKEN')||el('admin_token').value.trim();
      return t? 'Bearer '+t : null;
    };

    async function fetchState(){
      try{
        const r=await fetch('/api/state?t='+Date.now());
        const j=await r.json();
        if(!j.ok) throw new Error(j.error||'state error');
        setText('time',j.time||'—');
        el('kite_status').textContent='Kite: '+(j.kite_status||'—');
        el('guardian_status').textContent='Guardian: '+(j.admin?'admin':'online');
        const s=j.state||{};
        setText('capital_val',inr(s.capital_day_915||0));
        setText('pnl',`${inr(s.realised||0)} / ${inr(s.unrealised||0)} / ${inr((s.realised||0)+(s.unrealised||0))}`);
        setText('consecutive',s.consecutive_losses||0);
        setText('cooldown',s.cooldown_until?new Date(s.cooldown_until).toLocaleTimeString():'—');
      }catch(e){console.error(e);}
    }

    async function fetchFunds(){
      try{
        const r=await fetch('/api/kite/funds',{headers:{Authorization:getAuthHeader()||''}});
        const j=await r.json();
        const av=Number(j?.funds?.available?.live_balance??j?.funds?.net??j?.funds?.available?.cash??j?.balance??0);
        setText('live_funds',inr(av));
      }catch(e){console.error(e);setText('live_funds','—');}
    }

    function saveToken(){const v=el('admin_token').value.trim();if(!v)return;localStorage.setItem('ADMIN_TOKEN',v);showMsg('Token saved');}
    function clearToken(){localStorage.removeItem('ADMIN_TOKEN');el('admin_token').value='';showMsg('Token cleared');}

    async function callAdmin(path,body={}){
      const h=getAuthHeader();if(!h)return showMsg('Admin token missing',false);
      const res=await postJSON(path,body,{Authorization:h});
      showMsg(JSON.stringify(res.body,null,2),res.body.ok);fetchState();fetchFunds();
    }

    document.addEventListener('DOMContentLoaded',()=>{
      el('save_token').onclick=saveToken;
      el('clear_token').onclick=clearToken;
      el('refresh').onclick=()=>{fetchState();fetchFunds();};
      el('enforce_now').onclick=()=>callAdmin('/api/enforce');
      el('kill').onclick=()=>callAdmin('/api/admin/kill');
      el('login_zerodha').onclick=()=>window.open('/api/kite/login','_blank');
      el('save_capital').onclick=()=>{
        const cap=Number(el('set_capital').value||'');
        if(Number.isNaN(cap))return showMsg('Enter valid capital',false);
        callAdmin('/api/admin/set_capital',{capital:cap});
      };
      fetchState();fetchFunds();
      setInterval(fetchState,10000);
    });
  </script>
</body>
</html>
