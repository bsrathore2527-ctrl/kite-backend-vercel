<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>User Dashboard</title>
</head>
<body class="bg-gray-100 min-h-screen p-4">

  <!-- LOGIN SECTION -->
  <div id="loginSection" class="max-w-md mx-auto mt-24 bg-white p-6 rounded-xl shadow">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">Zerodha User Login</h2>
    <label class="block text-sm font-medium mb-1 text-gray-700">Zerodha User ID</label>
    <input id="uidInput" class="w-full p-3 border rounded-lg mb-3"
           placeholder="Enter User ID (e.g., ZD5101)" />
    <p id="loginStatus" class="text-sm mb-3 text-gray-600"></p>
    <button onclick="saveUID()"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-semibold">
      Continue
    </button>
  </div>

  <!-- DASHBOARD SECTION -->
  <div id="dashboardSection" class="hidden max-w-5xl mx-auto mt-6 space-y-4">

    <!-- Top bar -->
    <div class="flex flex-wrap justify-between items-center gap-3">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Risk Dashboard</h1>
        <p id="userIdLabel" class="text-gray-600 text-sm"></p>
      </div>
      <div class="flex flex-col items-end text-sm text-gray-700">
        <div id="validityLabel"></div>
        <div id="lastLoginLabel" class="text-gray-500"></div>
        <button onclick="logoutUser()" class="mt-1 text-red-600 hover:underline text-xs">
          Logout
        </button>
      </div>
    </div>

    <!-- Status badges -->
    <div class="flex flex-wrap gap-2">
      <span id="kiteStatusBadge"
            class="px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-800">
        Kite: —
      </span>
      <span id="tripStatusBadge"
            class="px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-800">
        Status: —
      </span>
    </div>

    <!-- Cards grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

      <!-- Live MTM -->
      <div class="bg-white p-4 rounded-xl shadow">
        <div class="flex justify-between items-center mb-1">
          <h2 class="text-sm font-semibold text-gray-600">Live MTM</h2>
        </div>
        <div id="mtmTotal" class="text-2xl font-bold text-gray-900">—</div>
        <div id="mtmBreakdown" class="text-xs text-gray-600 mt-1">R / UR / Total</div>
      </div>

      <!-- Active loss floor -->
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-sm font-semibold text-gray-600 mb-1">Loss Floor</h2>
        <div id="lossFloor" class="text-lg font-semibold text-gray-900">—</div>
        <div id="remainingLoss" class="text-xs text-gray-600 mt-1">
          Remaining to max loss: —
        </div>
      </div>

      <!-- P10 profit lock -->
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-sm font-semibold text-gray-600 mb-1">Profit Lock (P10)</h2>
        <div id="p10Value" class="text-lg font-semibold text-gray-900">—</div>
        <div id="p10Hint" class="text-xs text-gray-600 mt-1">—</div>
      </div>

      <!-- Consecutive losses / cooldown -->
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-sm font-semibold text-gray-600 mb-1">Consecutive Losses</h2>
        <div id="consecLosses" class="text-2xl font-bold text-gray-900">0</div>
        <div id="cooldownStatus" class="text-xs text-gray-600 mt-1">Cooldown: —</div>
      </div>

      <!-- Capital & max loss -->
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-sm font-semibold text-gray-600 mb-1">Capital & Max Loss</h2>
        <div id="capital915" class="text-lg font-semibold text-gray-900">—</div>
        <div id="maxLossInfo" class="text-xs text-gray-600 mt-1">Max Loss: —</div>
      </div>

      <!-- Last trade time -->
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-sm font-semibold text-gray-600 mb-1">Last Trade</h2>
        <div id="lastTradeTime" class="text-lg font-semibold text-gray-900">—</div>
        <div class="text-xs text-gray-600 mt-1">IST</div>
      </div>
    </div>

    <!-- Positions -->
    <div class="bg-white p-4 rounded-xl shadow">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-sm font-semibold text-gray-700">Open Positions</h2>
        <button onclick="pollPositions()" class="text-xs text-blue-600 hover:underline">
          Refresh
        </button>
      </div>
      <pre id="positionsBox"
           class="text-xs text-gray-800 bg-gray-50 p-2 rounded max-h-60 overflow-auto">Loading…</pre>
    </div>

    <!-- Tradebook -->
    <div class="bg-white p-4 rounded-xl shadow">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-sm font-semibold text-gray-700">Recent Trades</h2>
        <button onclick="pollTradebook()" class="text-xs text-blue-600 hover:underline">
          Refresh
        </button>
      </div>
      <pre id="tradebookBox"
           class="text-xs text-gray-800 bg-gray-50 p-2 rounded max-h-60 overflow-auto">Loading…</pre>
    </div>
  </div>

  <script>
    const ₹ = v => isNaN(Number(v)) ? "—" :
      "₹" + Number(v).toLocaleString("en-IN", { maximumFractionDigits: 0 });

    let uid = localStorage.getItem("user_id") || null;

    function showLogin() {
      document.getElementById("loginSection").classList.remove("hidden");
      document.getElementById("dashboardSection").classList.add("hidden");
      document.getElementById("uidInput").value = uid || "";
    }

    function showDashboard() {
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("dashboardSection").classList.remove("hidden");
    }

    function logoutUser() {
      localStorage.removeItem("user_id");
      uid = null;
      showLogin();
    }

    function saveUID() {
      const v = document.getElementById("uidInput").value.trim().toUpperCase();
      const msg = document.getElementById("loginStatus");
      if (!v) {
        msg.textContent = "Please enter Zerodha User ID.";
        msg.className = "text-sm mb-3 text-red-600";
        return;
      }
      localStorage.setItem("user_id", v);
      uid = v;
      msg.textContent = "Saved. Checking status…";
      msg.className = "text-sm mb-3 text-blue-600";
      checkUser();
    }

    async function checkUser() {
      if (!uid) {
        showLogin();
        return;
      }

      const status = document.getElementById("loginStatus");
      status.textContent = "Checking user registration…";
      status.className = "text-sm mb-3 text-gray-600";

      try {
        const r = await fetch(`/api/user/check?user_id=${encodeURIComponent(uid)}`);
        const d = await r.json();

        if (!d.ok || !d.user) {
          alert("Not authorized user or not registered.");
          localStorage.removeItem("user_id");
          uid = null;
          showLogin();
          return;
        }

        const u = d.user;

        // update basic labels
        document.getElementById("userIdLabel").textContent = `Logged in as: ${u.id}`;
        document.getElementById("validityLabel").textContent =
          "Valid until: " + (u.valid_until ? new Date(u.valid_until).toLocaleString() : "—");
        document.getElementById("lastLoginLabel").textContent =
          "Last login: " + (u.last_login ? new Date(u.last_login).toLocaleString() : "—");

        if (u.expired) {
          status.textContent = "Your subscription has expired.";
          status.className = "text-sm mb-3 text-red-600";
          showLogin();
          return;
        }

        // user registered and not expired
        if (u.connected) {
          status.textContent = "User is connected. Loading dashboard…";
          status.className = "text-sm mb-3 text-green-600";
          showDashboard();
          startPolling();
        } else {
          status.textContent = "User not connected to Zerodha. Redirecting…";
          status.className = "text-sm mb-3 text-orange-600";

          const r2 = await fetch(`/api/user/login-url?user_id=${encodeURIComponent(uid)}`);
          const d2 = await r2.json();

          if (!d2.ok || !d2.login_url) {
            alert(d2.error || "Failed to generate login URL");
            return;
          }

          window.location.href = d2.login_url;
        }
      } catch (err) {
        console.error(err);
        status.textContent = "Error checking user. Try again.";
        status.className = "text-sm mb-3 text-red-600";
      }
    }

    function startPolling() {
      pollState();
      pollPositions();
      pollTradebook();
      setInterval(pollState, 5000);
      setInterval(pollPositions, 10000);
      setInterval(pollTradebook, 15000);
    }

    async function pollState() {
      if (!uid) return;
      try {
        const r = await fetch(`/api/state?user_id=${encodeURIComponent(uid)}`);
        const j = await r.json();
        if (!j.ok) return;

        const s = j.state || {};
        const kiteStatus = j.kite_status || "unknown";

        // kite status badge
        const kiteBadge = document.getElementById("kiteStatusBadge");
        if (kiteStatus === "ok" || kiteStatus === "connected") {
          kiteBadge.textContent = "Kite: Connected";
          kiteBadge.className =
            "px-3 py-1 text-xs rounded-full bg-green-100 text-green-700";
        } else {
          kiteBadge.textContent = "Kite: Disconnected";
          kiteBadge.className =
            "px-3 py-1 text-xs rounded-full bg-red-100 text-red-700";
        }

        // trip status
        const trip = !!s.tripped_day || !!s.tripped;
        const tripBadge = document.getElementById("tripStatusBadge");
        if (trip) {
          tripBadge.textContent = "Status: TRIPPED";
          tripBadge.className =
            "px-3 py-1 text-xs rounded-full bg-red-100 text-red-700 font-semibold";
        } else {
          tripBadge.textContent = "Status: ACTIVE";
          tripBadge.className =
            "px-3 py-1 text-xs rounded-full bg-emerald-100 text-emerald-700 font-semibold";
        }

        // MTM & PNL
        const realised = Number(s.realised ?? 0);
        const unreal = Number(s.unrealised ?? 0);
        const total = realised + unreal;

        document.getElementById("mtmTotal").textContent = ₹(total);
        document.getElementById("mtmBreakdown").textContent =
          `Realised: ${₹(realised)} • Unrealised: ${₹(unreal)} • Total: ${₹(total)}`;

        // capital & max loss
        const capital = Number(s.capital_day_915 ?? 0);
        const maxLossPct = Number(s.max_loss_pct ?? 0);
        const maxLossAbs = Math.round(capital * (maxLossPct / 100));

        document.getElementById("capital915").textContent = capital ? ₹(capital) : "—";
        document.getElementById("maxLossInfo").textContent =
          capital ? `Max loss: ${₹(maxLossAbs)} (${maxLossPct.toFixed(2)}%)` : "Max loss: —";

        // loss floor & remaining
        document.getElementById("lossFloor").textContent =
          ₹(s.active_loss_floor ?? 0);
        document.getElementById("remainingLoss").textContent =
          "Remaining to max loss: " + ₹(s.remaining_to_max_loss ?? 0);

        // P10
        if (typeof s.p10 !== "undefined" && s.p10 !== null) {
          const effAmt = capital ? Math.round(capital * (Number(s.p10) / 100)) : 0;
          document.getElementById("p10Value").textContent = `${s.p10}%`;
          document.getElementById("p10Hint").textContent = effAmt ? `≈ ${₹(effAmt)}` : "—";
        } else if (typeof s.p10_amount !== "undefined") {
          document.getElementById("p10Value").textContent = ₹(s.p10_amount);
          document.getElementById("p10Hint").textContent = "Absolute amount";
        } else {
          document.getElementById("p10Value").textContent = "—";
          document.getElementById("p10Hint").textContent = "—";
        }

        // consecutive losses & cooldown
        const consec = Number(s.consecutive_losses ?? 0);
        document.getElementById("consecLosses").textContent = consec.toString();

        const cooldownActive = !!s.cooldown_active;
        if (cooldownActive) {
          document.getElementById("cooldownStatus").textContent =
            "Cooldown active — trading blocked until timer ends.";
        } else {
          document.getElementById("cooldownStatus").textContent =
            "No cooldown currently active.";
        }

        // last trade time
        if (s.last_trade_time && Number(s.last_trade_time) > 0) {
          const d = new Date(Number(s.last_trade_time));
          document.getElementById("lastTradeTime").textContent =
            d.toLocaleTimeString("en-GB", { hour12: false, timeZone: "Asia/Kolkata" });
        } else {
          document.getElementById("lastTradeTime").textContent = "—";
        }
      } catch (err) {
        console.error("pollState error", err);
      }
    }

    async function pollPositions() {
      if (!uid) return;
      try {
        const r = await fetch(`/api/user/positions?user_id=${encodeURIComponent(uid)}`);
        const d = await r.json();
        document.getElementById("positionsBox").textContent =
          JSON.stringify(d, null, 2);
      } catch (err) {
        console.error("pollPositions error", err);
      }
    }

    async function pollTradebook() {
      if (!uid) return;
      try {
        const r = await fetch(`/api/user/tradebook?user_id=${encodeURIComponent(uid)}`);
        const d = await r.json();
        document.getElementById("tradebookBox").textContent =
          JSON.stringify(d, null, 2);
      } catch (err) {
        console.error("pollTradebook error", err);
      }
    }

    // initial boot
    (function boot() {
      // if returned from login callback with ?login=success etc, keep uid and go straight to checkUser
      const url = new URL(window.location.href);
      const loginStatus = url.searchParams.get("login");
      if (loginStatus === "success") {
        document.getElementById("loginStatus").textContent = "Login successful. Loading…";
        document.getElementById("loginStatus").className = "text-sm mb-3 text-green-600";
      } else if (loginStatus === "failed") {
        document.getElementById("loginStatus").textContent = "Login failed. Please try again.";
        document.getElementById("loginStatus").className = "text-sm mb-3 text-red-600";
      }

      if (!uid) {
        showLogin();
      } else {
        showLogin(); // show but immediately check & potentially switch to dashboard
        checkUser();
      }
    })();
  </script>
</body>
</html>
