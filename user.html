<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>User Dashboard</title>
</head>

<body class="bg-gray-100 min-h-screen p-4">

  <!-- LOGIN SECTION -->
  <div id="loginSection" class="max-w-md mx-auto mt-24 bg-white p-6 rounded-xl shadow">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">Zerodha User Login</h2>

    <label class="block text-sm font-medium mb-1 text-gray-700">Zerodha User ID</label>
    <input id="uidInput" class="w-full p-3 border rounded-lg mb-3"
           placeholder="Enter User ID (e.g., ZD5101)" />

    <p id="loginStatus" class="text-sm mb-3 text-gray-600"></p>

    <button onclick="saveUID()"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-semibold">
      Continue
    </button>
  </div>

  <!-- DASHBOARD SECTION -->
  <div id="dashboardSection" class="hidden max-w-5xl mx-auto mt-6 space-y-4">

    <!-- Top bar -->
    <div class="flex flex-wrap justify-between items-center gap-3">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Risk Dashboard</h1>
        <p id="userIdLabel" class="text-gray-600 text-sm"></p>
      </div>
      <div class="flex flex-col items-end text-sm text-gray-700">
        <div id="validityLabel"></div>
        <div id="lastLoginLabel" class="text-gray-500"></div>
        <button onclick="logoutUser()" class="mt-1 text-red-600 hover:underline text-xs">
          Logout
        </button>
      </div>
    </div>

    <!-- Status badges -->
    <div class="flex flex-wrap gap-2">
      <span id="kiteStatusBadge"
            class="px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-800">
        Kite: -
      </span>

      <span id="tripStatusBadge"
            class="px-3 py-1 text-xs rounded-full bg-gray-200 text-gray-800">
        Status: -
      </span>
    </div>

    <!-- Cards grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

      <!-- Live MTM -->
      <div class="bg-white p-4 rounded-xl shadow">
        <div class="flex justify-between items-center mb-1">
          <h2 class="text-sm font-semibold text-gray-600">Live MTM</h2>
        </div>
        <div id="mtmTotal" class="text-2xl font-bold text-gray-900">-</div>
        <div id="mtmBreakdown" class="text-xs text-gray-600 mt-1">-</div>
      </div>

      <!-- Loss floor -->
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-sm font-semibold text-gray-600 mb-1">Loss Floor</h2>
        <div id="lossFloor" class="text-lg font-semibold text-gray-900">-</div>
        <div id="remainingLoss" class="text-xs text-gray-600 mt-1">-</div>
      </div>

      <!-- Max Profit -->
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-sm font-semibold text-gray-600 mb-1">Max Profit</h2>
        <div id="maxProfitValue" class="text-lg font-semibold text-gray-900">-</div>
        <div id="maxProfitInfo" class="text-xs text-gray-600 mt-1">-</div>
      </div>

      <!-- Consecutive losses -->
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-sm font-semibold text-gray-600 mb-1">Consecutive Losses</h2>
        <div id="consecLosses" class="text-2xl font-bold text-gray-900">0</div>
        <div id="cooldownStatus" class="text-xs text-gray-600 mt-1">-</div>
      </div>

      <!-- Capital & max loss -->
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-sm font-semibold text-gray-600 mb-1">Capital & Max Loss</h2>
        <div id="capital915" class="text-lg font-semibold text-gray-900">-</div>
        <div id="maxLossInfo" class="text-xs text-gray-600 mt-1">-</div>
      </div>

      <!-- Last trade -->
      <div class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-sm font-semibold text-gray-600 mb-1">Last Trade</h2>
        <div id="lastTradeTime" class="text-lg font-semibold text-gray-900">-</div>
        <div class="text-xs text-gray-600 mt-1">IST</div>
      </div>
    </div>

    <!-- Positions -->
    <div class="bg-white p-4 rounded-xl shadow">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-sm font-semibold text-gray-700">Open Positions</h2>
        <button onclick="pollPositions()" class="text-xs text-blue-600 hover:underline">
          Refresh
        </button>
      </div>
      <pre id="positionsBox"
           class="text-xs text-gray-800 bg-gray-50 p-2 rounded max-h-60 overflow-auto">Loading...</pre>
    </div>

    <!-- Tradebook -->
    <div class="bg-white p-4 rounded-xl shadow">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-sm font-semibold text-gray-700">Recent Trades</h2>
        <button onclick="pollTradebook()" class="text-xs text-blue-600 hover:underline">
          Refresh
        </button>
      </div>
      <pre id="tradebookBox"
           class="text-xs text-gray-800 bg-gray-50 p-2 rounded max-h-60 overflow-auto">Loading...</pre>
    </div>

  </div>

  <script>
    /* -----------------------------------------------------
       SAFE CURRENCY FORMATTER
    ----------------------------------------------------- */
    function formatINR(v) {
      if (isNaN(Number(v))) return "-";
      return "₹" + Number(v).toLocaleString("en-IN", { maximumFractionDigits: 0 });
    }

    let uid = localStorage.getItem("user_id") || null;

    function showLogin() {
      document.getElementById("loginSection").classList.remove("hidden");
      document.getElementById("dashboardSection").classList.add("hidden");
      document.getElementById("uidInput").value = uid || "";
    }

    function showDashboard() {
      document.getElementById("loginSection").classList.add("hidden");
      document.getElementById("dashboardSection").classList.remove("hidden");
    }

    function logoutUser() {
      localStorage.removeItem("user_id");
      uid = null;
      showLogin();
    }

    function saveUID() {
      const v = document.getElementById("uidInput").value.trim().toUpperCase();
      const msg = document.getElementById("loginStatus");

      if (!v) {
        msg.textContent = "Please enter Zerodha User ID.";
        msg.className = "text-sm mb-3 text-red-600";
        return;
      }

      localStorage.setItem("user_id", v);
      uid = v;

      msg.textContent = "Checking user...";
      msg.className = "text-sm mb-3 text-blue-600";

      checkUser();
    }

    /* -----------------------------------------------------
       USER VALIDATION
    ----------------------------------------------------- */
    async function checkUser() {
      if (!uid) return showLogin();

      const status = document.getElementById("loginStatus");
      status.textContent = "Checking user registration...";
      status.className = "text-sm mb-3 text-gray-600";

      try {
        const r = await fetch(`/api/user/check?user_id=${encodeURIComponent(uid)}`);
        const d = await r.json();

        if (!d.ok || !d.user) {
          alert("Not authorized user.");
          localStorage.removeItem("user_id");
          uid = null;
          showLogin();
          return;
        }

        const u = d.user;

        document.getElementById("userIdLabel").textContent = "Logged in as: " + u.id;
        document.getElementById("validityLabel").textContent =
          "Valid until: " + (u.valid_until ? new Date(u.valid_until).toLocaleString() : "-");
        document.getElementById("lastLoginLabel").textContent =
          "Last login: " + (u.last_login ? new Date(u.last_login).toLocaleString() : "-");

        if (u.expired) {
          status.textContent = "Your subscription has expired.";
          status.className = "text-sm mb-3 text-red-600";
          showLogin();
          return;
        }

        if (u.connected) {
          status.textContent = "Connected. Loading dashboard...";
          status.className = "text-sm mb-3 text-green-600";
          showDashboard();
          startPolling();
        } else {
          status.textContent = "Redirecting to Zerodha login...";
          status.className = "text-sm mb-3 text-orange-600";

          const r2 = await fetch(`/api/user/login-url?user_id=${encodeURIComponent(uid)}`);
          const d2 = await r2.json();

          if (!d2.ok || !d2.login_url) {
            alert(d2.error || "Failed to generate login URL");
            return;
          }

          window.location.href = d2.login_url;
        }
      } catch (err) {
        console.error(err);
        status.textContent = "Error checking user. Try again.";
        status.className = "text-sm mb-3 text-red-600";
      }
    }

    /* -----------------------------------------------------
       POLLING SETUP
    ----------------------------------------------------- */
    function startPolling() {
      pollState();
      pollPositions();
      pollTradebook();

      setInterval(pollState, 5000);
      setInterval(pollPositions, 10000);
      setInterval(pollTradebook, 15000);
    }

    /* -----------------------------------------------------
       STATE POLL
    ----------------------------------------------------- */
    async function pollState() {
      if (!uid) return;

      try {
        const r = await fetch(`/api/state?user_id=${encodeURIComponent(uid)}`);
        const j = await r.json();

        if (!j.ok) return;

        const s = j.state || {};
        const kiteStatus = j.kite_status || "unknown";

        // KITE STATUS
        const kiteBadge = document.getElementById("kiteStatusBadge");
        if (kiteStatus === "ok" || kiteStatus === "connected") {
          kiteBadge.textContent = "Kite: Connected";
          kiteBadge.className =
            "px-3 py-1 text-xs rounded-full bg-green-100 text-green-700";
        } else {
          kiteBadge.textContent = "Kite: Disconnected";
          kiteBadge.className =
            "px-3 py-1 text-xs rounded-full bg-red-100 text-red-700";
        }

        // TRIP STATUS
        const trip = !!s.tripped || !!s.tripped_day;
        const tripBadge = document.getElementById("tripStatusBadge");

        if (trip) {
          tripBadge.textContent = "Status: TRIPPED";
          tripBadge.className =
            "px-3 py-1 text-xs rounded-full bg-red-100 text-red-700 font-semibold";
        } else {
          tripBadge.textContent = "Status: ACTIVE";
          tripBadge.className =
            "px-3 py-1 text-xs rounded-full bg-emerald-100 text-emerald-700 font-semibold";
        }

        // MTM
        const realised = Number(s.realised ?? 0);
        const unreal = Number(s.unrealised ?? 0);
        const total = realised + unreal;

        document.getElementById("mtmTotal").textContent = formatINR(total);
        document.getElementById("mtmBreakdown").textContent =
          "Realised: " + formatINR(realised) +
          " • Unrealised: " + formatINR(unreal) +
          " • Total: " + formatINR(total);

        // CAPITAL & MAX LOSS
        const capital = Number(s.capital_day_915 ?? 0);
        const maxLossPct = Number(s.max_loss_pct ?? 0);
        const maxLossAbs = capital ? Math.round(capital * (maxLossPct / 100)) : 0;

        document.getElementById("capital915").textContent =
          capital ? formatINR(capital) : "-";

        document.getElementById("maxLossInfo").textContent =
          capital
            ? "Max loss: " + formatINR(maxLossAbs) + " (" + maxLossPct + "%)"
            : "Max loss: -";

        // LOSS FLOOR
        document.getElementById("lossFloor").textContent =
          formatINR(s.active_loss_floor ?? 0);

        document.getElementById("remainingLoss").textContent =
          "Remaining to max loss: " + formatINR(s.remaining_to_max_loss ?? 0);

        // MAX PROFIT %
        const maxProfitPct = Number(s.max_profit_pct ?? 0);
        const maxProfitAbs = capital ? Math.round(capital * (maxProfitPct / 100)) : 0;

        document.getElementById("maxProfitValue").textContent =
          maxProfitPct ? (maxProfitPct + "%") : "-";

        document.getElementById("maxProfitInfo").textContent =
          maxProfitPct
            ? "Max profit: " + formatINR(maxProfitAbs)
            : "Max profit: -";

        // CONSECUTIVE LOSSES
        const consec = Number(s.consecutive_losses ?? 0);
        document.getElementById("consecLosses").textContent = consec.toString();

        // COOLDOWN STATUS
        if (s.cooldown_active) {
          document.getElementById("cooldownStatus").textContent =
            "Cooldown active - trading blocked until timer ends.";
        } else {
          document.getElementById("cooldownStatus").textContent =
            "No cooldown currently active.";
        }

        // LAST TRADE
        if (s.last_trade_time && Number(s.last_trade_time) > 0) {
          const d = new Date(Number(s.last_trade_time));
          document.getElementById("lastTradeTime").textContent =
            d.toLocaleTimeString("en-GB", { hour12: false, timeZone: "Asia/Kolkata" });
        } else {
          document.getElementById("lastTradeTime").textContent = "-";
        }

      } catch (err) {
        console.error("pollState error", err);
      }
    }

    /* -----------------------------------------------------
       POSITIONS
    ----------------------------------------------------- */
    async function pollPositions() {
      if (!uid) return;
      try {
        const r = await fetch(`/api/user/positions?user_id=${encodeURIComponent(uid)}`);
        const d = await r.json();
        document.getElementById("positionsBox").textContent =
          JSON.stringify(d, null, 2);
      } catch (err) {
        console.error("pollPositions error", err);
      }
    }

    /* -----------------------------------------------------
       TRADEBOOK
    ----------------------------------------------------- */
    async function pollTradebook() {
      if (!uid) return;
      try {
        const r = await fetch(`/api/user/tradebook?user_id=${encodeURIComponent(uid)}`);
        const d = await r.json();
        document.getElementById("tradebookBox").textContent =
          JSON.stringify(d, null, 2);
      } catch (err) {
        console.error("pollTradebook error", err);
      }
    }

    /* -----------------------------------------------------
       INITIAL BOOT
    ----------------------------------------------------- */
    (function init() {
      const url = new URL(window.location.href);
      const loginStatus = url.searchParams.get("login");

      if (loginStatus === "success") {
        document.getElementById("loginStatus").textContent =
          "Login successful. Loading...";
        document.getElementById("loginStatus").className =
          "text-sm mb-3 text-green-600";
      } else if (loginStatus === "failed") {
        document.getElementById("loginStatus").textContent =
          "Login failed. Try again.";
        document.getElementById("loginStatus").className =
          "text-sm mb-3 text-red-600";
      }

      if (!uid) {
        showLogin();
      } else {
        showLogin(); 
        checkUser();
      }
    })();
  </script>

</body>
</html>
